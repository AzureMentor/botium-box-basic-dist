!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-cache"),require("zaproxy"),require("botium-core/src/Capabilities"),require("nodegit"),require("botium-core/src/scripting/Constants"),require("natural"),require("mkdirp"),require("rimraf"),require("botium-core/src/scripting/CompilerTxt"),require("botium-core"),require("uuid/v1"),require("child_process"),require("ioredis"),require("better-queue"),require("url"),require("kue"),require("ibm-watson/assistant/v1"),require("passport"),require("passport-local"),require("passport-ldapauth"),require("botium-connector-dialogflow"),require("botium-connector-alexa-smapi"),require("botium-connector-watson"),require("randomatic"),require("bcryptjs"),require("jsonwebtoken"),require("graphql-yoga"),require("graphql-tools"),require("graphql"),require("express-jwt"),require("body-parser"),require("botium-connector-fbpagereceiver/src/proxy"),require("adm-zip"),require("path"),require("fs"),require("request-promise-native"),require("moment"),require("xml"),require("pdfkit"),require("concat-stream"),require("slugify"),require("debug"),require("lodash"),require("util"),require("connect-timeout"),require("dotenv-flow"),require("graphql-redis-subscriptions"),require("prisma-binding"),require("express"),require("connect-history-api-fallback")):"function"==typeof define&&define.amd?define(["node-cache","zaproxy","botium-core/src/Capabilities","nodegit","botium-core/src/scripting/Constants","natural","mkdirp","rimraf","botium-core/src/scripting/CompilerTxt","botium-core","uuid/v1","child_process","ioredis","better-queue","url","kue","ibm-watson/assistant/v1","passport","passport-local","passport-ldapauth","botium-connector-dialogflow","botium-connector-alexa-smapi","botium-connector-watson","randomatic","bcryptjs","jsonwebtoken","graphql-yoga","graphql-tools","graphql","express-jwt","body-parser","botium-connector-fbpagereceiver/src/proxy","adm-zip","path","fs","request-promise-native","moment","xml","pdfkit","concat-stream","slugify","debug","lodash","util","connect-timeout","dotenv-flow","graphql-redis-subscriptions","prisma-binding","express","connect-history-api-fallback"],t):e.main=t(e.nodeCache,e.zaproxy,e.Capabilities,e.nodegit,e.Constants,e.natural,e.mkdirp,e.rimraf,e.CompilerTxt,e.botiumCore,e.v1,e.child_process,e.ioredis,e.betterQueue,e.url,e.kue,e.v1$1,e.passport,e.passportLocal,e.passportLdapauth,e.botiumConnectorDialogflow,e.botiumConnectorAlexaSmapi,e.botiumConnectorWatson,e.randomatic,e.bcryptjs,e.jsonwebtoken,e.graphqlYoga,e.graphqlTools,e.graphql,e.expressJwt,e.bodyParser,e.proxy,e.admZip,e.path,e.fs,e.requestPromiseNative,e.moment,e.xml,e.pdfkit,e.concatStream,e.slugify,e.debug,e.lodash,e.util,e.connectTimeout,e.dotenvFlow,e.graphqlRedisSubscriptions,e.prismaBinding,e.express,e.connectHistoryApiFallback)}(this,function(e,t,s,n,a,r,o,i,c,d,l,u,p,S,h,m,f,T,y,g,b,E,w,C,v,I,O,R,N,x,P,A,_,$,D,M,k,j,B,q,U,L,F,J,G,V,H,Y,z,W){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,r=r&&r.hasOwnProperty("default")?r.default:r,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,c=c&&c.hasOwnProperty("default")?c.default:c,d=d&&d.hasOwnProperty("default")?d.default:d,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u,p=p&&p.hasOwnProperty("default")?p.default:p,S=S&&S.hasOwnProperty("default")?S.default:S,h=h&&h.hasOwnProperty("default")?h.default:h,m=m&&m.hasOwnProperty("default")?m.default:m,f=f&&f.hasOwnProperty("default")?f.default:f,T=T&&T.hasOwnProperty("default")?T.default:T,y=y&&y.hasOwnProperty("default")?y.default:y,g=g&&g.hasOwnProperty("default")?g.default:g,b=b&&b.hasOwnProperty("default")?b.default:b,E=E&&E.hasOwnProperty("default")?E.default:E,w=w&&w.hasOwnProperty("default")?w.default:w,C=C&&C.hasOwnProperty("default")?C.default:C,v=v&&v.hasOwnProperty("default")?v.default:v,I=I&&I.hasOwnProperty("default")?I.default:I,O=O&&O.hasOwnProperty("default")?O.default:O,R=R&&R.hasOwnProperty("default")?R.default:R,N=N&&N.hasOwnProperty("default")?N.default:N,x=x&&x.hasOwnProperty("default")?x.default:x,P=P&&P.hasOwnProperty("default")?P.default:P,A=A&&A.hasOwnProperty("default")?A.default:A,_=_&&_.hasOwnProperty("default")?_.default:_,$=$&&$.hasOwnProperty("default")?$.default:$,D=D&&D.hasOwnProperty("default")?D.default:D,M=M&&M.hasOwnProperty("default")?M.default:M,k=k&&k.hasOwnProperty("default")?k.default:k,j=j&&j.hasOwnProperty("default")?j.default:j,B=B&&B.hasOwnProperty("default")?B.default:B,q=q&&q.hasOwnProperty("default")?q.default:q,U=U&&U.hasOwnProperty("default")?U.default:U,L=L&&L.hasOwnProperty("default")?L.default:L,F=F&&F.hasOwnProperty("default")?F.default:F,J=J&&J.hasOwnProperty("default")?J.default:J,G=G&&G.hasOwnProperty("default")?G.default:G,V=V&&V.hasOwnProperty("default")?V.default:V,H=H&&H.hasOwnProperty("default")?H.default:H,Y=Y&&Y.hasOwnProperty("default")?Y.default:Y,z=z&&z.hasOwnProperty("default")?z.default:z,W=W&&W.hasOwnProperty("default")?W.default:W;const X={buildTarget:"COMMUNITY EDITION",buildBranch:"release/1.7.5",buildRevision:"2aedecaec6ded8bcb689ba8e4db67f7374467ffb",buildDate:"2019-09-06T20:00:03+02:00"};var K=X,Q=()=>{console.log("BOTIUM BOX - SERVER"),console.log(`BUILD_TARGET: ${X.buildTarget}`),console.log(`BUILD_BRANCH: ${X.buildBranch}`),console.log(`BUILD_REVISION: ${X.buildRevision}`),console.log(`BUILD_TIMESTAMP: ${X.buildDate}`),console.log(`PRISMA_ENDPOINT: ${process.env.PRISMA_ENDPOINT}`),console.log(`BOTIUMBOX_QUEUE_REDISURL: ${process.env.BOTIUMBOX_QUEUE_REDISURL}`)};const Z={};Object.assign(Z,{edition:"community"});var ee={isValid:()=>!(!Z.edition||Z.validity&&k().utc().isAfter(k(Z.validty))),isOperable:()=>!(!Z.edition||Z.operability&&k().utc().isAfter(k(Z.operability))),getLicense:()=>Z};const te=L("botium-box-server-cache");var se=class{constructor(t){this.cache=new e({stdTTL:t,checkperiod:.2*t,useClones:!1}),this.loading={}}get(e,t){const s=this.cache.get(e);if(s)return te(`Serving key ${e} from cache`),Promise.resolve(s);if(this.loading[e]){return te(`Load process for key ${e} already running, waiting ...`),new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})})}this.loading[e]=this.loading[e]||{listeners:[]};const n=new Promise((t,s)=>{this.loading[e].listeners.push({resolve:t,reject:s})});return te(`Load process for key ${e} started, waiting ...`),t().then(t=>{te(`Load process for key ${e} ready, notifying listeners ...`),this.cache.set(e,t),this.loading[e].listeners.forEach(({resolve:e})=>e(t)),delete this.loading[e]}).catch(t=>{this.loading[e].listeners.forEach(({reject:e})=>e(t)),delete this.loading[e]}),n}del(e){this.cache.del(e)}delStartWith(e=""){if(!e)return;const t=this.cache.keys();for(const s of t)0===s.indexOf(e)&&this.del(s)}flush(){this.cache.flushAll()}};const ne=L("botium-box-server-utils");var ae={FindFullTestSet:(e,t)=>e.query.testSet({where:{id:t}}," \n{\n  id\n  name\n  client { id }\n  expandConvos\n  expandUtterancesToConvos\n  expandUtterancesIncomprehension\n  excelHasConvos\n  excelHasPartialConvos\n  excelHasUtterances\n  excelWorksheetsConvos\n  excelWorksheetsPartialConvos\n  excelWorksheetsUtterances\n  excelStartRow\n  excelStartCol  \n  selectionType\n  tags\n  scripts { id name script scriptType }\n  repositories { id name giturl gitbranch gitdir gituser gitpassword globFilter }\n  folders { id name path globFilter }\n  excels { id name filename filecontent }\n}"),RetrieveTestSetDetails:e=>({id:e.id,name:e.name,expandConvos:e.expandConvos,expandUtterancesToConvos:e.expandUtterancesToConvos,expandScriptingMemory:e.expandScriptingMemory,excelHasConvos:e.excelHasConvos,excelHasPartialConvos:e.excelHasPartialConvos,excelHasUtterances:e.excelHasUtterances,excelWorksheetsConvos:e.excelWorksheetsConvos,excelWorksheetsPartialConvos:e.excelWorksheetsPartialConvos,excelWorksheetsUtterances:e.excelWorksheetsUtterances,excelStartRow:e.excelStartRow,excelStartCol:e.excelStartCol,convos:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_CONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),pconvos:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_PCONVO"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),utterances:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_UTTERANCES"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),scriptingMemories:e.scripts&&e.scripts.filter(e=>"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType).map(t=>({format:"SCRIPTING_FORMAT_TXT",content:t.script,sourceTag:{testSetId:e.id,testSetScriptId:t.id}})),folders:"SELECTION_TYPE_LOCAL_ONLY"!==e.selectionType&&e.folders&&e.folders.map(t=>({id:t.id,path:t.path,globFilter:t.globFilter,sourceTag:{testSetId:e.id,testSetFolderId:t.id}})),excels:"SELECTION_TYPE_REMOTE_ONLY"!==e.selectionType&&e.excels&&e.excels.map(t=>({id:t.id,filename:t.filename,filecontent:t.filecontent,sourceTag:{testSetId:e.id,testSetExcelId:t.id,filename:t.filename}}))}),ExtractQueueSettings:()=>{let e={};if(process.env.BOTIUMBOX_QUEUE_SETTINGS)try{e=JSON.parse(process.env.BOTIUMBOX_QUEUE_SETTINGS),ne(`Got queue settings '${JSON.stringify(e)}'`)}catch(e){((e,t)=>{e&&console.log(e),t&&console.log(t),process.exit(1)})(`ERROR parsing queue settings "${process.env.BOTIUMBOX_QUEUE_SETTINGS}":`,e)}else process.env.BOTIUMBOX_QUEUE_PREFIX&&(e.prefix=process.env.BOTIUMBOX_QUEUE_PREFIX),process.env.BOTIUMBOX_QUEUE_REDISURL&&(e.redis=process.env.BOTIUMBOX_QUEUE_REDISURL);return e}};function re(e,t){return e(t={exports:{}},t.exports),t.exports}const oe=L("botium-zap-connector"),ie=new t({proxy:process.env.ZAP_ENDPOINT}),ce=async e=>new Promise(t=>setTimeout(t,e)),de=async e=>ie.spider.status(e).then(t=>(oe(`Status of scan: ${e}: ${J.inspect(t)}`),t),t=>{const s=new Error(`Status of ${e} failed: ${t.message}`);throw oe(s),t});var le={basicScan:async e=>ie.spider.scan(e).then(e=>(oe(`Zap scan started: ${J.inspect(e)}`),e),t=>{const s=new Error(`Scan of ${e} failed: ${t.message}`);throw oe(s),t}),getResults:async e=>ie.spider.results(e).then(t=>(oe(`Scan results of scan ${e}: ${J.inspect(t)}`),t),t=>{oe(new Error(`Result of scan: ${e} failed: ${t.message}`))}),getFullResults:async e=>ie.spider.fullResults(e).then(t=>(oe(`Full results of scan: ${e}: ${J.inspect(t)}`),t),t=>{const s=new Error(`Result of ${e} failed: ${t.message}`);throw oe(s),t}),getAlertsByUrl:async e=>ie.core.alerts(e).then(t=>(oe(`Alerts for url: ${e}: ${J.inspect(t)}`),t),e=>{const t=new Error(`Alerts for url failed: ${e.message}`);throw oe(t),e}),getStatus:de,polling:async(e,t)=>{for(;e.progress<100;)e.progress=await de(e.scanId).then(e=>parseInt(e.status)).catch(e=>{throw new Error(`can't get Progress ${J.inspect(e)}`)}),e=await t.db.mutation.updateZapScan({where:{id:e.id},data:{progress:e.progress}}),t.pubsub.publish(`zapScan:${e.id}`,{changeZapScan:e}),await ce(2e3)},createContext:async({testSessionId:e,ctx:t})=>{const s=await ue.findFullTestSession(t.db,e).catch(e=>{throw oe.error(J.inspect(e)),new Error(e)});if("simplerest"===(e=>e.filter(e=>"CONTAINERMODE"===e.name).map(e=>e.stringValue)[0].toLowerCase())(s.chatbot.capabilities)){const t=s.chatbot.capabilities.filter(e=>"SIMPLEREST_URL"===e.name).map(e=>e.stringValue)[0];return oe(`identified simplerest connector, creating ZAP context with url: ${t}`),await ie.context.newContext(e),ie.context.includeInContext(e,t)}return oe("identified unsupported connector, ZAP context not created. no security checks done."),Promise.resolve()},deleteContext:e=>ie.core.deleteSiteNode(e).catch(e=>oe(new Error(e))),deleteAllAlerts:()=>ie.core.deleteAllAlerts().catch(e=>oe(new Error(e)))},ue=re(function(e){const t=L("botium-box-server-agents-utils"),n=e.exports,a=J,{RetrieveTestSetDetails:r}=ae;e.exports.getServerDefaultCapabilities=(e=>({FBPAGERECEIVER_REDISURL:e&&e.queueSettings&&e.queueSettings.redis})),e.exports.getAttachment=((e,t)=>e.query.testSessionTestCaseResultAttachment({where:{id:t}},"{ id name mimeType base64 testSessionTestCaseResult { testSession { client { id } } } }")),e.exports.securityCheck=(async(e,s)=>{if(e.securityCheck){try{await le.createContext({testSessionId:e.id,ctx:s}).catch(e=>{const s=new Error(`Zap is not reachable: ${a.inspect(e)}`);throw t(s),s})}catch(e){return{securityCapabilies:[],zapAvailable:!1}}return process.env.ZAP_ENDPOINT?(t(`securityCheck: Adding ZAP_PROXY capability to security capabilities - ${process.env.ZAP_ENDPOINT}`),{securityCapabilities:[{name:"ZAP_PROXY",type:"STRING",stringValue:process.env.ZAP_ENDPOINT,intValue:null,booleanValue:null,jsonValue:null}],zapAvailable:!0}):(t(new Error("Security test cannot be done. Missing Zap configuration (ZAP_ENDPOINT) not set")),{securityCapabilies:[],zapAvailable:!1})}return{securityCapabilities:[],zapAvailable:!0}}),e.exports.getExcel=((e,t)=>e.query.testSetExcel({where:{id:t}},"{ id filename filecontent testSet { client { id } } }")),e.exports.lookupApiKey=((e,t)=>{const s=new Date(Date.now()).toISOString();if(!t)return;const n={where:{AND:[{key:t},{OR:[{validFrom:null},{validFrom_lte:s}]},{OR:[{validTo:null},{validTo_gte:s}]}]}};return e.query.apiKeys(n,"{ id name clients { id name } permissions }").then(e=>e&&0!==e.length?e[0]:null)}),e.exports.findFullPerformanceTestSession=((e,t)=>e.query.performanceTestSession({where:{id:t}},"{ \n    id \n    client { id name }\n    createdAt\n    name\n    description\n    tags\n    chatbot { \n      id \n      name\n      description \n      tags\n      retryUserSaysNumRetries\n      retryUserSaysFactor\n      retryUserSaysMinTimeout\n      retryUserSaysOnErrorRegexp\n      capabilities { name type stringValue intValue booleanValue jsonValue } \n      sources { name type stringValue intValue booleanValue jsonValue } \n      envs { name type stringValue intValue booleanValue jsonValue } \n    } \n    testSets { \n      id \n      name\n      useMatchingMode\n      expandConvos\n      expandConvosMode\n      expandConvosModeRandomCount\n      expandUtterancesToConvos\n      expandUtterancesIncomprehension\n      useScriptingMemory\n      useScriptingMemoryMatchingMode\n      expandScriptingMemory\n      normalizeText\n    }\n    registeredComponents { id name type default src ref global args }\n    testProject { id name description tags capabilities { name type stringValue intValue booleanValue jsonValue } }\n    results {id stepIndex convo execCount execDurationMin execDurationMax execDurationSum waitCount waitDurationMin waitDurationMax waitDurationSum}\n    jobs {id status err started finished agentName}\n    capabilities { name type stringValue intValue booleanValue jsonValue } \n    sources { name type stringValue intValue booleanValue jsonValue } \n    envs { name type stringValue intValue booleanValue jsonValue }\n    parallelConvoCount\n    parallelJobCount\n    tickRepeatInitial\n    tickRepeatPerTick\n    tickMaxTime\n    tickTime\n    dataDensity     \n    }")),e.exports.findFullTestSession=((e,t)=>e.query.testSession({where:{id:t}},"{ \n    id \n    name\n    client { id name }\n    description\n    createdAt\n    securityCheck\n    tags\n    batchCount\n    bail\n    chatbot { \n      id \n      name\n      description \n      tags\n      retryUserSaysNumRetries\n      retryUserSaysFactor\n      retryUserSaysMinTimeout\n      retryUserSaysOnErrorRegexp\n      capabilities { name type stringValue intValue booleanValue jsonValue } \n      sources { name type stringValue intValue booleanValue jsonValue } \n      envs { name type stringValue intValue booleanValue jsonValue } \n    } \n    testSets { \n      id \n      name\n      useMatchingMode\n      expandConvos\n      expandConvosMode\n      expandConvosModeRandomCount\n      expandUtterancesToConvos\n      expandUtterancesIncomprehension\n      useScriptingMemory\n      useScriptingMemoryMatchingMode\n      expandScriptingMemory\n      normalizeText\n    }\n    deviceSets { id name description tags provider { id name type url username password } devices { id name capabilities } } \n    testProject { id name description tags capabilities { name type stringValue intValue booleanValue jsonValue } }\n    registeredComponents { id name type default src ref global args }\n    agent { id name } \n    capabilities { name type stringValue intValue booleanValue jsonValue } \n    sources { name type stringValue intValue booleanValue jsonValue } \n    envs { name type stringValue intValue booleanValue jsonValue } \n    }")),e.exports.findSimpleTestSessionResults=((e,t)=>e.query.testSession({where:{id:t}},"{ id name status createdAt\n    client { id name }\n    results { \n      id testcaseName createdAt testcaseSource success err duration \n      testSet { id name tags } \n      testSetRepository { id name gitbranch }\n      testSetFolder { id name }\n      testSetExcel { id name }\n      testSetFilename\n    } }")),e.exports.findSimplePerformanceTestSessionResults=((e,t)=>e.query.performanceTestSession({where:{id:t}},"{ id name createdAt\n    client { id name }\n    results {id stepIndex convo execCount execDurationMin execDurationMax execDurationSum waitCount waitDurationMin waitDurationMax waitDurationSum stepStartAt job {id}}\n    jobs {id status err started finished agentName}\n    }")),e.exports.findAgentFromJobData=((e,s,n)=>{if(!s.data.name||!s.data.group){const e=`invalid agent event, name or group not given ${s.data}`;return t(e),Promise.reject(e)}return e.query.agent({where:{name:s.data.name}},n||"{ id name debug capabilities { name type stringValue intValue booleanValue jsonValue } }")}),e.exports.findAgentFromName=((e,t,s)=>e.query.agent({where:{name:t}},s||"{ id name debug capabilities { name type stringValue intValue booleanValue jsonValue } }"));const o=e=>({ref:e.ref,src:e.src,global:e.global,args:e.args&&JSON.parse(e.args)});e.exports.combineRegisteredComponents=((...e)=>{const t={ASSERTERS:[],LOGIC_HOOKS:[],USER_INPUTS:[]},s={ASSERTER:"ASSERTERS",LOGICHOOK:"LOGIC_HOOKS",USERINPUT:"USER_INPUTS"};return e&&e.forEach(e=>{e&&e.forEach(e=>{const n=s[e.type];if(!n)return;const a=t[n].findIndex(t=>t.ref===e.ref);a>=0?t[n][a]=o(e):t[n].push(o(e))})}),t}),e.exports.getChatbotCapabilities=(async(t,s,n)=>{const a=await s.query.chatbot({where:{id:t}},"{ id name retryUserSaysNumRetries retryUserSaysFactor retryUserSaysMinTimeout retryUserSaysOnErrorRegexp capabilities { name type stringValue intValue booleanValue jsonValue } }");return{caps:e.exports.combineBotiumCapabilities(e.exports.getCapabilitiesFromChatbot(a),e.exports.composeBotiumCapabilities(a.capabilities),e.exports.getServerDefaultCapabilities({queueSettings:n})),envs:e.exports.combineBotiumCapabilities(e.exports.composeBotiumCapabilities(a.envs))}}),e.exports.getCapabilitiesFromChatbot=(e=>({RETRY_USERSAYS_ONERROR_REGEXP:e.retryUserSaysOnErrorRegexp,RETRY_USERSAYS_NUMRETRIES:e.retryUserSaysNumRetries,RETRY_USERSAYS_FACTOR:e.retryUserSaysFactor,RETRY_USERSAYS_MINTIMEOUT:e.retryUserSaysMinTimeout})),e.exports.composeBotiumCapabilities=(e=>e&&e.reduce((e,t)=>("STRING"!==t.type&&"TEXT"!==t.type&&"JS"!==t.type||(e[t.name]=t.stringValue?t.stringValue.replace(/\\n/g,"\n"):""),"INT"===t.type&&(e[t.name]=parseInt(t.intValue)),"BOOLEAN"===t.type&&(e[t.name]=!!t.booleanValue),"JSON"===t.type&&(e[t.name]=t.jsonValue),e),{})),e.exports.combineBotiumCapabilities=((...e)=>{const t={};return e&&e.forEach(e=>{e&&Object.keys(e).forEach(s=>{t[s]=e[s]})}),t}),e.exports.extractTestSessionLike=(async(s,a)=>{const o=await s.db.query.registeredComponents({where:{default:!0}}),i=n.combineRegisteredComponents(o,a.registeredComponents),{securityCapabilities:c,zapAvailable:d}=await n.securityCheck(a,s),l=n.combineBotiumCapabilities(i,{PROJECTNAME:a.name},e.exports.getCapabilitiesFromChatbot(a.chatbot),n.composeBotiumCapabilities(a.chatbot.capabilities),n.combineScriptingCapabilities(a.testSets),a.testProject&&n.composeBotiumCapabilities(a.testProject.capabilities)||[],n.composeBotiumCapabilities(a.capabilities),n.composeBotiumCapabilities(c),n.getServerDefaultCapabilities(s));t(`extractTestSessionLike ${a.id} testSessionCaps: ${JSON.stringify(l)}`);const u=n.combineBotiumCapabilities(n.composeBotiumCapabilities(a.chatbot.sources),n.composeBotiumCapabilities(a.sources));t(`extractTestSessionLike ${a.id} testSessionSources: ${JSON.stringify(u)}`);const p=n.combineBotiumCapabilities(n.composeBotiumCapabilities(a.chatbot.envs),n.composeBotiumCapabilities(a.envs));t(`extractTestSessionLike ${a.id} testSessionEnvs: ${JSON.stringify(p)}`);const S=(await e.exports.extractAllInvolvedTestSets(s,a.testSets)).map(e=>r(e));return t(`extractTestSessionLike ${a.id} testSessionTestSets: ${JSON.stringify(S)}`),{testSessionCaps:l,testSessionSources:u,testSessionEnvs:p,testSessionTestSets:S,zapAvailable:d}}),e.exports.extractAllInvolvedTestSets=(async(e,t)=>{const s=[],n=async t=>{if(s.findIndex(e=>e.id===t)>=0)return;const a=await e.db.query.testSet({where:{id:t}},"{ \n        id \n        name\n        description \n        tags\n        useMatchingMode\n        expandConvos\n        expandConvosMode\n        expandConvosModeRandomCount\n        expandUtterancesToConvos\n        expandUtterancesIncomprehension\n        useScriptingMemory\n        useScriptingMemoryMatchingMode\n        expandScriptingMemory\n        normalizeText\n        excelHasConvos\n        excelHasPartialConvos\n        excelHasUtterances\n        excelWorksheetsConvos\n        excelWorksheetsPartialConvos\n        excelWorksheetsUtterances\n        excelStartRow\n        excelStartCol        \n        selectionType\n        scripts { id name script scriptType } \n        repositories { id name giturl gitbranch gitdir gituser gitpassword globFilter } \n        folders { id name path globFilter }\n        excels { id name filename filecontent }\n        dependencies { id }\n      }");if(s.push(a),a.dependencies)for(const e of a.dependencies)await n(e.id)};for(const e of t)await n(e.id);return s});const i={UTTEXPANSION_MODE_ALL:"all",UTTEXPANSION_MODE_FIRST:"first",UTTEXPANSION_MODE_RANDOM:"random"},c={MATCHING_MODE_REGEXP:"regexp",MATCHING_MODE_INCLUDE:"include",MATCHING_MODE_INCLUDELOWERCASE:"includeLowerCase"},d={MATCHING_MODE_NON_WHITESPACE:"non_whitespace",MATCHING_MODE_WORD:"word"};e.exports.combineScriptingCapabilities=(e=>{if(!e)return{};const t={},n=e.filter(e=>e.useMatchingMode).map(e=>e.useMatchingMode);if(F.uniq(n).length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_MATCHING_MODE: ${J.inspect(n)} ...`);n.length>0&&(t[s.SCRIPTING_MATCHING_MODE]=c[n[0]]),t[s.SCRIPTING_NORMALIZE_TEXT]=!!(e.findIndex(e=>e.normalizeText)>=0),t[s.SCRIPTING_ENABLE_MEMORY]=!!(e.findIndex(e=>e.useScriptingMemory)>=0);const a=F.uniq(e.filter(e=>e.useScriptingMemory&&e.useScriptingMemoryMatchingMode).map(e=>e.useScriptingMemoryMatchingMode));if(a.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_MEMORY_MATCHING_MODE: ${J.inspect(a)} ...`);a.length>0&&(t[s.SCRIPTING_MEMORY_MATCHING_MODE]=d[a[0]]);const r=F.uniq(e.filter(e=>e.expandConvos&&e.expandConvosMode).map(e=>e.expandConvosMode));if(r.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_MODE: ${J.inspect(r)} ...`);r.length>0&&(t[s.SCRIPTING_UTTEXPANSION_MODE]=i[r[0]]);const o=F.uniq(e.filter(e=>e.expandConvos&&"UTTEXPANSION_MODE_RANDOM"===e.expandConvosMode&&e.expandConvosModeRandomCount).map(e=>e.expandConvosModeRandomCount));if(o.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_RANDOM_COUNT: ${J.inspect(o)} ...`);o.length>0&&(t[s.SCRIPTING_UTTEXPANSION_RANDOM_COUNT]=o[0]);const l=F.uniq(e.filter(e=>e.expandUtterancesToConvos&&e.expandUtterancesIncomprehension).map(e=>e.expandUtterancesIncomprehension));if(l&&l.length>1)throw new Error(`Test Sets not compatible, found multiple SCRIPTING_UTTEXPANSION_INCOMPREHENSION: ${J.inspect(l)} ...`);return l&&l.length>0&&(t[s.SCRIPTING_UTTEXPANSION_INCOMPREHENSION]=l[0]),t})});ue.getServerDefaultCapabilities,ue.getAttachment,ue.securityCheck,ue.getExcel,ue.lookupApiKey,ue.findFullPerformanceTestSession,ue.findFullTestSession,ue.findSimpleTestSessionResults,ue.findSimplePerformanceTestSessionResults,ue.findAgentFromJobData,ue.findAgentFromName,ue.combineRegisteredComponents,ue.getChatbotCapabilities,ue.getCapabilitiesFromChatbot,ue.composeBotiumCapabilities,ue.combineBotiumCapabilities,ue.extractTestSessionLike,ue.extractAllInvolvedTestSets,ue.combineScriptingCapabilities;const pe=L("botium-retrieve-all-test-cases");var Se=(e,t,n)=>{const{excelHasConvos:r,excelHasPartialConvos:o,excelHasUtterances:i,excelWorksheetsConvos:c,excelWorksheetsPartialConvos:d,excelWorksheetsUtterances:l,excelStartRow:u,excelStartCol:p}=e;r&&c&&(t.caps[s.SCRIPTING_XLSX_SHEETNAMES]=c),o&&d&&(t.caps[s.SCRIPTING_XLSX_SHEETNAMES_PCONVOS]=d),i&&l&&(t.caps[s.SCRIPTING_XLSX_SHEETNAMES_UTTERANCES]=l),isNaN(u)||(t.caps[s.SCRIPTING_XLSX_STARTROW]=u),isNaN(p)||(t.caps[s.SCRIPTING_XLSX_STARTCOL]=p),e.convos&&e.convos.forEach(s=>{let n=[];try{s.format===a.SCRIPTING_FORMAT_TXT&&(n=t.Compile(s.content,a.SCRIPTING_FORMAT_TXT,a.SCRIPTING_TYPE_CONVO)),n&&n.forEach(e=>{e.sourceTag=s.sourceTag})}catch(t){throw pe(t),new Error(`${e.name}: Convo Script compilation failed: ${J.inspect(t)}`)}}),e.pconvos&&e.pconvos.forEach(s=>{let n=[];try{s.format===a.SCRIPTING_FORMAT_TXT&&(n=t.Compile(s.content,a.SCRIPTING_FORMAT_TXT,a.SCRIPTING_TYPE_PCONVO)),n&&n.forEach(e=>{e.sourceTag=s.sourceTag})}catch(t){throw pe(t),new Error(`${e.name}: Partial Convo Script compilation failed: ${J.inspect(t)}`)}}),e.utterances&&e.utterances.forEach(s=>{let n=[];try{s.format===a.SCRIPTING_FORMAT_TXT&&(n=t.Compile(s.content,a.SCRIPTING_FORMAT_TXT,a.SCRIPTING_TYPE_UTTERANCES)),n&&n.forEach(e=>{e.sourceTag=s.sourceTag})}catch(t){throw pe(t),new Error(`${e.name}: Utterance script compilation failed: ${J.inspect(t)}`)}}),e.scriptingMemories&&e.scriptingMemories.forEach(s=>{let n=[];try{s.format===a.SCRIPTING_FORMAT_TXT&&(n=t.Compile(s.content,a.SCRIPTING_FORMAT_TXT,a.SCRIPTING_TYPE_SCRIPTING_MEMORY)),n&&n.forEach(e=>{e.sourceTag=s.sourceTag})}catch(t){throw pe(t),new Error(`${e.name}: Scripting Memory script compilation failed: ${J.inspect(t)}`)}}),e.folders&&e.folders.forEach(s=>{try{const{convos:n,pconvos:a,utterances:r}=t.ReadScriptsFromDirectory(s.path,s.globFilter);n&&n.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)}),a&&a.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)}),r&&r.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,s.sourceTag)})}catch(t){throw pe(t),new Error(`${e.name}: Folder ${s} script compilation failed: ${J.inspect(t)}`)}});let S=Promise.resolve();e.excels&&e.excels.length>0&&(S=Promise.all(e.excels.map(({id:e,filename:s,filecontent:n,sourceTag:c})=>new Promise((d,l)=>{let u=n&&Buffer.from(n,"base64");if(!u){const t=$.join(process.env.RESOURCESDIR,"uploads","excel",`${e}.xlsx`);D.existsSync(t)&&(u=D.readFileSync(t))}if(!u||!u.length)return l(new Error(`Excel file not found in database and in uploads - ${s}`));let p=[],S=[],h=[];r&&(p=t.Compile(u,a.SCRIPTING_FORMAT_XSLX,a.SCRIPTING_TYPE_CONVO)),o&&(S=t.Compile(u,a.SCRIPTING_FORMAT_XSLX,a.SCRIPTING_TYPE_PCONVO)),i&&(h=t.Compile(u,a.SCRIPTING_FORMAT_XSLX,a.SCRIPTING_TYPE_UTTERANCES)),p&&p.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),S&&S.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),h&&h.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),d()}))));let h=Promise.resolve();return Promise.all([h,S])};const he=new r.RegexpTokenizer({pattern:/([A-zÀ-ÿ-$]+|[0-9._]+|.|!|\?|'|"|:|;|,|-)/i}),me=e=>he.tokenize(e),fe=e=>me(e).filter(e=>!ye(e));const Te=(e,t,s)=>[e.substr(0,t),s,e.substr(t+1)].join("");const ye=e=>e&&e.length>1&&e.startsWith("$");var ge={tokenize:fe,evaluateProbability:e=>Math.random()<e,getLongestToken:e=>{const t=fe(e).sort((e,t)=>t.length-e.length);return t.length?t[0]:""},replaceCharAtCaseSensitive:(e,t,s)=>{const n=(e=>e===e.toLocaleLowerCase())(e.charAt(t))?s.toLocaleLowerCase():s.toLocaleUpperCase();return Te(e,t,n)},replaceCharAt:Te,insertAt:(e,t,s)=>[e.substr(0,t),s,e.substr(t)].join(""),replaceWith:(e,t,s)=>{const n=e.indexOf(t);return[e.substr(0,n),s,e.substr(n+t.length)].join("")},reverse:e=>{return e.split("").reverse().join("")},keymap:{1:["2","q"],2:["1","q","w","3"],3:["2","w","e","4"],4:["3","e","r","5"],5:["4","r","t","6"],6:["5","t","y","z","7"],7:["6","y","z","u","8"],8:["7","u","i","9"],9:["8","i","o","0"],0:["9","o","p"],q:["1","2","w","a"],w:["q","a","s","e","3","2"],e:["w","s","d","r","4","3"],r:["e","d","f","t","5","4"],t:["r","f","g","y","z","6","5"],y:["t","g","h","u","7","6","x","s","a"],u:["y","z","h","j","i","8","7"],i:["u","j","k","o","9","8"],o:["i","k","l","p","0","9"],p:["o","l","0"],a:["y","z","s","w","q"],s:["a","y","z","x","d","e","w"],d:["s","x","c","f","r","e"],f:["d","c","v","g","t","r"],g:["f","v","b","h","y","z","t"],h:["g","b","n","j","u","y","z"],j:["h","n","m","k","i","u"],k:["j","m","l","o","i"],l:["k","p","o"],z:["x","s","a","t","g","h","u","7","6"],x:["y","z","c","d","s"],c:["x","v","f","d"],v:["c","b","g","f"],b:["v","n","h","g"],n:["b","m","j","h"],m:["n","k","j"],"ö":["l","p","ü","ä","-","."],"ä":["-","ö","ü","+","#"],"ü":["p","ö","ä","+","´","ß"],"ß":["ü","p","0"]},normalizeNumberOfResult:(e,t=3)=>{if(e.length<=t)return e;const s=[],n=(e.length-t)/t/2;for(let a=0;a<t;a++)s.push(e[Math.round(n+a*(e.length/t))]);return s},isModifiableWord:(e,t)=>{const s=((e,t)=>{const s=me(e).sort((e,t)=>t.length-e.length);for(let n=0;n<s.length;n++){const a=s[n];let r=0;do{if((r=e.indexOf(a,r))>=0){if(r<=t&&t<r+a.length)return a;r++}}while(r>=0)}return null})(e,t);return!!s&&!ye(s)}};const{normalizeNumberOfResult:be,isModifiableWord:Ee}=ge;var we={execute:e=>{let t=[""];const s=e.toLocaleLowerCase();for(let n=0;n<e.length;n++){const a=e.charAt(n)!==s.charAt(n)&&Ee(e,n);a&&(t=t.concat(t));for(let r=0;r<t.length;r++){const o=a&&r<t.length/2;t[r]=t[r].concat(o?s.charAt(n):e.charAt(n))}}return t=t.slice(1),be(t)},metadata:{id:"Case sensitivity"}};const{normalizeNumberOfResult:Ce}=ge;var ve={execute:e=>{const t=e.split(/(?<! ) (?! )/);let s=[t[0]];for(let e=1;e<t.length;e++){s=s.concat(s);for(let n=0;n<s.length;n++)s[n]=s[n]+(n<s.length/2?" ":"  "),s[n]=s[n]+t[e]}return s=s.slice(1),Ce(s)},metadata:{id:"Duplicate space"}},Ie={execute:e=>[e+" :)"],metadata:{id:"Emojis"}};const{normalizeNumberOfResult:Oe}=ge;var Re=[we,ve,Ie,{execute:e=>{let t=[""];const s=e.replace(/(.) /g,"$1\n");for(let n=0;n<e.length;n++){e.charAt(n)!==s.charAt(n)&&(t=t.concat(t));for(let a=0;a<t.length;a++)t[a]=t[a].concat(a<t.length/2?e.charAt(n):s.charAt(n))}return t=t.slice(1),Oe(t)},metadata:{id:"Enter instead of space"}},{execute:e=>[e.replace(" ,"," ").replace(", "," ").replace(","," ")],metadata:{id:"Missing punctuation mark"}}];const{getLongestToken:Ne,insertAt:xe,replaceWith:Pe}=ge;const Ae=e=>{const t=[];let s=e;return[2,e.length-2].forEach(n=>{t.push(xe(e,n,e[n])),s=xe(s,n,s[n])}),t.push(s),t};var _e={execute:e=>{const t=[],s=Ne(e);return s.length<5?t:(Ae(s).forEach(n=>{t.push(Pe(e,s,n))}),t)},metadata:{id:"Double character"}};const{getLongestToken:$e,replaceWith:De,reverse:Me}=ge;const ke=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,3),r=De(e,s,Me(s));t.has(r)||(t.add(r),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var je={execute:e=>{const t=[],s=$e(e);return s.length<7?t:(ke(s).forEach(n=>{t.push(De(e,s,n))}),t)},metadata:{id:"Duplicate space"}};const{tokenize:Be,replaceWith:qe}=ge,Ue=["Aale, Ahle","Ai, Ei","Annalen, analen","aß, Aas","Bad, bat","bald, ballt","Bällen, bellen","Band, bannt","Beete, bete","bis, Biss","Block, Blog","Boot, bot","Boote, Bote","Bug, buk","Bund, bunt","Chor, Korps","Code, Kot","das, dass","dehnen, denen","erhält, erhellt","Fähre, faire","Fälle, Felle","fällt, Feld","Färse, Ferse, Verse","fast, fasst","fetter, Vetter","fiel, viel","fließt, fliehst, fliest","frisst, Frist","Fühler, Phyla","Geld, gellt","Gewand, gewandt","Grad, Grat","Graf, Graph","Halt, hallt","hallte, halte","hält, Held, hellt","Hämmer, Hemmer","hängst, Hengst","harrt, hart","hasst, hast","Häute, heute","Heer, hehr, her","Hemd, hemmt","hohl, hol","Hund, Hunt","isst, ist","kannte, Kante","konnten, Konten","Kuh, Coup","küsste, Küste","Laib, Leib","Laie, Leihe","laichen, Leichen","lasst, Last","läuten, Leuten","Lärche, Lerche","Leere, Lehre","leeren, lehren","Leerstelle, Lehrstelle","Leid, leiht","Lid, Lied","lies, ließ","liest, least","Mahl, Mal","Mähre, Märe, Meere","mahlen, malen","man, Mann","Märkte, merkte","Meer, mehr","Miene, Mine","misst, Mist","Mohr, Moor","mühten, Mythen","Mund, Munt","Nachnahme, Nachname","nahmen, Namen","packt, Pakt","pisste, Piste","rächen, Rechen","rächt, Recht","Rad, Rat","Rain, rein","Rede, Reede","Reis, reiß","reist, reißt","ruhte, Rute, Route","säen, sähen","Sämann, Seemann","Sätzen, setzen","Saite, Seite","seid, seit","schafft, Schaft","schallten, schalten","Schänke, schenke","schellte, Schelte","Schlächter, schlechter","Schlämme, schlemme","Schwälle, Schwelle","Schwämme, Schwemme","Seen, sehen","seid, seiht, seit","sie, sieh","Siegel, Sigel","Sohle, Sole","Sold, sollt","späht, spät","Stadt, statt","Städte, Stätte","Ställe, Stelle","starrt, Start","stehlen, Stelen","stiehl, Stiel, Stil","Tod, tot","Trend, trennt","Uhrzeit, Urzeit","Verband, verbannt","Verben, werben","verließ, Verlies","verwaist, verweist","Villen, Willen","Waage, vage","Waagen, wagen","Wahl, Wal","wahr, war","wahre, Ware","Waise, Weise","Wald, wallt","Wälle, Welle","Wände, Wende","Weck, weg","Wehr, wer","wehrt, Wert","weiht, weit","weis, weiß","weist, weißt","wieder, wider","wird, Wirt","Zunahme, Zuname","accept,except","acclamation,acclimation","acts,ax,axe","adolescence,adolescents","aeration,erration","aerie,airy","affect,effect","aid,aide","ail,ale","air,heir,err,ere","aisle,isle,I'll","all,awl","allowed,aloud","allude,elude","altar,alter","appose,oppose","arc,ark","are,our","ascent,assent","ate,eight","away,aweigh","aye,I,eye","bade,bayed","bail,bale","bait,bate","bald,bawled,balled","ball,bawl","band,banned","bard,barred","bare,bear","baron,barren","base,bass","based,baste","bazaar,bizarre","be,bee","beach,beech","bean,been","beat,beet","been,bin","beer,bier","bell,belle","berry,bury","berth,birth","better,bettor","bight,bite","billed,build","bird,burred","blew,blue","boar,bore,boor","board,bored","boarder,border","bode,bowed","bold,bowled","bolder,boulder,bowlder","bole,bowl","boos,booze","bough,bow","boy,buoy","braid,brayed","braise,braze,brays,braize","brake,break","breach,breech","bread,bred","brewed,brood","brews,bruise","bridal,bridle","burro,burrow","bus,buss","bused,bust","but,butt","buy,bye,by","cache,cash","callous,callus","can't,cant","cannon,canon","canter,cantor","carat,carrot,caret","caries,carries","cast,caste","cede,seed","cell,sell","cellar,seller","censor,sensor","cent,sent,scent","cents,sense,scents","cereal,serial","cession,session","chaise,chase","chalk,chock","chance,chants","chased,chaste","cheap,cheep","chews,choose","chic,sheik","choir,quire","chord,cored,cord","chute,shoot","cite,site,sight","clause,claws","click,clique","close,clothes","coal,cole","coaled,cold","coarse,course","coated,coded","cocks,cox","complement,compliment","contingence,contingents","coo,coup","coop,coupe","correspondence,correspondents","cosign,cosine","council,counsel","councilor,counselor","creak,creek","crewed,crude","crews,cruise","cue,queue","currant,current","curser,cursor","dam,damn","Dane,deign","days,daze","dear,deer","dense,dents","dependence,dependents","dew,due,do","die,dye","dire,dyer","discreet,discrete","doe,dough","does,doze,doughs","done,dun","dual,duel","ducked,duct","earn,urn","either,ether","emigrant,immigrant","eutopia,utopia","ewe,you,yew","eyed,I'd","fain,feign","faint,feint","fair,fare","fairy,ferry","fate,fete","faze,phase","feat,feet","feudal,futile","find,fined","finish,Finnish","fir,fur","flair,flare","flea,flee","flecks,flex","flew,flue","flour,flower","foaled,fold","for,four,fore","forego,forgo","foreword,forward","forth,fourth","foul,fowl","frees,frieze,freeze","friar,fryer","gage,gauge","gait,gate","gel,jell","gene,jean","gild,guild","gneiss,nice","gored,gourd","grade,grayed,greyed","grate,great","grays,greys,graze","grisly,grizzly","groan,grown","guessed,guest","guide,guyed","guise,guys","hail,hale","hair,hare","hairy,harry","hall,haul","halve,have","hangar,hanger","hay,hey","hays,haze","he'd,heed","he'll,heel,heal","hear,here","heard,herd","heated,heeded","hew,hue","hi,high","higher,hire","him,hymn","ho,hoe","hoar,whore","hoard,horde","hoarse,horse","hoes,hose","hold,holed","hole,whole","holey,wholly,holy","hostel,hostile","hour,our","idle,idol","immanent,imminent","in,inn","incidence,incidents","incite,insight","instance,instants","intense,intents","intension,intention","it's,its","jam,jamb","knave,nave","knead,need,kneed","knew,new","knight,night","knit,nit","knot,not,naught","know,no","knows,nose","lacks,lax","lade,laid","lain,lane","lair,layer","lam,lamb","laps,lapse","lay,lei","lays,laze","leach,leech","lead,led","leak,leek","lean,lien","leased,least","lends,lens","lessen,lesson","lesser,lessor","let's,lets","levee,levy","liar,lyre","lichen,liken","lickerish,licorice","lie,lye","links,lynx","lo,low","load,lode","loan,lone","loch,lock","locks,lox","loop,loupe","loos,lose","lose,loose","made,maid","mail,male","main,mane","maize,maze,Mays","mall,maul","manner,manor","marshal,martial","massed,mast","mat,matte","mean,mien","meat,mete,meet","medal,mettle,meddle,metal","might,mite","mince,mints","mind,mined","miner,minor","missed,mist","moat,mote","mood,mooed","moor,more","morning,mourning","muscle,mussel","mussed,must","naval,navel","nay,neigh","nicks,nix","none,nun","oar,ore,or","ode,owed","oh,owe","once,wants","one,won","oohs,ooze","overseas,oversees","paced,paste","packed,pact","pail,pale","pain,pane","pair,pear,pare","palate,pallet,palette","parish,perish","passed,past","patience,patients","pause,paws","peace,piece","peak,pique,peek","peal,peel","pearl,purl","pedal,petal,peddle","peer,pier","penance,pennants","per,purr","pi,pie","plain,plane","plainer,planer,planar","plait,plate","pleas,please","pole,poll","poor,pour,pore","populace,populous","praise,preys,prays","pray,prey","precedence,precedents","premier,premiere","presence,presents","pride,pried","prier,prior","pries,prize","prince,prints","principal,principle","profit,prophet","rack,wrack","raid,rayed","rail,rale","rain,rein,reign","raise,raze,rays","rap,wrap","rapt,wrapped,wrapt","re-cover,recover","re-lay,relay","read,red","read,reed","real,reel","recede,reseed","reek,wreak","residence,residents","rest,wrest","retch,wretch","rhyme,rime","right,write,rite,wright","ring,wring","ringer,wringer","rise,ryes","road,rowed,rode","roe,row","roil,royal","role,roll","roomer,rumor,rumour","root,route","rose,rows","rote,wrote","rude,rued","rues,ruse","rung,wrung","rye,wry","sail,sale","scene,seen","sea,see","seam,seem","sear,seer","seas,seize,sees","sects,sex","sew,sow,so","shake,sheik","shear,sheer","shoe,shoo","sic,sick","sics,six","side,sighed","sighs,size","sign,sine","slay,sleigh","sleight,slight","slew,slough","soar,sore","soared,sword","sold,soled","sole,soul","some,sum","son,sun","stair,stare","stake,steak","steal,steel","step,steppe","storey,story","straight,strait","suite,sweet","tacked,tact","tacks,tax","tail,tale","taper,tapir","tarry,terry","taught,taut","tea,tee","team,teem","tears,tiers","teas,tees,tease","tense,tents","than,then","there,they're,their","threw,through","throne,thrown","thyme,time","tide,tied","tier,tire","tighten,titan","to,two,too","toad,towed,toed","toe,tow","told,tolled","tracked,tract","tray,trey","udder,utter","vain,vein,vane","vale,veil","vial,vile","vice,vise","wade,weighed","wail,whale","waist,waste","wait,weight","waive,wave","waiver,waver","wale,whale","war,wore","ward,warred","ware,where,wear","warn,worn","wax,whacks","way,whey,weigh","we,wee","we'd,weed","we'll,wheel,weal,wheal","we're,weir,were","we're,whir","we've,weave","weak,week","wearer,where're","weather,whether","wet,whet","wheeled,wield","which,witch","while,wile","whiled,wild","whine,wine","whined,wined,wind","whirled,world","whit,wit","whither,wither","who's,whose","whoa,woe","wood,would","yack,yak","yaw,your,yore,you're","yoke,yolk","yore,your,you're","you'll,Yule","aahed,odd","adieu,ado","ant,aunt","aural,oral","marry,merry","rout,route","seated,seeded","shone,shown","tidal,title","trader,traitor","vary and very"];let Le;const Fe=()=>{if(Le)return Le;const e=Ue.map(function(e){return e.toLocaleLowerCase().trim().split(",")});return Le=[],e.forEach(function(e){e.forEach(function(t){Le[t]=e.filter(e=>e!==t)})}),Le},Je=e=>{const t=Fe();if((e=e.toLocaleLowerCase())in t)return t[e][0]};var Ge={execute:e=>{const t=Be(e);let s=e;return t.forEach(e=>{const t=Je(e);t&&(s=qe(s,e,t))}),s!==e?[s]:[]},metadata:{id:"Homophones"}};const{getLongestToken:Ve,replaceCharAtCaseSensitive:He,replaceWith:Ye,keymap:ze}=ge;const We=e=>{const t=[];return[2,e.length-2].forEach(s=>{const n=e[s].toLocaleLowerCase();if(n in ze){const a=ze[n];[a[0],a[a.length-1]].forEach(n=>{t.push(He(e,s,n))})}}),t};var Xe={execute:e=>{const t=[],s=Ve(e);return s.length<5?t:(We(s).forEach(n=>{t.push(Ye(e,s,n))}),t)},metadata:{id:"Mishit"}};const{getLongestToken:Ke,replaceCharAtCaseSensitive:Qe,replaceWith:Ze}=ge;const et=e=>{const t=[];return[2,e.length-2].forEach(s=>{t.push(Qe(e,s,""))}),t};var tt={execute:e=>{const t=[],s=Ke(e);return s.length<5?t:(et(s).forEach(n=>{t.push(Ze(e,s,n))}),t)},metadata:{id:"Missing character"}};const{getLongestToken:st,replaceWith:nt,reverse:at}=ge;const rt=e=>{const t=new Set([e]);return[2,e.length-2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,2),r=nt(e,s,at(s));t.has(r)||(t.add(r),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var ot={execute:e=>{const t=[],s=st(e);return s.length<5?t:(rt(s).forEach(n=>{t.push(nt(e,s,n))}),t)},metadata:{id:"Mixing character"}};const{replaceCharAt:it}=ge,ct={z:"y",Z:"Y",y:"z",Y:"Z"};var dt={execute:e=>{let t=e;for(let e=0;e<t.length;e++){const s=t.charAt(e);s in ct&&(t=it(t,e,ct[s]))}return t===e?[]:[t]},metadata:{id:"qwertz vs qwerty keyboard"}};const{getLongestToken:lt,replaceCharAtCaseSensitive:ut,replaceWith:pt,keymap:St}=ge;const ht=e=>{const t=[],s=Math.round(e.length/2),n=e[s].toLocaleLowerCase();if(n in St){const a=St[n];[a[0],a[a.length-1]].forEach(n=>{t.push(ut(e,s,e[s]+n))})}return t};var mt={execute:e=>{const t=[],s=lt(e);return s.length<5?t:(ht(s).forEach(n=>{t.push(pt(e,s,n))}),t)},metadata:{id:"Sausage fingers"}};const{getLongestToken:ft,replaceWith:Tt}=ge;const yt=e=>{const t=new Set([e]);return[1,2].forEach(s=>{let n=s,a=!1;do{const s=e.substr(n,3).split("");let r=Array.from(s);r.push(r[0]),r.shift();const o=Tt(e,s.join(""),r.join(""));t.has(o)||(t.add(o),a=!0),++n>=e.length-2&&(a=!0)}while(!a)}),t.delete(e),t};var gt=[_e,je,Ge,Xe,tt,ot,dt,mt,{execute:e=>{const t=[],s=ft(e);return s.length<7?t:(yt(s).forEach(n=>{t.push(Tt(e,s,n))}),t)},metadata:{id:"Shift characters"}}];const bt=Re.concat(gt),Et={};bt.forEach(e=>{Et[e.metadata.id]=e});const wt={};Re.forEach(e=>{wt[e.metadata.id]="habits"}),gt.forEach(e=>{wt[e.metadata.id]="typo"});var Ct={GetMutatorById:e=>{if(!(e in wt))throw Error(`Unknown ID: ${e}`);return Et[e]},allMutatorNames:Object.keys(Et),pipelineAllMutatorCombined:[[Re,gt],[Re],[gt]],pipelineAllMutatorNotCombined:[[Re],[gt]]};const{pipelineAllMutatorCombined:vt,pipelineAllMutatorNotCombined:It,GetMutatorById:Ot,allMutatorNames:Rt}=Ct;const Nt=(e,t)=>{let s=new Set;for(const n of t){let t=[e];for(const e of n){let s=[];for(const n of e)for(const e of t)s=s.concat(n.execute(e));t=s}for(const e of t)s.has(e)?console.log("duplicate utterance : <"+e+"> created by "+JSON.stringify(n,2)):s.add(e)}return[...s]};const xt=e=>{if(!e.humanifiersToExecute||!e.humanifiersToExecute.length)return[[It]];return[[(e=>e.map(e=>Ot(e)))(e.humanifiersToExecute)]]};var Pt={pipelineAllMutatorCombined:vt,pipelineAllMutatorNotCombined:It,allHumanifiers:Rt,Execute:(e,t)=>{const s=xt(t);return Nt(e,s)},ExecutePipeline:Nt};const At=L("botium-box-clone-testset"),{BotDriver:_t,Capabilities:$t}=d,{RetrieveTestSetDetails:Dt}=ae,{combineScriptingCapabilities:Mt}=ue;const kt=(e,t)=>{const s={all:e.utterances,me:new Set,bot:new Set,both:null,neither:null,toHumanify:{},allUtteranceCount:0,utterancesToHumanifyCount:0};s.neither=new Set(Object.keys(s.all)),e.convos.forEach(e=>{e.conversation.forEach(e=>{e.messageText&&e.messageText in s.all&&(s[e.sender].add(e.messageText),s.neither.delete(e.messageText))})});const n=F.uniq(Array.from(s.me)).filter(e=>s.bot.has(e));s.both=new Set(n);const a={};let r=0,o=0;return t.humanifiersToExecute&&t.humanifiersToExecute.length&&[...s.me,...n,...s.neither].forEach(e=>{o+=s.all[e].utterances.length;let n=Math.round(o*t.percentToHumanify-r);0===r&&0===n&&(n=1),a[e]=n,r+=n}),s.toHumanify=a,s.allUtteranceCount=o,s.utterancesToHumanifyCount=r,s},jt=(e,t,s)=>{t.both.forEach(s=>{if(t.toHumanify[s]){let t=s+"_JUST_BOT";if(t in e.utterances)throw new Error(`There is already an utterance ${t} in the testset!`)}});const n={humanifiedRefs:[],humanifiedRefCount:0,humanifiedUtterancesCount:0,duplicates:0};t.both.forEach(s=>{t.toHumanify[s]&&(e.utterances[s+"_JUST_BOT"]=F.cloneDeep(e.utterances[s]))});Object.keys(t.toHumanify).forEach(a=>{if(t.toHumanify[a]){const r=(n=>{e.utterances[n].utterances=F.uniq(e.utterances[n].utterances);const a=t.toHumanify[n],r=e.utterances[n].utterances;let o=0;for(let t=0;t<a;t++){const a=Pt.Execute(r[t],{humanifiersToExecute:s.humanifiersToExecute});e.utterances[n].utterances=e.utterances[n].utterances.concat(a),o+=a.length}let i=e.utterances[n].utterances.length;return e.utterances[n].utterances=F.uniq(e.utterances[n].utterances),{humanifiedRefCount:a,humanifiedUtterancesCount:o,duplicates:i-e.utterances[n].length}})(a);n.humanifiedRefs.push(a),n.humanifiedRefCount+=r.humanifiedRefCount,n.humanifiedUtterancesCount+=r.humanifiedUtterancesCount,n.duplicates+=r.duplicates}});const a=[];return e.convos.forEach(e=>{((e,t)=>(e.conversation.forEach(e=>{if(e.messageText&&t.both.has(e.messageText))return!0}),!1))(e,t)}),e.convos=e.convos.concat(a),n.clonedConvoCount=a.length,n};var Bt={possibleOptions:{humanifiers:Pt.allHumanifiers},CloneTestset:async(e,t)=>{const s=Mt([e]),n=new _t(s).BuildCompiler(),a=$.join(process.env.BOTIUM_TEMPDIR,`${U(e.name)}_CLONED_${C("Aa0",5)}`);o.sync(a),await Se(Dt(e),n),i(a,e=>{e&&At(`Failed rimraf ${a}: ${e}`)});const r={},c=kt(n,t);return r.utterances={all:Object.keys(c.all).length,me:c.me.size,bot:c.bot.size,both:c.both.size,neither:c.neither.size,toHumanify:Object.values(c.toHumanify).filter(e=>e).length,allUtteranceCount:c.allUtteranceCount,utterancesToHumanifyCount:c.utterancesToHumanifyCount},r.process=jt(n,c,t),At(`Cloning finished: ${JSON.stringify(r)}`),n},ExportTestsetToFolder:async(e,t)=>{const s=$.join(process.env.TESTSETDIR,`${U(t)}_${C("Aa0",5)}`);o.sync(s);const n=e.caps[$t.SCRIPTING_TXT_EOL],r=Object.keys(e.utterances);for(let t=0;t<r.length;t++){let a=[r[t]].concat(e.utterances[r[t]].utterances).join(n);D.writeFileSync($.join(s,`${r[t]}.utterances.txt`),a)}const i=e.GetCompiler(a.SCRIPTING_FORMAT_TXT);return e.convos&&e.convos.forEach((e,t)=>{let n=i.Decompile([e]);D.writeFileSync($.join(s,`c${t}_${U(e.header.name)}.convo.txt`),n)}),e.partialConvos&&Object.values(e.partialConvos).forEach((e,t)=>{let n=i.Decompile([e]);D.writeFileSync($.join(s,`p_${U(e.header.name)}.pconvo.txt`),n)}),s},ExportTestsetToLocalRepository:async e=>{const t=[],s=e.caps[$t.SCRIPTING_TXT_EOL],n=Object.keys(e.utterances);for(let a=0;a<n.length;a++){let r=[n[a]].concat(e.utterances[n[a]].utterances).join(s);t.push({name:n[a],script:r,scriptType:"SCRIPTING_TYPE_UTTERANCES"})}const r=e.GetCompiler(a.SCRIPTING_FORMAT_TXT);return e.convos&&e.convos.forEach((e,s)=>{let n=r.Decompile([e]);t.push({name:e.header.name,description:e.header.description,script:n,scriptType:"SCRIPTING_TYPE_CONVO"})}),e.partialConvos&&Object.values(e.partialConvos).forEach((e,s)=>{let n=r.Decompile([e]);t.push({name:e.header.name,description:e.header.description,script:n,scriptType:"SCRIPTING_TYPE_PCONVO"})}),t}},qt={testsets:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.testSets({where:t,orderBy:s,skip:n,first:a},o).then(e=>(e&&e.forEach(e=>{e.repositories&&e.repositories.forEach(e=>{delete e.gitpassword})}),e))),testset:(e,{id:t},s,n)=>s.db.query.testSet({where:{id:t}},n).then(e=>(e.repositories&&e.repositories.forEach(e=>{delete e.gitpassword}),e)),testsetscripts:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetScripts({where:{testSet:{id:t}},skip:s,first:n},r),testsetscript:(e,{id:t},s,n)=>s.db.query.testSetScript({where:{id:t}},n),validatetestsetscript(e,{script:t,scriptType:s}){const n=new c({AddConvos:()=>{},AddPartialConvos:()=>{},AddUtterances:()=>{},AddScriptingMemories:()=>{},IsAsserterValid:()=>!0,IsLogicHookValid:()=>!0,IsUserInputValid:()=>!0,GetPartialConvos:()=>[],scriptingEvents:{}},{SCRIPTING_TXT_EOL:"\n"}).Compile(t,s);return n&&n.length>0?"SCRIPTING_TYPE_UTTERANCES"===s?Promise.resolve({name:n[0].name,description:"Utterances",script:t,scriptType:s}):"SCRIPTING_TYPE_SCRIPTING_MEMORY"===s?Promise.resolve({name:"Scripting Memory",description:`Test Cases: ${n.map(e=>e.header.name).join("/")}`,script:t,scriptType:s}):Promise.resolve({name:n[0].header.name,description:n[0].header.description,script:t,scriptType:s}):Promise.reject(new Error("no script provided"))},testsetrepositories:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetRepositories({where:{testSet:{id:t}},skip:s,first:n},r).then(e=>(e&&e.forEach(e=>{delete e.gitpassword}),e)),testsetrepository:(e,{id:t},s,n)=>s.db.query.testSetRepository({where:{id:t}},n).then(e=>(e&&delete e.password,e)),testsetfolders:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetFolders({where:{testSet:{id:t}},skip:s,first:n},r),testsetfolder:(e,{id:t},s,n)=>s.db.query.testSetFolder({where:{id:t}},n),testsetexcels:(e,{testSetId:t,skip:s,first:n},a,r)=>a.db.query.testSetExcels({where:{testSet:{id:t}},skip:s,first:n},r),testsetexcel:(e,{id:t},s,n)=>s.db.query.testSetExcel({where:{id:t}},n),clonetestsetoptions:(e,t,s,n)=>Bt.possibleOptions};const{BotDriver:Ut}=d,{FindFullTestSet:Lt,RetrieveTestSetDetails:Ft}=ae,Jt=L("botium-box-mutate-testset");var Gt={createTestSet:async(e,{testSet:t},s,n)=>s.db.mutation.createTestSet({data:t},n),async updateTestSet(e,{id:t,testSet:s},n,a){if(!await n.db.exists.TestSet({id:t}))throw new Error(`TestSet not found ${t}`);return n.db.mutation.updateTestSet({where:{id:t},data:s},a)},deleteTestSet:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSet({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),createTestSetScript:async(e,{testSetScript:t},s,n)=>s.db.mutation.createTestSetScript({data:t},n),async updateTestSetScript(e,{id:t,testSetScript:s},n,a){if(!await n.db.exists.TestSetScript({id:t}))throw new Error(`TestSetScript not found ${t}`);return n.db.mutation.updateTestSetScript({where:{id:t},data:s},a)},deleteTestSetScript:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetScript({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),async createTestSetRepository(e,{testSetRepository:t},s,n){},async updateTestSetRepository(e,{id:t,testSetRepository:s},n,a){},async deleteTestSetRepository(e,{id:t},s){},createTestSetFolder:async(e,{testSetFolder:t},s,n)=>s.db.mutation.createTestSetFolder({data:t},n),async updateTestSetFolder(e,{id:t,testSetFolder:s},n,a){if(!await n.db.exists.TestSetFolder({id:t}))throw new Error(`TestSetFolder not found ${t}`);return n.db.mutation.updateTestSetFolder({where:{id:t},data:s},a)},deleteTestSetFolder:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetFolder({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>n(e))}),async createTestSetExcel(e,{testSetExcel:t},s,n){if(t.filecontent){const a=$.join(process.env.RESOURCESDIR,"uploads","excel");o.sync(a);const r=Buffer.from(t.filecontent,"base64");delete t.filecontent;const{id:i}=await s.db.mutation.createTestSetExcel({data:t},"{ id }");return D.writeFileSync($.join(a,`${i}.xlsx`),r),qt.testsetexcel(e,{id:i},s,n)}return s.db.mutation.createTestSetExcel({data:t},n)},async updateTestSetExcel(e,{id:t,testSetExcel:s},n,a){if(!await n.db.exists.TestSetExcel({id:t}))throw new Error(`TestSetExcel not found ${t}`);if(s.filecontent){const e=$.join(process.env.RESOURCESDIR,"uploads","excel");o.sync(e);const n=Buffer.from(s.filecontent,"base64");D.writeFileSync($.join(e,`${t}.xlsx`),n),s.filecontent=null}return n.db.mutation.updateTestSetExcel({where:{id:t},data:s},a)},deleteTestSetExcel:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestSetExcel({where:{id:t}},"{id}").then(()=>{const e=$.join(process.env.RESOURCESDIR,"uploads","excel");o.sync(e);const s=$.join(e,`${t}.xlsx`);D.existsSync(s)&&D.unlinkSync(s)}).then(()=>{e(!0)}).catch(e=>n(e))}),async cloneTestSet(e,{id:t,options:s},n,a){const r=await Lt(n.db,t);if(!r)throw new Error(`TestSet not found ${t}`);const o=await Bt.CloneTestset(r,s),i=[`Cloned from "${r.name}"`];s.humanifiersToExecute&&s.humanifiersToExecute.length>0&&(i.push(`Humanifiers "${s.humanifiersToExecute.join(", ")}"`),i.push(`Percentage ${100*s.percentToHumanify}%`));const c={data:{...r,name:s.name,client:r.client&&{connect:{id:r.client.id}}||null,description:i.join(", "),tags:{set:r.tags?[...r.tags,"Cloned"]:["Cloned"]},folders:{},repositories:{},scripts:[],excels:{}}};if("FOLDER"===s.output){const e=await Bt.ExportTestsetToFolder(o,s.name);c.data.folders.create=[{name:"Test Set Scripts",path:$.resolve(e)}]}else if("LOCAL"===s.output){const e=await Bt.ExportTestsetToLocalRepository(o);c.data.scripts.create=e}return delete c.data.id,n.db.mutation.createTestSet(c,a)},exportTestSetToGit:async(e,{id:t,options:s},n,a)=>!0,async exportTestSetToFolder(e,{id:t,options:s},n,a){const r=await Lt(n.db,t);if(!r)throw new Error(`TestSet not found ${t}`);const i=r.folders&&r.folders.find(e=>e.id===s.id);if(!i)throw new Error(`Folder ${s.id} not found in Test Set ${t}`);let c=i.path;s.subdirectory&&(c=$.join(c,s.subdirectory));try{o.sync(c),Jt(`Created output directory ${c}`)}catch(e){throw new Error(`Failed to create output directory ${c}: ${e}`)}const d=(e,t)=>{try{D.writeFileSync($.join(c,e),t),Jt(`Wrote file ${e} to output directory ${c}`)}catch(t){throw new Error(`Failed to write file ${e} to output directory ${c}: ${t}`)}};return r.scripts&&r.scripts.forEach(e=>{"SCRIPTING_TYPE_CONVO"===e.scriptType&&d(`${U(e.name)}.convo.txt`,e.script),"SCRIPTING_TYPE_PCONVO"===e.scriptType&&d(`${U(e.name)}.pconvo.txt`,e.script),"SCRIPTING_TYPE_UTTERANCES"===e.scriptType&&d(`${U(e.name)}.utterances.txt`,e.script),"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType&&d(`${U(e.name)}.scriptingmemory.txt`,e.script)}),r.excels&&r.excels.forEach(e=>{const t=Buffer.from(e.filecontent,"base64");d(`${U(e.name)}.xlsx`,t)}),!0},async importTestSetFromZip(e,{id:t,options:s},n,a){let r;try{r=new _(Buffer.from(s.filecontent,"base64"))}catch(e){throw Error("Cant open ZIP file")}const o=new c({AddConvos:()=>{},AddPartialConvos:()=>{},AddUtterances:()=>{},AddScriptingMemories:()=>{},IsAsserterValid:()=>!0,IsLogicHookValid:()=>!0,IsUserInputValid:()=>!0,GetPartialConvos:()=>[],scriptingEvents:{}},{SCRIPTING_TXT_EOL:"\n"}),i=[];r.getEntries().forEach(e=>{let s;if(e.isDirectory)return;if(e.entryName.endsWith(".utterances.txt"))s="SCRIPTING_TYPE_UTTERANCES";else if(e.entryName.endsWith(".convo.txt"))s="SCRIPTING_TYPE_CONVO";else if(e.entryName.endsWith(".pconvo.txt"))s="SCRIPTING_TYPE_PCONVO";else{if(!e.entryName.endsWith(".scriptingmemory.txt"))throw Error(`Incorrect file name ${e.entryName}`);s="SCRIPTING_TYPE_SCRIPTING_MEMORY"}const n=e.getData().toString("utf8"),a=o.Compile(n,s);let r,c;"SCRIPTING_TYPE_UTTERANCES"===s?(r=a[0].name,c="Utterances"):"SCRIPTING_TYPE_SCRIPTING_MEMORY"===s?(r="Scripting Memory",c=`Test Cases: ${a.map(e=>e.header.name).join("/")}`):(r=a[0].header.name,c=a[0].header.description),i.push({name:r,description:c,script:n,scriptType:s,testSet:{connect:{id:t}}})}),s.overwrite&&await n.db.mutation.deleteManyTestSetScripts({where:{testSet:{id:t}}});for(const e of i)await n.db.mutation.createTestSetScript({data:e});return!0},async updateTestSetStats(e,{id:t},s,n){const a=await Lt(s.db,t);if(!a)throw new Error(`TestSet not found ${t}`);const r=(new Ut).BuildCompiler(),c=$.join(process.env.BOTIUM_TEMPDIR,`${U(a.name)}_STATS_${C("Aa0",5)}`);o.sync(c);const d=Ft(a);try{await Se(d,r);const e=r.convos&&r.convos.map(e=>({name:e.header.name,order:e.header.order,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],a=r.partialConvos&&Object.values(r.partialConvos).map(e=>({name:e.header.name,description:e.header.description,sourceTag:JSON.stringify(e.sourceTag),stepCount:e.conversation&&e.conversation.length||0}))||[],o=e.length,l=a.length,u=Object.keys(r.utterances).reduce((e,t)=>e+r.utterances[t].utterances.length,0),p=r.scriptingMemories.length,S=await s.db.query.testSet({where:{id:t}},"{ statsCompiledConvos { id } }");return await s.db.mutation.updateTestSet({where:{id:t},data:{statsUpdatedAt:new Date,statsConvoCount:o||0,statsPartialConvoCount:l||0,statsUtterancesCount:u||0,statsScriptingMemoryCount:p||0,statsCompiledConvos:{create:e.concat(a),deleteMany:{id_in:S.statsCompiledConvos&&S.statsCompiledConvos.map(e=>e.id)||[]}}}},n)}finally{i(c,e=>{e&&Jt(`Failed rimraf ${c}: ${e}`)})}}};const{updateTestSetStats:Vt}=Gt,Ht=L("botium-box-testset-scanner"),Yt=(e,t)=>process.env.TESTSETDIR_PUBLIC?$.resolve(process.env.TESTSETDIR_PUBLIC,t):$.resolve(e,t),zt=(e,t)=>D.readdirSync(e).reduce((s,n)=>{const a=$.join(e,n);return t(a)&&s.push(n),s},[]),Wt=async(e,t,s)=>{const n=$.join(t,s);Ht(`scanDirForTestSets scanning ${n} ...`);const a=(e=>zt(e,e=>D.statSync(e).isDirectory()))(n),r=(e=>zt(e,e=>D.statSync(e).isFile()))(n);if(a&&a.length>0)await a.forEach(async n=>{const a=Yt(t,$.join(s,n));await(async(e,t)=>{let s=await e.query.testSetFolders({where:{path:t}},"{ id name testSet { id name } }");return s&&0!==s.length||(s=await e.query.testSetFolders({where:{path:t+$.sep}},"{ id name testSet { id name } }")),!!(s&&s.length>0)&&(Ht(`Folder ${t} already in use - ${s[0].name} in Test Set ${s[0].testSet.name}`),!0)})(e,a)||await Wt(e,t,$.join(s,n))});else if(r&&r.length>0){const a={data:{name:s.split($.sep).join("/"),description:`Imported from directory ${n}, ${r.length} files`,expandConvos:!0,expandUtterancesToConvos:!0,expandScriptingMemory:!1,tags:{set:s.split($.sep)},folders:{create:[{name:s,path:Yt(t,s)}]}}};try{const t=await e.mutation.createTestSet(a,"{ id }");Ht(`scanDirForTestSets ${s} Imported Test Set ${t.id} with ${r.length} files`),await Vt(void 0,{id:t.id},{db:e}),Ht(`scanDirForTestSets ${s} Updated Test Set Stats ${t.id}`)}catch(e){Ht(`scanDirForTestSets ${s} Failed to create ${a.data}: ${e}`)}}};var Xt=e=>{(async()=>{Wt(e,process.env.TESTSETDIR,".")})().catch(e=>{Ht(`scanForTestSets failed: ${e}`)})};const Kt=u.fork,Qt=L("botium-box-server-livechat"),Zt=L("botium-box-server-livechat-worker"),es=d.BotDriver,ts=d.Capabilities,ss=process.env.BOTIUMBOX_LIVECHAT_IDLE_TIMEOUT||3e5,ns={},as={},rs=(e,t,s)=>{e.send({type:t,message:s})},os=({conversationId:e,queueSettings:t,pubsub:s})=>{as[e]&&clearTimeout(as[e]),as[e]=setTimeout(async()=>{const n=new p(t.redis);Qt(`Auto cleanup of conversation ${e} after ${ss}ms idle time`),is(e),await n.del(e),s.publish(e,{liveChatConvoStepAdded:{err:`Automatically closed chatbot connection after ${ss}ms idle time`}})},ss)},is=async e=>{as[e]&&clearTimeout(as[e]),delete as[e];const t=ns[e];t&&rs(t,ls.STOP_CONVERSATION)},cs=async({conversationId:e},{queueSettings:t})=>{const s=new p(t.redis),n=await s.get(e);return n&&JSON.parse(n)},ds=async(e,t,s)=>{await s.set(e,JSON.stringify(t)),await s.expire(e,ss/1e3);const n=await s.ttl(e);Qt(`updateConversation(${e}) TTL(seconds): ${n}`)},ls={USER_SAYS:"USER_SAYS",USER_SAYS_FAILED:"USER_SAYS_FAILED",STOP_CONVERSATION:"STOP_CONVERSATION",STOP_CONVERSATION_FINISHED:"STOP_CONVERSATION_FINISHED",MESSAGE_SENTTOBOT:"MESSAGE_SENTTOBOT",MESSAGE_RECEIVEDFROMBOT:"MESSAGE_RECEIVEDFROMBOT",LOG:"LOG"};var us={startListeners:async({db:e,pubsub:t,queueSettings:s})=>new Promise((e,t)=>{const n=new p(s.redis);n.on("error",()=>{Qt("Redis connection failed, retry")}),n.subscribe("livechat.send","livechat.stop",(s,n)=>{s?t(new Error(`Redis subscribe failed: ${s}`)):(Qt(`Livechat Redis connected to ${n} channels.`),e())}),n.on("message",async(e,t)=>{const{conversationId:s,convoStep:n}=JSON.parse(t);if(!ns[s])return;const a=ns[s];"livechat.send"===e?(Qt(`liveChatSendToBot(${s}) sending convoStep ${J.inspect(n)}`),rs(a,ls.USER_SAYS,n)):"livechat.stop"===e&&is(s)})}),startBot:async({caps:e,sources:t,envs:s},{pubsub:n,queueSettings:a})=>{const r=new p(a.redis),o=l(),i=new S(async(e,t)=>{try{const t=await cs({conversationId:o},{queueSettings:a}),s=t.length,i=JSON.stringify(Object.assign(e,{convoStepIndex:s}));n.publish(o,{liveChatConvoStepAdded:{convoStep:i}}),t.push(i),ds(o,t,r),os({conversationId:o,queueSettings:a,pubsub:n})}catch(e){Qt(`listenerQueue err: ${e}`)}t()}),c=Kt($.resolve(__dirname,process.env.BOTIUMBOX_LIVECHAT_WORKER_FILE||"livechatWorker.js"),[JSON.stringify({caps:e,sources:t,envs:s,conversationId:o})],{env:Object.assign({},process.env,s),execArgv:["--inspect=0"]});return c.on("message",({type:e,message:t})=>{switch(e){case ls.USER_SAYS_FAILED:Qt(`liveChatSendToBot conversationId: ${o} UserSays failed: ${t}`),n.publish(o,{liveChatConvoStepAdded:{err:`Failed sending to chatbot: ${t}`}});break;case ls.LOG:Zt(t);break;case ls.STOP_CONVERSATION_FINISHED:Qt(`liveChatSendToBot conversationId: ${o} STOP_CONVERSATION_FINISHED`),delete c[t.conversationId];break;case ls.MESSAGE_SENTTOBOT:case ls.MESSAGE_RECEIVEDFROMBOT:const s=F.omit(t,["attachments","sourceData"]);Qt(`Received IPC message ${e} from worker. conversationId: ${o}, message: ${J.inspect(s)}`),i.push(t);break;default:Qt(`Unknown message type: ${e}`)}}),ns[o]=c,ds(o,[],r),os({conversationId:o,queueSettings:a,pubsub:n}),o},sendToBot:async({conversationId:e,convoStep:t},{queueSettings:s})=>{new p(s.redis).publish("livechat.send",JSON.stringify({conversationId:e,convoStep:t}))},stopBot:async({conversationId:e},{queueSettings:t})=>{new p(t.redis).publish("livechat.stop",JSON.stringify({conversationId:e}))},getConversation:cs,IPC_MESSAGE_TYPE:ls,getConversationScripts:async({caps:e,conversationId:t,testCaseName:s,types:n,splitToConvoAndUtterancesMe:a,splitToConvoAndUtterancesBot:r},{queueSettings:o})=>{const i=await cs({conversationId:t},{queueSettings:o});if(!F.isArray(i))throw new Error("Conversation not available (anymore).");const c={header:{name:s},conversation:i.map(e=>((e,t)=>(e.asserters||(e.asserters=[]),t&&!t.includes("text")&&(e.messageText=""),t&&!t.includes("buttons")&&(e.buttons=[]),t&&!t.includes("media")&&(e.media=[]),e.nlp&&(t&&!t.includes("intents")||!e.nlp.intent||e.asserters.push({name:"INTENT",args:[e.nlp.intent.name]}),t&&!t.includes("entities")||!e.nlp.entities||e.asserters.push({name:"ENTITIES",args:e.nlp.entities.map(e=>e.name)})),e))(JSON.parse(e),n))},d=new es(e).BuildCompiler(),l=[];if(a||r){const e={all:0,empty:0,multirow:0,me:0,bot:0,filteredOut:0,utterances:[]},t=s.replace(" ","_").toUpperCase()+"_";for(const s of c.conversation)if(e.all++,s.messageText&&s.messageText.length)if(s.messageText.includes(d.caps[ts.SCRIPTING_TXT_EOL]))e.multirow++;else if("me"===s.sender&&a||"bot"===s.sender&&r){const n=(t+s.sender+"_"+(e[s.sender]+1)).toUpperCase(),a=s.messageText;s.messageText=n,l.push({script:n+d.caps[ts.SCRIPTING_TXT_EOL]+a,name:n}),e[s.sender]++,e.utterances.push(n)}else e.filteredOut++;else e.empty++;Qt(`Decompiled utterances: ${J.inspect(e)}`)}const u=d.Decompile([c],"SCRIPTING_FORMAT_TXT");return Qt(`Decompiled script: ${u}`),{script:u,utterances:l}}};const ps=L("botium-box-server-agents-performancetestsession"),Ss=(e,t)=>null===e?t:Math.min(e,t),hs=(e,t)=>null===e?t:Math.max(e,t),ms=new S(async(e,t)=>{ps(`progressProcessorQueue  starting with ${e.length} entries`);const s=async e=>{ps(`progressProcessorQueue  update entry: ${J.inspect(e.data)}`),await e.ctx.db.mutation.updatePerformanceTestSessionJob({data:e.data,where:{id:e.performanceTestSessionJobId}})};let n=0;for(const t of e)t.data&&"RUNNING"===t.data.status&&(await s(t),n++);const a=e[0].ctx,r=F.uniq(e.filter(e=>e.dataRaw).map(e=>e.performanceTestSessionId));let o=null;const i=new Map;if(0!==r.length){ps("progressProcessorQueue aggregating");const t=e=>{if(!e.performanceTestSessionId)throw new Error("performanceTestSessionId is not set");if(!e.performanceTestSessionJobId)throw new Error("performanceTestSessionJobId is not set");if(!e.convo)throw new Error("convo is not set");const t={performanceTestSessionId:e.performanceTestSessionId,performanceTestSessionJobId:e.performanceTestSessionJobId,convo:e.convo,stepIndex:e.stepIndex?e.stepIndex:0};return JSON.stringify(t)},s=(e,t,s,n)=>{e<s&&ps(`Bad state, ${s} (${s.getTime()}) should be after ${e} (${e.getTime()})!`);const a=(e,t,s,n)=>!(t<s||n<e);let r=0;const o=[];for(;;){let i=k(s).add(n,"ms").toDate();if(o.length>=1e3)return ps("getSteps terminating at 1000 steps"),o;if(a(s,i,e,t))o.push(r);else if(o.length>0)return o;r++,s=i}},n=async()=>{const e=await a.db.query.performanceTestSessions({where:{id_in:r}}),t=new Map;for(const s of e)t.set(s.id,s);return t},c=await n();ps(`progressProcessorQueue  affected sessions ${c.size}`);for(const n of e.filter(e=>e.dataRaw)){if(!c.has(n.performanceTestSessionId))throw new Error(`progressProcessorQueue PerformanceTestSession not found by ID ${n.performanceTestSessionId}`);const{dataDensity:e,createdAt:a}=c.get(n.performanceTestSessionId),r=(s,r,o)=>{const c=o?"wait":"exec",d=o?s.testBegin.getTime()-s.queueBegin.getTime():s.runtime,l=t({performanceTestSessionId:n.performanceTestSessionId,performanceTestSessionJobId:n.performanceTestSessionJobId,convo:n.dataRaw.convo,stepIndex:r});i.has(l)||i.set(l,{temporary:{performanceTestSessionJobId:n.performanceTestSessionJobId,firstStepAt:a},stepIndex:r,execCount:0,execDurationSum:0,execDurationMin:null,execDurationMax:null,waitCount:0,waitDurationSum:0,waitDurationMin:null,waitDurationMax:null,stepStartAt:k(a).add(e*r,"ms").toDate()});const u=i.get(l);u[c+"Count"]++,u[c+"DurationSum"]+=d,u[c+"DurationMin"]=Ss(u[c+"DurationMin"],d),u[c+"DurationMax"]=hs(u[c+"DurationMax"],d)},o=s(n.dataRaw.queueBegin,n.dataRaw.testBegin,a,e);for(const e of o)r(n.dataRaw,e,!0);const d=s(n.dataRaw.testBegin,n.dataRaw.testEnd,a,e);for(const e of d)r(n.dataRaw,e,!1)}ps(`progressProcessorQueue  aggregated to ${i.size} records`);const d=new S(async(e,t)=>{ps(`progressProcessorQueue  upserting ${e.length} records`);let s=0,n=0;for(const[t,r]of e){const{performanceTestSessionId:e,performanceTestSessionJobId:o,convo:i,stepIndex:c}=JSON.parse(t),d=await a.db.query.performanceTestSessionAggregatedResults({where:{AND:[{testSession:{id:e}},{job:{id:o}},{stepIndex:c},{convo:i}]}});if(d.length>1)throw new Error(`Expected result: 0 or 1. Found: ${d.length} by ${t}`);if(0===d.length){n++;const t=Object.assign([],r);delete t.temporary,await a.db.mutation.createPerformanceTestSessionAggregatedResult({data:{testSession:{connect:{id:e}},job:{connect:{id:o}},stepIndex:c,convo:i,...t}})}else{s++;const e=d[0],t=r;await a.db.mutation.updatePerformanceTestSessionAggregatedResult({data:{execCount:t.execCount+e.execCount,execDurationMin:Ss(t.execDurationMin,e.execDurationMin),execDurationMax:hs(t.execDurationMax,e.execDurationMax),execDurationSum:t.execDurationSum+e.execDurationSum,waitCount:t.waitCount+e.waitCount,waitDurationMin:Ss(t.waitDurationMin,e.waitDurationMin),waitDurationMax:hs(t.waitDurationMax,e.waitDurationMax),waitDurationSum:t.waitDurationSum+e.waitDurationSum},where:{id:e.id}})}}ps(`progressProcessorQueue  upserted ${e.length} records, inserts ${n} updates: ${s}`),t()},{batchSize:100});for(const e of i.entries())d.push(e);o=new Promise(e=>{d.on("drain",()=>{e()})})}else ps("No progress data found in batch");o&&await o;for(const t of e)t.data&&"READY"===t.data.status&&(await s(t),n++);ps(`progressProcessorQueue  batch processed. Full size: ${e.length} stat entries: ${e.length-n} aggregated: ${i.size}`),t()},{batchSize:1e3,batchDelay:1e3});var fs={startPerformanceTestSession:async(e,{performanceTestSessionId:t})=>{},performanceTestSessionAgentStart:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s,agentName:n})=>{ms.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{agentName:n,status:"RUNNING",started:new Date(Date.now()).toISOString()}})},performanceTestSessionProgress:async(e,t)=>{const s=Object.assign({},t);s.queueBegin&&(s.queueBegin=new Date(s.queueBegin)),s.testBegin&&(s.testBegin=new Date(s.testBegin)),s.testEnd&&(s.testEnd=new Date(s.testEnd)),ms.push({ctx:e,performanceTestSessionId:t.performanceTestSessionId,performanceTestSessionJobId:t.performanceTestSessionJobId,dataRaw:s})},performanceTestSessionSetJobReadySuccess:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s})=>{ms.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{status:"READY",finished:new Date(Date.now()).toISOString()}})},performanceTestSessionSetJobReadyFailed:async(e,{performanceTestSessionId:t,performanceTestSessionJobId:s,err:n})=>{ms.push({ctx:e,performanceTestSessionId:t,performanceTestSessionJobId:s,data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),err:n}})}};const Ts=L("botium-box-server-charts-mutation");var ys={updateChartCacheForTestSession:(e,{testSessionId:t},s,n)=>s.db.query.testSession({where:{id:t}},"{ id status results { success testSet { id } } jobs { status totalCount failedCount successCount } }").then(e=>{if(!e)return;const n={};return"READY"===e.status||"FAILED"===e.status?(n.totalCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.totalCount||0),0)||0,n.failedCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.failedCount||0),0)||0,n.successCount=e.jobs.filter(e=>"READY"===e.status||"FAILED"===e.status).reduce((e,t)=>e+(t.successCount||0),0)||0):(n.totalCount=e.results.length,n.failedCount=e.results.filter(e=>!e.success).length,n.successCount=e.results.filter(e=>e.success).length),n.countByTestSetId=e.results.reduce((e,t)=>{const s=t.testSet?t.testSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),n.countByDeviceSetId=e.results.reduce((e,t)=>{const s=t.deviceSet?t.deviceSet.id:"NULL";return e[s]||(e[s]={totalCount:0,failedCount:0,successCount:0}),e[s].totalCount++,t.success?e[s].successCount++:e[s].failedCount++,e},{}),Ts(`updateChartCacheForTestSession ${t} chartData updated: ${J.inspect(n)}`),s.db.mutation.updateTestSession({where:{id:e.id},data:{chartData:JSON.stringify(n)}}).then(()=>n)}).then(e=>(s.chartsCache.flush(),e))};const gs=L("botium-box-server-mutation-testsession"),bs=le.createContext;var Es={createTestSession:async(e,{testSession:t},s,n)=>s.db.mutation.createTestSession({data:t},n).then(async e=>(e.securityCheck&&await bs({testSessionId:e.id,ctx:s}),e)).then(e=>new Promise((n,a)=>{s.queueConnector.create("box.createprocessingjobs",{title:`Job Creation Job for Test Session ${t.name}`,testSessionId:e.id}).removeOnComplete(!0).save(t=>{if(t)return a(t);n(e)})})),deleteTestSession:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteManyTestSessionJobLogs({where:{testSessionJob:{testSession:{id:t}}}}).then(()=>s.db.mutation.deleteManyTestSessionJobs({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteManyTestSessionTestCaseResultAttachments({where:{testSessionTestCaseResult:{testSession:{id:t}}}})).then(()=>s.db.mutation.deleteManyTestSessionTestCaseResults({where:{testSession:{id:t}}})).then(()=>s.db.mutation.deleteTestSession({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(gs(`Error deleting test session ${t}: ${e}`),n(e)))}),async cancelTestSession(e,{id:t},s){const n=await s.db.query.testSession({where:{id:t}},"{ id name jobs { id status jobId } }");if(!n)return!1;n.jobs.filter(e=>e.jobId).forEach(async e=>{m.Job.remove(e.jobId,t=>{gs(t?`cancelTestSession - Failed to remove job ${e.jobId}: ${t}`:`cancelTestSession - removed job ${e.jobId}`)}),"PENDING"===e.status?(gs(`cancelTestSession - status of job (${e.jobId}) is PENDING, setting to FAILED`),await s.db.mutation.updateTestSessionJob({data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:0,failedCount:0,successCount:0,err:"Job cancelled"},where:{id:e.id}})):gs(`cancelTestSession - status of job (${e.jobId}) is ${e.status}, keeping`)});const a=await s.db.query.agents({where:{}},"{ id name }");for(const e of a)gs(`cancelTestSession - sending cancel test session event ${n.id}/${n.name} to agent ${e.id}/${e.name}`),await s.queueConnector.create(`process.cancel.${e.name}`,{title:`Cancel Test Session Job for Test Session ${n.id}/${n.name}, Agent ${e.name}`,testSessionId:n.id,testSessionName:n.name}).removeOnComplete(!0).save(e=>{if(e)throw e});return!0},async stopTestSession(e,{id:t},s){const n=await s.db.query.testSession({where:{id:t}},"{ id name jobs { id status jobId } }");if(!n)return!1;await s.db.mutation.updateTestSession({where:{id:n.id},data:{status:"FAILED"}});for(const e of n.jobs)e.jobId&&m.Job.remove(e.jobId,t=>{gs(t?`stopTestSession - Failed to remove job ${e.jobId}: ${t}`:`stopTestSession - removed job ${e.jobId}`)}),"PENDING"===e.status?(gs(`cancelTestSession - status of job (${e.jobId}) is PENDING, setting to READY`),await s.db.mutation.updateTestSessionJob({data:{status:"READY",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:0,failedCount:0,successCount:0,err:"Job cancelled"},where:{id:e.id}})):gs(`cancelTestSession - status of job (${e.jobId}) is ${e.status}, keeping`);const a=await s.db.query.agents({where:{}},"{ id name }");for(const e of a)gs(`stopTestSession - sending stop test session event ${n.id}/${n.name} to agent ${e.id}/${e.name}`),await s.queueConnector.create(`process.stop.${e.name}`,{title:`Stop Test Session Job for Test Session ${n.id}/${n.name}, Agent ${e.name}`,testSessionId:n.id,testSessionName:n.name}).removeOnComplete(!0).save(e=>{if(e)throw e});return!0}};const{URL:ws}=h,Cs=L("botium-box-server-agents-testsession"),{updateChartCacheForTestSession:vs}=ys,{stopTestSession:Is}=Es;const Os=new S(async(e,t)=>{const s=F.uniq(e.map(e=>e.testSessionId));Cs(`sendProgressProcessingQueue for testSessionIds: ${s}`),s.forEach(async t=>{try{await vs(null,{testSessionId:t},e[0].ctx)}catch(e){Cs(`updateChartCacheForTestSession failed: ${e}`)}e[0].ctx.pubsub.publish("TEST_SESSION_PROGRESS",{testSessionProgress:{id:t}})}),t()},{batchSize:1e3,batchDelay:3e3}),Rs=(e,t)=>{Os.push({testSessionId:t,ctx:e})};var Ns={startTestSession:async(e,{testSessionId:t})=>{try{const s=await ue.findFullTestSession(e.db,t);if(!s)throw new Error(`Test Session ${t} not configured`);const n=s.agent?"process.run."+s.agent.name:"process.run";Cs(`startTestSession ${s.id} queueToSend: ${n}`);const{testSessionCaps:a,testSessionSources:r,testSessionEnvs:o,testSessionTestSets:i,zapAvailable:c}=await ue.extractTestSessionLike(e,s);if(!c)throw new Error("Zaproxy is not reachable");let d=1;const l=async(t,a,i)=>{for(let i=1;i<=d;i++){const c=await e.db.mutation.createTestSessionJob({data:{status:"PENDING",progressPercent:0,testSession:{connect:{id:s.id}}}},"{ id }"),l=e.queueConnector.create(n,{title:`Processing Job #${i}/${d} for Test Session ${s.name}`,testSessionId:s.id,testSessionName:s.name,testSessionJobId:c.id,botium:{Capabilities:t,Sources:r,Envs:o},testSets:a,batchNum:i,batchCount:d,bail:s.bail}).removeOnComplete(!0).save(async t=>{if(t)return Cs(`Saving batchJob failed: ${t}`);const n=l.id;try{await e.db.mutation.updateTestSessionJob({data:{jobId:n},where:{id:c.id}}),Cs(`TestSessionJob for TestSession ${s.name} registered (jobId: ${n} id: ${c.id})`)}catch(t){Cs(`TestSessionJob for TestSession ${s.name} registration failed (jobId: ${n}): ${t}`)}try{await e.db.mutation.createTestSessionJobLog({data:{log:"Job queued for execution",order:-999999,testSessionJob:{connect:{id:c.id}}}},"{ id }")}catch(t){Cs(`TestSessionJob for TestSession ${s.name} logging failed (jobId: ${n}): ${t}`)}})}};if(s.deviceSets&&s.deviceSets.length>0){const e=s.deviceSets.reduce((e,t)=>[...e,...t.devices.map(e=>{const n=t.provider.url&&new ws(t.provider.url),r=n?{protocol:n&&n.protocol.replace(":",""),host:n&&n.hostname,port:n&&n.port,path:n&&n.pathname}:{};return"/"===r.path&&(r.path=""),"SAUCELABS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name,username:t.provider.username,accessKey:t.provider.password})},r)}:"TESTOBJECTS"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{testobject_suite_name:s.name,testobject_api_key:t.provider.password})},r)}:"EXPERITEST"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{testName:s.name,accessKey:t.provider.password})},r)}:"LOCALSELENIUM"===t.provider.type?{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)}:("INTEGRATED"===t.provider.type&&(Cs(`startTestSession ${s.id} adding capability for starting integrated PhantomJS`),a.WEBDRIVERIO_START_PHANTOMJS=!0),{deviceSetId:t.id,deviceName:e.name,deviceOptions:Object.assign({desiredCapabilities:Object.assign({},JSON.parse(e.capabilities),{name:s.name})},r)})})],[]);Cs(`startTestSession ${s.id} testSessionDevices: ${JSON.stringify(e,null,2)}`);let t=Promise.resolve();e.forEach(e=>{const s=t=>t&&t.forEach(t=>{t.sourceTag=Object.assign({},t.sourceTag,{deviceSetId:e.deviceSetId,deviceName:e.deviceName})}),n=F.cloneDeep(i);n.forEach(e=>{s(e.convos),s(e.utterances),s(e.repositories),s(e.folders),s(e.excels)});const r=Object.assign({},a,{WEBDRIVERIO_OPTIONS:e.deviceOptions});t=t.then(()=>l(r,n,c))}),await t}else await l(a,i,c)}catch(s){Cs(`startTestSession failed: ${s}`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"FAILED",jobs:{create:[{progressPercent:100,status:"FAILED",started:new Date(Date.now()).toISOString(),finished:new Date(Date.now()).toISOString(),err:`${s}`}]}}})}},testSessionLog:async(e,{testSessionJobId:t,log:s,order:n})=>{if(F.isNull(n)||F.isUndefined(n))throw new Error("TestSessionLog.order is not set");try{await e.db.mutation.createTestSessionJobLog({data:{log:s,order:n,testSessionJob:{connect:{id:t}}}},"{ id }")}catch(e){throw Cs(`testSessionJobCompleted failed: ${e}`),e}},testSessionProgress:async(e,{testSessionId:t,testSessionJobId:s,batchNum:n,progress:a,...r})=>{try{const{count:a}=await e.db.mutation.updateManyTestSessions({data:{status:"RUNNING"},where:{id:t,status:"PENDING"}});a>0&&Cs(`Test Session Job ${s}/#${n} set Test Session ${t} RUNNING.`)}catch(e){throw Cs(`Test Session Job ${s}/#${n} set Test Session ${t} RUNNING failed: ${e}`),e}try{const{count:r}=await e.db.mutation.updateManyTestSessionJobs({data:{status:"RUNNING",started:new Date(Date.now()).toISOString(),progressPercent:F.isNumber(a)&&a},where:{id:s,status:"PENDING"}});r>0&&Cs(`Test Session Job ${s}/#${n} set Test Session ${t} Job RUNNING.`)}catch(e){throw Cs(`Test Session Job ${s}/#${n} set Test Session ${t} Job RUNNING failed: ${e}`),e}if(F.isNumber(a))try{const{count:t}=await e.db.mutation.updateManyTestSessionJobs({data:{progressPercent:a},where:{id:s,progressPercent_lt:a}});t>0&&Cs(`Test Session Job ${s}/#${n} set Test Session Job progressPercent ${a}.`)}catch(e){throw Cs(`Test Session Job ${s}/#${n} set Test Session Job progressPercent ${a} failed: ${e}`),e}if(r.testcase){const a={testcaseName:r.testcase,testcaseSource:r.source,success:r.success,err:r.err,errDetails:r.errDetails&&JSON.stringify(r.errDetails),testSession:{connect:{id:t}}};r.transcript&&(r.transcript.convoBegin&&r.transcript.convoEnd&&(a.duration=k(r.transcript.convoEnd).diff(r.transcript.convoBegin)),r.transcript.steps&&(a.steps={create:r.transcript.steps.map((e,t)=>({step:t,sender:e.expected&&e.expected.sender,expected:e.expected&&(F.isString(e.expected)?e.expected:JSON.stringify(e.expected)),not:!!e.not,actual:e.actual&&(F.isString(e.actual)?e.actual:JSON.stringify(e.actual)),stepDuration:e.stepBegin&&e.stepEnd&&k(e.stepEnd).diff(e.stepBegin),botDuration:e.botBegin&&e.botEnd&&k(e.botEnd).diff(e.botBegin),err:e.err,errDetails:e.errDetails&&JSON.stringify(e.errDetails)}))})),r.sourceTag&&(r.sourceTag.filename&&(a.testSetFilename=r.sourceTag.filename),r.sourceTag.testSetId&&(a.testSet={connect:{id:r.sourceTag.testSetId}}),r.sourceTag.testSetScriptId&&(a.testSetScript={connect:{id:r.sourceTag.testSetScriptId}}),r.sourceTag.testSetRepositoryId&&(a.testSetRepository={connect:{id:r.sourceTag.testSetRepositoryId}}),r.sourceTag.testSetFolderId&&(a.testSetFolder={connect:{id:r.sourceTag.testSetFolderId}}),r.sourceTag.testSetExcelId&&(a.testSetExcel={connect:{id:r.sourceTag.testSetExcelId}}),r.sourceTag.deviceSetId&&(a.deviceSet={connect:{id:r.sourceTag.deviceSetId}}),r.sourceTag.deviceName&&(a.deviceName=r.sourceTag.deviceName)),r.attachments&&(a.attachments={create:r.attachments.map(e=>({name:e.name,mimeType:e.mimeType,base64:e.base64}))});try{const o=await e.db.mutation.createTestSessionTestCaseResult({data:a},"{ id }");Cs(`TestResult for TestCase "${r.testcase}" in TestSession "${t}" registered (jobId: ${s}/#${n} id: ${o.id})`)}catch(e){throw Cs(`TestResult for TestCase "${r.testcase}" in TestSession "${t}" registration failed (jobId: ${s}/#${n}): ${e}`),e}}if(r.stopTestSession)try{await Is(null,{id:t},e),Cs(`Test Session "${t}" stopped (jobId: ${s}/#${n}.`)}catch(e){throw Cs(`Test Session "${t}" stopping failed (jobId: ${s}/#${n}: ${e}`),e}Cs(`testSessionProgress - Testsession "${t}", Job ${s}/#${n}, progress ${a}, ready.`),Rs(e,t)},testSessionSetJobCompletedResult:async(e,{testSessionId:t,testSessionJobId:s,result:n})=>{try{Cs(`Test Session Job ${s}/${t} completed: ${JSON.stringify(n)}`),await e.db.mutation.updateTestSessionJob({data:{status:"READY",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:n&&n.totalCount,failedCount:n&&n.failedCount,successCount:n&&n.successCount},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:"Job completed",order:999999,testSessionJob:{connect:{id:s}}}},"{ id }"),Rs(e,t)}catch(e){throw Cs(`testSessionJobCompleted failed: ${e}`),e}},testSessionSetJobFailedErr:async(e,{testSessionId:t,testSessionJobId:s,result:n,err:a})=>{try{Cs(`Test Session Job ${s}/${t} failed: ${a}.`),await e.db.mutation.updateTestSessionJob({data:{status:"FAILED",finished:new Date(Date.now()).toISOString(),progressPercent:100,totalCount:n&&n.totalCount,failedCount:n&&n.failedCount,successCount:n&&n.successCount,err:a&&(F.isString(a)?a:JSON.stringify(a))},where:{id:s}},"{ id }"),await e.db.mutation.createTestSessionJobLog({data:{log:`Job failed: ${a}`,order:999999,testSessionJob:{connect:{id:s}}}},"{ id }"),Rs(e,t)}catch(a){throw Cs(`testSessionJobFailed failed: ${a}`),a}},testSessionCheckFinished:async(e,{testSessionId:t,testSessionJobId:s})=>{try{const n=await e.db.query.testSession({where:{id:t}},"{ id name status jobs { status finished failedCount } }");if(!n)return;if(n.jobs&&n.jobs.find(e=>"READY"!==e.status&&"FAILED"!==e.status))return void Cs(`Test Session testSessionCheckFinished ${t}/${s} waiting for other jobs to finish.`);let a=n.jobs&&!!n.jobs.find(e=>"FAILED"===e.status);const r=n.jobs&&!!n.jobs.find(e=>e.failedCount>0),{securityAlerts:o,url:i,zapAvailable:c}=await async function(t){try{const s=await e.db.query.testSessions({where:{id:t,securityCheck:!0}},"{ chatbot { capabilities { name stringValue intValue booleanValue jsonValue } } }").then(async e=>{if(e&&e.length){const[t]=e;return t.chatbot.capabilities.filter(e=>"SIMPLEREST_URL"===e.name).map(e=>e.stringValue)[0]}if(0===e.length)return Cs("Security check is disabled"),null;throw new Error("Can't get security info from prisma")}).catch(e=>{const t=new Error(`Can't fetch security results ${J.inspect(e)}`);throw Cs(t),t});return s?{securityAlerts:await le.getAlertsByUrl(s).then(e=>e.alerts).then(e=>e.map(e=>{const t=e.reference.split("\n");return{evidence:e.evidence,method:e.method,confidence:e.confidence,risk:e.risk,alert:e.alert,solution:e.solution,references:{set:t}}})).catch(e=>{Cs(new Error(`Can't get information from zap ${J.inspect(e)}`))}),url:s,zapAvailable:!0}:{securityAlerts:[],url:"",zapAvailable:!0}}catch(e){return{securityAlerts:[],url:"",zapAvailable:!1}}}(t);c||(a=!0),i&&(await e.db.mutation.createTestSessionJobLog({data:{log:`Found ${o&&o.length||0} security alert(s) for ${i}`,order:999999,testSessionJob:{connect:{id:s}}}},"{ id }"),Cs(`Found ${o&&o.length||0} security alert(s) for ${i}`)),a||r?(Cs(`testSessionCheckFinished test session ${t}/${n.name} failed (job failed: ${a}, result failed: ${r})`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"FAILED",securityAlerts:{create:o}}})):(Cs(`testSessionCheckFinished test session ${t}/${n.name} success`),await e.db.mutation.updateTestSession({where:{id:t},data:{status:"READY",securityAlerts:{create:o}}}).then(e=>e)),await le.deleteAllAlerts(),Rs(e,t)}catch(e){throw Cs(`testSessionCheckFinished ${t} failed: ${e}`),e}}};const xs=L("botium-box-server-agents-heartbeat");const Ps=L("botium-box-server-agents-registeragent");const As=L("botium-box-server-agents"),{startPerformanceTestSession:_s,performanceTestSessionAgentStart:$s,performanceTestSessionProgress:Ds,performanceTestSessionSetJobReadyFailed:Ms,performanceTestSessionSetJobReadySuccess:ks}=fs,{startTestSession:js,testSessionSetJobCompletedResult:Bs,testSessionSetJobFailedErr:qs,testSessionLog:Us,testSessionProgress:Ls,testSessionCheckFinished:Fs}=Ns;const Js=L("botium-box-server-testcasecleanup"),Gs=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,attachments_some:{base64_not:""}}},"{ id attachments { id } }");a.length>0?(Js(`Found ${a.length} screenshots to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultAttachments({where:{id_in:a.reduce((e,t)=>e.concat(t.attachments.map(e=>e.id)),[])}})):Js(`Found no screenshots to cleanup for ${s} (older than ${t}`)},Vs=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,steps_some:{expected_not:""}}},"{ id steps { id } }");a.length>0?(Js(`Found ${a.length} transcripts to cleanup for ${s} (older than ${t}`),await e.db.mutation.deleteManyTestSessionTestCaseResultTranscripts({where:{id_in:a.reduce((e,t)=>e.concat(t.steps.map(e=>e.id)),[])}})):Js(`Found no transcripts to cleanup for ${s} (older than ${t}`)},Hs=async(e,t,s,n)=>{const a=await e.db.query.testSessionTestCaseResults({where:{createdAt_lte:t,success:n,testcaseSource_not:""}},"{ id }");a.length>0?(Js(`Found ${a.length} results to cleanup for ${s} (older than ${t}`),await e.db.mutation.updateManyTestSessionTestCaseResults({data:{testcaseSource:""},where:{id_in:a.map(e=>e.id)}})):Js(`Found no results to cleanup for ${s} (older than ${t}`)},Ys=async(e,t)=>{const s=await e.db.query.systemSettingses();if(isNaN(t)&&(!s||!s[0].cleanupJobIntervalMinutes))return void Js("cleanupJobIntervalMinutes not configured, not scheduling cleanup task.");const n=isNaN(t)?60*s[0].cleanupJobIntervalMinutes*1e3:t;let a=[];try{a=await J.promisify(m.Job.rangeByType)("box.testcasecleanup","delayed",0,10,"")}catch(e){Js(`error checking job states: ${e}`)}if(a&&a.length)for(const e of a)try{await J.promisify(e.remove).bind(e)(),Js(`Removed duplicate Scheduled Test Case Cleanup Job ${e.id}.`)}catch(t){return Js(`Removing Scheduled Test Case Cleanup Job ${e.id} failed: ${t}`),void Js("Skipping cleanup job removal.")}return new Promise(t=>{const s=e.queueConnector.create("box.testcasecleanup",{title:"Scheduled Test Case Cleanup Job"}).removeOnComplete(!0).delay(n).save(e=>{if(e)Js(`Scheduling Test Case Cleanup Job failed: ${e}`);else{const e=s.id;Js(`Scheduled Test Case Cleanup Job ${e}, next run delay: ${n}`)}return t()})})};var zs=async e=>{e.queueConnector.process("box.testcasecleanup",async(t,s)=>{try{await(async e=>{Js("runCleanup started ...");const t=await e.db.query.systemSettingses();if(t&&!isNaN(t[0].keepTestCaseSuccessScreenshotsDays)){const s=k().subtract(t[0].keepTestCaseSuccessScreenshotsDays,"days").startOf("day").toDate();try{await Gs(e,s,"keepTestCaseSuccessScreenshotsDays",!0)}catch(e){Js(`runCleanupScreenshots keepTestCaseSuccessScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedScreenshotsDays)){const s=k().subtract(t[0].keepTestCaseFailedScreenshotsDays,"days").startOf("day").toDate();try{await Gs(e,s,"keepTestCaseFailedScreenshotsDays",!1)}catch(e){Js(`runCleanupScreenshots keepTestCaseFailedScreenshotsDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseSuccessConversationDays)){const s=k().subtract(t[0].keepTestCaseSuccessConversationDays,"days").startOf("day").toDate();try{await Vs(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){Js(`runCleanupTranscripts keepTestCaseSuccessConversationDays failed: ${e}`)}try{await Hs(e,s,"keepTestCaseSuccessConversationDays",!0)}catch(e){Js(`runCleanupDetails keepTestCaseSuccessConversationDays failed: ${e}`)}}if(t&&!isNaN(t[0].keepTestCaseFailedConversationDays)){const s=k().subtract(t[0].keepTestCaseFailedConversationDays,"days").startOf("day").toDate();try{await Vs(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){Js(`runCleanupTranscripts keepTestCaseFailedConversationDays failed: ${e}`)}try{await Hs(e,s,"keepTestCaseFailedConversationDays",!1)}catch(e){Js(`runCleanupDetails keepTestCaseFailedConversationDays failed: ${e}`)}}})(e),Js("Test Case Cleanup ready."),s(),await Ys(e)}catch(t){Js(`Test Case Cleanup failed: ${t}`),s(),await Ys(e)}}),await Ys(e,0)};const Ws=e=>({id:e}),Xs=e=>e&&e.id;var Ks={jwtSettings:()=>({secret:process.env.JWT_SECRET,audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"}),userIdToToken:Ws,tokenToUserId:Xs,generateToken:e=>I.sign(Ws(e.id),process.env.JWT_SECRET,{expiresIn:86400*(process.env.JWT_EXPIRY_DAYS||30),audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox",subject:e.id.toString()}),validateToken:async(e,t)=>{const s=I.verify(e,process.env.JWT_SECRET,{audience:process.env.JWT_AUDIENCE||"botiumbox",issuer:process.env.JWT_ISSUER||"botiumbox"});return await t.query.user({where:{id:Xs(s)}},"{ id name email roles { id name permissions } clients { id name } }")}};const{generateToken:Qs}=Ks,{isValid:Zs,isOperable:en,getLicense:tn}=ee;var sn={me:async(e,t,s,n)=>s.request&&s.request.user,async autologin(e,t,s,n){if(s.request&&s.request.user)return{user:s.request.user,token:Qs(s.request.user)}},license(e,t,s,n){const a=tn();return a.isValid=Zs(),a.isOperable=en(),a}},nn={agents:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.agents({where:t,orderBy:s,skip:n,first:a},o)),agent:(e,{id:t},s,n)=>s.db.query.agent({where:{id:t}},n)};const an=L("botium-box-server-resolvers-chatbots");var rn={chatbots:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.chatbots({where:t,orderBy:s,skip:n,first:a},o)),chatbot:(e,{id:t},s,n)=>s.db.query.chatbot({where:{id:t}},n),availablewatsonworkspaces:(e,{url:t,version:s,apikey:n,username:a,password:r})=>new Promise((e,o)=>{const i={url:t,version:s};n?Object.assign(i,{iam_apikey:n}):Object.assign(i,{username:a,password:r}),an(`listWorkspaces for watson assistant: ${JSON.stringify(i)}`),new f(i).listWorkspaces((t,s)=>{if(t)o(t);else{const t=s.workspaces.map(e=>({name:e.name,description:e.description,value:e.workspace_id}));e(t)}})})};const on=(e,t)=>{if(!e)return!1;if(!e.roles&&!e.permissions)return!1;if("admin"!==e.name&&process&&process.env&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS&&process.env.BOTIUMBOX_DISABLE_PERMISSIONS.indexOf(t)>=0)return!1;const s=[];if(e.roles)for(const t of e.roles)t.permissions&&t.permissions.forEach(e=>s.push(e));e.permissions&&e.permissions.forEach(e=>s.push(e));for(const e of s){if("*"===e)return!0;if(e.endsWith("*")){if(t.startsWith(e.substr(0,e.length-1)))return!0}else if(e.startsWith("*")){if(t.endsWith(e.substr(1)))return!0}else if(e===t)return!0}return!1};var cn={permissionTypes:{AGENTS_SELECT:"AGENTS_SELECT",AGENTS_CREATE:"AGENTS_CREATE",AGENTS_UPDATE:"AGENTS_UPDATE",AGENTS_DELETE:"AGENTS_DELETE",CHATBOTS_SELECT:"CHATBOTS_SELECT",CHATBOTS_CREATE:"CHATBOTS_CREATE",CHATBOTS_UPDATE:"CHATBOTS_UPDATE",CHATBOTS_DELETE:"CHATBOTS_DELETE",CHATBOTS_LIVECHAT:"CHATBOTS_LIVECHAT",DEVICESETS_SELECT:"DEVICESETS_SELECT",DEVICESETS_CREATE:"DEVICESETS_CREATE",DEVICESETS_UPDATE:"DEVICESETS_UPDATE",DEVICESETS_DELETE:"DEVICESETS_DELETE",TESTPROJECTS_SELECT:"TESTPROJECTS_SELECT",TESTPROJECTS_CREATE:"TESTPROJECTS_CREATE",TESTPROJECTS_UPDATE:"TESTPROJECTS_UPDATE",TESTPROJECTS_DELETE:"TESTPROJECTS_DELETE",TESTSETS_SELECT:"TESTSETS_SELECT",TESTSETS_CREATE:"TESTSETS_CREATE",TESTSETS_UPDATE:"TESTSETS_UPDATE",TESTSETS_DELETE:"TESTSETS_DELETE",TESTSESSIONS_SELECT:"TESTSESSIONS_SELECT",TESTSESSIONS_CREATE:"TESTSESSIONS_CREATE",TESTSESSIONS_DELETE:"TESTSESSIONS_DELETE",TESTSESSIONS_REPORTS:"TESTSESSIONS_REPORTS",APIKEYS_SELECT:"APIKEYS_SELECT",APIKEYS_MANAGE:"APIKEYS_MANAGE",DEVICEPROVIDERS_SELECT:"DEVICEPROVIDERS_SELECT",DEVICEPROVIDERS_MANAGE:"DEVICEPROVIDERS_MANAGE",REGISTEREDCOMPONENTS_SELECT:"REGISTEREDCOMPONENTS_SELECT",REGISTEREDCOMPONENTS_MANAGE:"REGISTEREDCOMPONENTS_MANAGE",USERS_MANAGE:"USERS_MANAGE",SYSTEMSETTINGS_MANAGE:"SYSTEMSETTINGS_MANAGE",IMPORT_PRISMA:"IMPORT_PRISMA"},hasPermission:on,hasAnyPermission:(e,t)=>{for(const s of t)if(on(e,s))return!0;return!1},hasAllPermissions:(e,t)=>{for(const s of t)if(!on(e,s))return!1;return!0}};var dn={isLoggedIn:e=>{const t=(e=>F.get(e,"request.user"))(e),s=(e=>F.get(e,"request.apiKey"))(e),n=(e=>F.get(e,"connection.context.user"))(e);if(!t&&!s&&!n)throw new Error("Not logged in");return t||s||n},getClientIdFilter:e=>{return null},withClientConnect:(e,t,s)=>{if(s&&!e.client&&(e.client={connect:{id:s}}),e.client&&e.client.connect&&e.client.connect.id){if(!t)throw new Error("Unauthorized, missing client access");if(!t.find(t=>t.id===e.client.connect.id))throw new Error("Unauthorized, missing client access")}return e},withClientFilter:(e,t,s)=>{return{AND:[e||{}]}},assertClient:(e,t)=>{if(e&&(!t||!t.find(t=>t.id===e)))throw new Error("Unauthorized, missing client access")}};const ln=L("botium-box-server-livechat"),{hasPermission:un}=cn,{isLoggedIn:pn,getClientIdFilter:Sn,withClientConnect:hn}=dn,{startBot:mn,sendToBot:fn,stopBot:Tn,getConversation:yn,getConversationScripts:gn}=us,{getChatbotCapabilities:bn}=ue;var En={liveChatConvoStepAdded:{subscribe:(e,{conversationId:t},{pubsub:s})=>s.asyncIterator(t)}},wn={async liveChatConvoSteps(e,{conversationId:t},s){try{return yn({conversationId:t},s)}catch(e){throw ln(e),new Error(`Conversation ${t} not available.`)}}},Cn={async liveChatStartBot(e,{chatbotId:t},{db:s,pubsub:n,queueSettings:a}){const{caps:r,envs:o}=await bn(t,s,a);return await mn({caps:r,envs:o},{pubsub:n,queueSettings:a})},liveChatSendToBot:async(e,{conversationId:t,convoStep:s},{queueSettings:n})=>(await fn({conversationId:t,convoStep:JSON.parse(s)},{queueSettings:n}),!0),liveChatStopBot:async(e,{conversationId:t},{queueSettings:s})=>(await Tn({conversationId:t},{queueSettings:s}),!0),async liveChatSaveConvoSteps(e,{chatbotId:t,conversationId:s,testSetId:n,newTestSetName:a,testCaseName:r,splitToConvoAndUtterancesMe:o,splitToConvoAndUtterancesBot:i,types:c},d){const l=pn(d),{caps:u}=await bn(t,d.db,d.queueSettings);let p=null;if(a){if(!un(l,"TESTSETS_CREATE"))throw new Error("Missing permission TESTSETS_CREATE");p=await d.db.mutation.createTestSet({data:hn({name:a},l.clients,Sn(d))},"{ id name }")}else p=await d.db.query.testSet({where:{id:n}},"{ id name }");const{script:S,utterances:h}=await gn({caps:u,conversationId:s,testCaseName:r,types:c,splitToConvoAndUtterancesMe:o,splitToConvoAndUtterancesBot:i},d);ln(`live2ChatSaveConvoSteps(${s}) saving test case for test set ${p.id}/${p.name}`);let m=await d.db.mutation.createTestSetScript({data:{name:r,script:S,scriptType:"SCRIPTING_TYPE_CONVO",testSet:{connect:{id:p.id}}}},"{ id name }");for(const e of h)await d.db.mutation.createTestSetScript({data:{name:e.name,script:e.script,scriptType:"SCRIPTING_TYPE_UTTERANCES",testSet:{connect:{id:p.id}}}},"{ id name }");return ln(`liveChatSaveConvoSteps(${s}) saved test case for test set ${p.id}/${p.name} - ${m.id}/${m.name} - utterance count: ${h.length}`),p.id}},vn={testsessions:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.testSessions({where:t,orderBy:s,skip:n,first:a},o)),testsession:(e,{id:t},s,n)=>s.db.query.testSession({where:{id:t}},n),testsessiontestcaseresult:(e,{id:t},s,n)=>s.db.query.testSessionTestCaseResult({where:{id:t}},n),testsessionjoblogs:(e,{jobId:t,orderBy:s,skip:n,first:a},r,o)=>r.db.query.testSessionJobLogs({where:{testSessionJob:{id:t}},orderBy:s,skip:n,first:a},o)};const In=new se(3600);var On={devicesets:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.deviceSets({where:t,orderBy:s,skip:n,first:a},o)),deviceset:(e,{id:t},s,n)=>s.db.query.deviceSet({where:{id:t}},n),async availabledevices(e,{provider:t},s){const n=await s.db.query.deviceProvider({where:{id:t}});if(!n)return[];let a=[];"SAUCELABS"===n.type?a=await In.get("SAUCELABS",()=>M({url:"https://saucelabs.com/rest/v1/info/platforms/all",json:!0}).then(e=>{return e.filter(e=>!e.device).map(e=>({name:`${e.long_name} ${e.short_version}, ${e.os}`,value:JSON.stringify({type:"DESKTOP",capabilities:{browserName:e.api_name,platform:e.os,version:e.short_version}})})).concat(e.filter(e=>e.device).map(e=>({name:`${e.long_name}, ${e.short_version}`,value:JSON.stringify({type:"MOBILEBROWSER",capabilities:{browserName:["iphone","ipad"].indexOf(e.api_name)>=0?"Safari":"Chrome",deviceName:e.device,platformName:["iphone","ipad"].indexOf(e.api_name)>=0?"iOS":"Android",platformVersion:e.short_version}})})))})):"TESTOBJECTS"===n.type?n.username&&n.password&&(a=await In.get("TESTOBJECTS_"+n.url,()=>M({url:"https://app.testobject.com/api/rest/v2/devices",json:!0}).auth(n.username,n.password).then(e=>{return e[n.url.includes("eu1")?"EU":"US"].map(e=>({name:`${e.name}, ${e.os}, ${e.osVersion}`,value:JSON.stringify({type:"MOBILEAPP",capabilities:{deviceName:e.name,platformName:e.os,platformVersion:e.osVersion}})}))}))):"EXPERITEST"===n.type&&(a=await In.get("EXPERITEST",()=>{const e=new URL(n.url);return e.pathname="/api/v1/devices",M({url:e.href,headers:{Authorization:`Bearer ${n.password}`},json:!0}).then(e=>{return e.data&&e.data.filter(e=>e.deviceName).map(e=>({name:`${e.deviceName}, ${e.deviceOs} ${e.osVersion}`,value:JSON.stringify({type:"MOBILEBROWSER",capabilities:{browserName:"iOS"===e.deviceOs?"Safari":"Chrome",platformName:e.deviceOs,platformVersion:e.osVersion,deviceManufacturer:e.manufacturer,deviceModel:e.model,deviceCategory:e.deviceCategory}})}))})}));const r=(a||[]).concat((e=>{const t=$.join(process.env.RESOURCESDIR,`${e.type}.json`);if(D.existsSync(t)){const e=JSON.parse(D.readFileSync(t,"utf8"));if(F.isArray(e)){let t=e.filter(e=>e.name&&e.value).map(e=>({name:e.name,value:JSON.stringify(e.value)}));return F.uniqBy(F.orderBy(t,"name","asc"),"name")}}return[]})(n)||[]);return F.uniqBy(F.orderBy(r,"name","asc"),"name")}},Rn={testprojects:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.testProjects({where:t,orderBy:s,skip:n,first:a},o)),testproject:(e,{id:t},s,n)=>s.db.query.testProject({where:{id:t}},n)},Nn={users:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.users({where:t,orderBy:s,skip:n,first:a},o)),user:(e,{id:t},s,n)=>s.db.query.user({where:{id:t}},n),userroles:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.userRoles({where:t,orderBy:s,skip:n,first:a},o)),clients:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.clients({where:t,orderBy:s,skip:n,first:a},o)),apikeys:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.apiKeys({where:t,orderBy:s,skip:n,first:a},o)),apikey:(e,{id:t},s,n)=>s.db.query.apiKey({where:{id:t}},n),deviceproviders:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.deviceProviders({where:t,orderBy:s,skip:n,first:a},o).then(e=>(e&&e.forEach(e=>{delete e.password}),e))),deviceprovider:(e,{id:t},s,n)=>s.db.query.deviceProvider({where:{id:t}},n).then(e=>(e&&delete e.password,e)),registeredcomponents:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.registeredComponents({where:t,orderBy:s,skip:n,first:a},o)),registeredcomponent:(e,{id:t},s,n)=>s.db.query.registeredComponent({where:{id:t}},n),systemsettings:(e,t,s,n)=>s.db.query.systemSettingses({skip:0,first:1},n).then(e=>e&&e.length&&e[0]),tags:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"name_ASC",r.db.query.tags({where:t,orderBy:s,skip:n,first:a},o)),availableconnectors(e,t,s,n){const a=[{name:"echo",description:"Botium Sample Chatbot (Echo)"},{name:"watson",description:"IBM Watson Assistant API"},{name:"directline3",description:"Microsoft Bot Framework (Directline 3)"},{name:"dialogflow",description:"Google Dialogflow"},{name:"koreai-webhook",description:"Kore.ai"},{name:"fbpagereceiver",description:"Facebook Messenger Bots"},{name:"botkit",description:"Botkit via HTTP(s)/JSON"},{name:"botkit-websocket",description:"Botkit via Websockets"},{name:"botpress",description:"Botpress.io"},{name:"simplerest",description:"Generic HTTP/JSON Interface"},{name:"lex",description:"Amazon Lex"},{name:"alexa-avs",description:"Alexa Voice Service"},{name:"alexa-smapi",description:"Alexa Skill Management API"},{name:"luis",description:"Microsoft LUIS"},{name:"google-assistant",description:"Google Assistant"},{name:"wechat",description:"Wechat Webhook"},{name:"webdriverio",description:"WebdriverIO (Selenium or Appium)"},{name:"rasa",description:"Rasa (Rasa RestInput channel)"},{name:"sapcai",description:"SAP Conversational AI"}],r=[{name:"docker",description:"Dockerize Facebook/Slack/Botkit Chatbot"},{name:"fbdirect",description:"Connect Live Facebook Chatbot"},{name:"webspeech",description:"Webspeech (Talk/Listen)"}];if(process.env.BOTIUMBOX_DISABLE_CONNECTORS){process.env.BOTIUMBOX_DISABLE_CONNECTORS.split(",").forEach(e=>a.findIndex(t=>t.name===e)>=0&&a.splice(a.findIndex(t=>t.name===e),1))}if(process.env.BOTIUMBOX_ENABLE_CONNECTORS){process.env.BOTIUMBOX_ENABLE_CONNECTORS.split(",").forEach(e=>{a.findIndex(t=>t.name===e)>=0||(r.findIndex(t=>t.name===e)>=0?a.push(r.find(t=>t.name===e)):a.push({name:e,value:e,description:e}))})}return a.forEach(e=>{e.value=e.name}),F.sortBy(a,"description")}};const xn=L("botium-box-server-charts-query"),{updateChartCacheForTestSession:Pn}=ys,{isLoggedIn:An,getClientIdFilter:_n,withClientFilter:$n}=dn,Dn=e=>"TODAY"===e?k().utc().startOf("day"):"LASTWEEK"===e?k().utc().subtract(6,"days").startOf("day"):"LAST2WEEKS"===e?k().utc().subtract(13,"days").startOf("day"):"LASTMONTH"===e?k().utc().subtract(30,"days").startOf("day"):"LAST2MONTHS"===e?k().utc().subtract(60,"days").startOf("day"):void 0,Mn=e=>k().utc().endOf("day"),kn=(e,t)=>{let s=Promise.resolve();return t&&t.forEach(t=>{s=s.then(()=>{if(!t.chartData)return Pn(null,{testSessionId:t.id},e).then(e=>{t.chartData=e});t.chartData=JSON.parse(t.chartData)})}),s};var jn={chartFailedCountByTestSetByDay(e,{testProjectId:t,timeFrame:s},n,a){const r=An(n),o=Dn(s||"LAST2WEEKS"),i=Mn();xn(`called chartFailedCountByTestSetByDay ${o} - ${i}`);const c=`chartFailedCountByTestSetByDay_${JSON.stringify({fromDate:o,testProjectId:t,clientId:_n(n)})}`;return n.chartsCache.get(c,()=>{const e=$n({status_in:["READY","FAILED"],createdAt_gte:k(o).toDate(),createdAt_lte:k(i).toDate(),jobs_every:{status:"READY"}},r.clients,_n(n));return t&&(e.testProject={id:t}),n.db.query.testSessions({where:e},"{ id createdAt testSets { id name } chartData }").then(e=>kn(n,e).then(()=>e)).then(e=>{if(!e)return;const t=e.filter(e=>e.chartData).reduce((e,t)=>e.concat(t.testSets.map(e=>({testSet:e,createdAt:t.createdAt,chartData:t.chartData.countByTestSetId[e.id]}))),[]).filter(e=>e.chartData),s=F.groupBy(t,e=>e.testSet.id),n={};Object.keys(s).forEach(e=>{n[e]=s[e][0].testSet.name,s[e]=F.groupBy(s[e],e=>k.utc(e.createdAt).startOf("day")),Object.keys(s[e]).forEach(t=>{const n=s[e][t];s[e][t]=Math.ceil(n.reduce((e,t)=>e+t.chartData.failedCount,0)/n.length)})});const a=[];for(const e=k(o);e.isBefore(i);e.add(1,"days"))a.push(k(e));const r=Object.keys(s).map(e=>({id:e,name:n[e],data:a.map(t=>s[e][t])}));return F.sortBy(r,"name")})})},chartFailedCountByChatbotByDay(e,{timeFrame:t},s,n){const a=An(s),r=Dn(t||"LAST2WEEKS"),o=Mn();xn(`called chartFailedCountByChatbotByDay ${r} - ${o}`);const i=`chartFailedCountByChatbotByDay_${JSON.stringify({fromDate:r,clientId:_n(s)})}`;return s.chartsCache.get(i,()=>s.db.query.testSessions($n({where:{status_in:["READY","FAILED"],createdAt_gte:k(r).toDate(),createdAt_lte:k(o).toDate(),jobs_every:{status:"READY"}}},a.clients,_n(s)),"{ id createdAt chatbot { id name } chartData }").then(e=>kn(s,e).then(()=>e)).then(e=>{if(!e)return;const t=F.groupBy(e,e=>e.chatbot.id),s={};Object.keys(t).forEach(e=>{s[e]=t[e][0].chatbot.name,t[e]=F.groupBy(t[e],e=>k.utc(e.createdAt).startOf("day")),Object.keys(t[e]).forEach(s=>{const n=t[e][s];t[e][s]=Math.ceil(n.reduce((e,t)=>e+t.chartData.failedCount,0)/n.length)})});const n=[];for(const e=k(r);e.isBefore(o);e.add(1,"days"))n.push(k(e));const a=Object.keys(t).map(e=>({id:e,name:s[e],data:n.map(s=>t[e][s])}));return F.sortBy(a,"name")}).then(e=>e.filter(e=>e.data&&e.data.filter(e=>!isNaN(e)).length>0)))},chartTestSetResultCount(e,{testProjectId:t},s,n){const a=An(s),r=`chartTestSetResultCount_${JSON.stringify({testProjectId:t,clientId:_n(s)})}`;return s.chartsCache.get(r,()=>s.db.query.testSets({orderBy:"name_ASC"},"{ id name }").then(e=>Promise.all(e.map(e=>{const n=$n({status_in:["READY","FAILED"],testSets_some:{id:e.id},jobs_every:{status:"READY"}},a.clients,_n(s));return t&&(n.testProject={id:t}),s.db.query.testSessions({where:n,orderBy:"createdAt_DESC",skip:0,first:2},"{ id createdAt chartData }").then(e=>kn(s,e).then(()=>e)).then(t=>{const s={id:e.id,name:e.name,testCaseLastTotalCount:0,testCaseLastSuccessCount:0,testCaseLastSuccessRate:0,testCasePreviousTotalCount:0,testCasePreviousSuccessCount:0,testCasePreviousSuccessRate:0,testCaseTrend:"UNKNOWN"};if(t&&t.length>0){const n=t[0].chartData.countByTestSetId[e.id];s.lastRun=t[0].createdAt,s.lastTestSessionId=t[0].id,s.testCaseLastTotalCount=n?n.totalCount:0,s.testCaseLastSuccessCount=n?n.successCount:0,s.testCaseLastSuccessRate=s.testCaseLastTotalCount===s.testCaseLastSuccessCount?100:s.testCaseLastSuccessCount/s.testCaseLastTotalCount*100}if(t&&t.length>1){const n=t[1].chartData.countByTestSetId[e.id];s.previousRun=t[1].createdAt,s.previousTestSessionId=t[1].id,s.testCasePreviousTotalCount=n?n.totalCount:0,s.testCasePreviousSuccessCount=n?n.successCount:0,s.testCasePreviousSuccessRate=s.testCasePreviousTotalCount===s.testCasePreviousSuccessCount?100:s.testCasePreviousSuccessCount/s.testCasePreviousTotalCount*100,s.testCaseLastSuccessRate>s.testCasePreviousSuccessRate?s.testCaseTrend="GOOD":s.testCaseLastSuccessRate<s.testCasePreviousSuccessRate?s.testCaseTrend="BAD":s.testCaseTrend="CONSTANT"}return s})}))).then(e=>{const t=e.filter(e=>e.testCaseLastTotalCount>0);return F.orderBy(t,"lastRun","desc")}))},chartTestProjectTrainingStatusByTestSet(e,{testProjectId:t},s,n){const a=An(s),r=`chartTestProjectTrainingStatusByTestSet_${JSON.stringify({testProjectId:t,clientId:_n(s)})}`;return s.chartsCache.get(r,async()=>{const e=$n({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},a.clients,_n(s)),n=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt testSets { id name } chartData }");return n&&0!==n.length?(await kn(s,n),n[0].testSets.forEach(e=>{const t=n[0].chartData.countByTestSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0}),F.sortBy(n[0].testSets,"name")):[]})},chartTestProjectTrainingStatusByDeviceSet(e,{testProjectId:t},s,n){const a=An(s),r=`chartTestProjectTrainingStatusByDeviceSet_${JSON.stringify({testProjectId:t,clientId:_n(s)})}`;return s.chartsCache.get(r,async()=>{const e=$n({status_in:["READY","FAILED"],testProject:{id:t},jobs_every:{status:"READY"}},a.clients,_n(s)),n=await s.db.query.testSessions({where:e,orderBy:"createdAt_DESC",skip:0,first:1},"{ id createdAt deviceSets { id name } chartData }");if(!n||0===n.length)return[];await kn(s,n);const r=n[0].deviceSets||[];r.forEach(e=>{const t=n[0].chartData.countByDeviceSetId[e.id];e.totalCount=t?t.totalCount:0,e.successCount=t?t.successCount:0,e.failedCount=t?t.failedCount:0});const o=n[0].chartData.countByDeviceSetId.NULL;return o&&r.push({id:"",name:"No Device Set",totalCount:o.totalCount,successCount:o.successCount,failedCount:o.failedCount}),F.sortBy(r,"name")})}};const Bn=e=>{const t=new Set(e?e.map(e=>e.status):[]);let s=null;if(t.has("RUNNING")?s="RUNNING":t.has("PENDING")?s="PENDING":t.has("READY")&&(s="READY"),t.has("FAILED")&&(null==s?s="FAILED":s+="/FAILED"),null===s){if(e&&e.length)throw new Error("illegal state, status cant be null");s="NO JOBS"}return s};var qn={performancetestsessions:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessions({where:t,orderBy:s,skip:n,first:a},o)),performancetestsessionssimplifiedwithstatus:(e,{where:t,orderBy:s,skip:n,first:a},r)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessions({where:t,orderBy:s,skip:n,first:a},"{ id createdAt updatedAt name description tags parallelConvoCount parallelJobCount tickRepeatInitial tickRepeatPerTick tickMaxTime tickTime dataDensity jobs {status} }").then(e=>e.map(e=>(e.status=Bn(e.jobs),delete e.jobs,e))).then(e=>e)),performancetestsession:(e,{id:t},s,n)=>s.db.query.performanceTestSession({where:{id:t}},n),performancetestsessionstatus:(e,{id:t},s)=>s.db.query.performanceTestSession({where:{id:t}},"{ id jobs {status} }").then(e=>({id:e.id,status:Bn(e.jobs)})),performancetestsessionjobs:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessionJobs({where:t,orderBy:s,skip:n,first:a},o)),performancetestsessionaggregatedresults:(e,{where:t,orderBy:s,skip:n,first:a},r,o)=>(s=s||"createdAt_DESC",n=isNaN(n)?0:n,a=isNaN(a)?100:a,r.db.query.performanceTestSessionAggregatedResults({where:t,orderBy:s,skip:n,first:a},o))};const Un=y.Strategy,{generateToken:Ln}=(L("botium-box-server-passport"),Ks);var Fn={loadStrategy:async e=>{const t=e();T.use(new Un(async(e,s,n)=>{try{const a={OR:[{name:e},{email:e}]},r=await t.db.query.users({where:a},"{ id name password email roles { id name permissions } clients { id name } }");if(!r||0===r.length)return n(null,!1,{message:`No such user found: ${e}`});const o=r[0];return o.password&&await v.compare(s,o.password)?(delete o.password,n(null,o)):n(null,!1,{message:"Invalid password."})}catch(e){return n(e)}}))},authenticate:(e,t)=>new Promise((s,n)=>{T.authenticate(t||"local",(e,t,a)=>e?n(e):t?void s({token:Ln(t),user:t}):n(new Error(a.message)))(e.request,e.response,()=>{})})};const{authenticate:Jn}=Fn;var Gn={login:async(e,{name:t,email:s,password:n},a,r)=>(a.request.body={username:t||s,password:n},"admin"===t?Jn(a,"local"):Jn(a))};const Vn=L("botium-box-server-agents-mutation"),Hn=(e,t)=>{e.forEach(e=>{const s=`agent.reconfigure.${e}`;t.queueConnector.create(s,{title:`Reconfigure Agent ${e}`}).removeOnComplete(!0).save(t=>{if(t)return Vn(`Saving reconfigure job failed: ${t}`);Vn(`Sent reconfigure job to ${e}`)})})};var Yn={async createAgent(e,{agent:t},s,n){},async updateAgent(e,{id:t,agent:s},n,a){if(!await n.db.exists.Agent({id:t}))throw new Error(`Agent not found ${t}`);const r=await n.db.mutation.updateAgent({where:{id:t},data:s},a),o=(await n.db.query.agent({where:{id:t}})).name;if("Default Agent"===o){const e=await n.db.query.agents({where:{name_not:"Default Agent"}});Hn(e.map(e=>e.name),n)}else Hn([o],n);return r},async deleteAgent(e,{id:t},s){}};const zn=L("botium-box-server-resolvers-chatbots-mutation"),{hasPermission:Wn}=cn,{isLoggedIn:Xn,getClientIdFilter:Kn,withClientConnect:Qn}=dn,{getChatbotCapabilities:Zn}=ue,{importDialogflowIntents:ea,importDialogflowConversations:ta}=b.Utils,{importAlexaIntents:sa}=E.Utils,{importWatsonIntents:na}=w.Utils,aa=async(e,t,s,n,a)=>{const r=Xn(n),{caps:o}=await Zn(e,n.db,n.queueSettings);let i=null;if(s.name){if(!Wn(r,"TESTSETS_CREATE"))throw new Error("Missing permission TESTSETS_CREATE");i=await n.db.mutation.createTestSet({data:Qn(s,r.clients,Kn(n))},"{ id name }")}else i=await n.db.query.testSet({where:{id:t}},"{ id name }");zn(`importDialogflowIntents importing to test set ${i.id}/${i.name}`);const{convos:c,utterances:d,compiler:l}=await a(o);if(l)for(const e of c||[]){const t=l.Decompile([e],"SCRIPTING_FORMAT_TXT");await n.db.mutation.createTestSetScript({data:{name:e.header.name,script:t,scriptType:"SCRIPTING_TYPE_CONVO",testSet:{connect:{id:i.id}}}},"{ id }")}for(const e of d||[]){const t=[e.name,...e.utterances].join("\n");await n.db.mutation.createTestSetScript({data:{name:e.name,script:t,scriptType:"SCRIPTING_TYPE_UTTERANCES",testSet:{connect:{id:i.id}}}},"{ id }")}return i.id};var ra={createChatbot:async(e,{chatbot:t},s,n)=>s.db.mutation.createChatbot({data:{...t}},n),async updateChatbot(e,{id:t,chatbot:s},n,a){if(!await n.db.exists.Chatbot({id:t}))throw new Error(`Chatbot not found ${t}`);return n.db.mutation.updateChatbot({where:{id:t},data:{...s}},a)},deleteChatbot:async(e,{id:t},s)=>(await s.db.mutation.deleteChatbot({where:{id:t}},"{id}"),!0),async importFromDialogflow(e,{chatbotId:t,testSetId:s,newTestSetName:n,importer:a},r){const o={name:n,expandConvos:!0,expandConvosMode:"UTTEXPANSION_MODE_ALL",expandUtterancesToConvos:!1,useScriptingMemory:!1,expandScriptingMemory:!1};return"importDialogflowIntents"===a?aa(t,s,o,r,async e=>{const{convos:t,utterances:s,botiumContext:{compiler:n}}=await ea(null,e);return{convos:t,utterances:s,compiler:n}}):"importDialogflowConversations"===a?aa(t,s,o,r,async e=>{const{convos:t,utterances:s,botiumContext:{compiler:n}}=await ta(null,e);return{convos:t,utterances:s,compiler:n}}):null},importFromAlexa:async(e,{chatbotId:t,testSetId:s,newTestSetName:n,buildconvos:a,expandcustomslots:r,expandbuiltinslots:o,expandbuiltinslotsid:i,slotsamples:c,invocation:d},l)=>aa(t,s,{name:n,expandConvos:!!a,expandConvosMode:"UTTEXPANSION_MODE_ALL",expandUtterancesToConvos:!a,useScriptingMemory:!1,expandScriptingMemory:!1},l,async e=>{const{convos:t,utterances:s,compiler:n}=await sa({caps:e,buildconvos:!!a,expandcustomslots:!!r,expandbuiltinslots:!!o,expandbuiltinslotsid:i,slotsamples:c&&JSON.parse(c),invocation:d});return{convos:t,utterances:s,compiler:n}}),importFromWatson:async(e,{chatbotId:t,testSetId:s,newTestSetName:n,buildconvos:a},r)=>aa(t,s,{name:n,expandConvos:!!a,expandConvosMode:"UTTEXPANSION_MODE_ALL",expandUtterancesToConvos:!a,useScriptingMemory:!1,expandScriptingMemory:!1},r,async e=>{const{convos:t,utterances:s,compiler:n}=await na({caps:e,buildconvos:!!a});return{convos:t,utterances:s,compiler:n}})};const oa=Es.createTestSession,ia=L("botium-box-server-mutation-testproject"),ca=(e,t,s,n)=>{void 0===t.securityCheck&&(t.securityCheck=!1);const a={testSession:Object.assign({},{status:"PENDING",chatbot:{connect:{id:t.chatbot.id}},testSets:{connect:t.testSets&&t.testSets.map(e=>({id:e.id}))},deviceSets:{connect:t.deviceSets&&t.deviceSets.map(e=>({id:e.id}))},registeredComponents:{connect:t.registeredComponents&&t.registeredComponents.map(e=>({id:e.id}))},securityCheck:t.securityCheck,testProject:{connect:{id:t.id}},batchCount:t.batchCount,bail:t.bail},s)};return t.client&&(a.testSession.client={connect:{id:t.client.id}}),t.agent&&(a.testSession.agent={connect:{id:t.agent.id}}),oa(e,a,n,"{ id testSets { id } }")},da=async(e,t)=>{e.batchCount=1};var la={createTestProject:async(e,{testProject:t},s,n)=>(await da(t),s.db.mutation.createTestProject({data:{...t,code:U(t.name)}},n)),async startTestProject(e,{id:t,code:s},n){const a=await n.db.query.testProject({where:{id:t,code:s}},"{ id name securityCheck client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount bail }");if(!a)throw new Error(`Test Project ${t}/${s} not found`);return ca(e,a,{name:a.name+" - Test Session",tags:{set:["BoxTriggered"]}},n)},quickstartTestProject:async(e,{testProject:t,startProject:s},n)=>(await da(t),n.db.mutation.createTestProject({data:{...t,code:U(t.name)}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount bail }").then(t=>s?ca(e,t,{name:t.name+" - Initial Test Session",tags:{set:["QuickStart"]}},n).then(e=>e.id):t.id)),async updateTestProject(e,{id:t,testProject:s},n,a){if(!await n.db.exists.TestProject({id:t}))throw new Error(`TestProject not found ${t}`);return n.db.mutation.updateTestProject({where:{id:t},data:{...s,code:U(s.name)}},a)},deleteTestProject:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.mutation.deleteTestProject({where:{id:t}},"{id}").then(()=>e(!0)).catch(e=>(ia(`Error deleting TestProject ${t}: ${e}`),n(e)))})},ua=re(function(e){const t=L("botium-box-server-mutation-settings");let s=["LOCALSELENIUM"];const n=async e=>{const t=I.sign({},process.env.PRISMA_SECRET),s={uri:process.env.PRISMA_ENDPOINT+"/import",method:"POST",headers:{Authorization:`Bearer ${t}`},json:!0,body:e},n=await M(s);if(n&&n.length>0)throw new Error(n.join("\r\n"))},a=async(e,t)=>{const s=e.mutation[t.mutation];await s({data:t.data})};e.exports={createUser:async(e,{user:t},s,n)=>(t.password&&(t.password=await v.hash(t.password,10)),s.db.mutation.createUser({data:t},n)),async updateUser(e,{id:t,user:s},n,a){const r=await n.db.query.user({where:{id:t}});if(!r)throw new Error(`User not found ${t}`);return s.password&&(s.password=await v.hash(s.password,10)),"admin"===r.name&&(s.name="admin",s.roles={connect:[{name:"ADMIN"}]}),n.db.mutation.updateUser({where:{id:t},data:s},a)},async deleteUser(e,{id:s},n){const a=await n.db.query.user({where:{id:s}});if(!a)return!0;if("admin"===a.name)throw new Error('Not allowed to delete user "admin"');return n.db.mutation.deleteUser({where:{id:s}},"{id}").then(()=>!0).catch(e=>{throw t(`Error deleting User ${s}: ${e}`),e})},createApiKey:async(e,{apiKey:t},s,n)=>(t.key=C("Aa0",20),s.db.mutation.createApiKey({data:t},n)),async updateApiKey(e,{id:t,apiKey:s},n,a){if(!await n.db.exists.ApiKey({id:t}))throw new Error(`ApiKey not found ${t}`);return delete s.key,n.db.mutation.updateApiKey({where:{id:t},data:s},a)},deleteApiKey:async(e,{id:s},n)=>n.db.mutation.deleteApiKey({where:{id:s}},"{id}").then(()=>!0).catch(e=>{throw t(`Error deleting ApiKey ${s}: ${e}`),e}),async createDeviceProvider(e,{deviceProvider:t},n,a){if("INTEGRATED"===t.type)throw new Error("DeviceProvider type INTEGRATED not allowed to create");if(s.indexOf(t.type)<0)throw new Error(`DeviceProvider type ${t.type} not supported in this version`);return n.db.mutation.createDeviceProvider({data:t},a)},async updateDeviceProvider(e,{id:t,deviceProvider:n},a,r){if(!await a.db.exists.DeviceProvider({id:t}))throw new Error(`DeviceProvider not found ${t}`);if(s.indexOf(n.type)<0)throw new Error(`DeviceProvider type ${n.type} not supported in this version`);const o=await a.db.mutation.updateDeviceProvider({where:{id:t},data:n},r);return delete o.password,o},async deleteDeviceProvider(e,{id:s},n){const a=await n.db.query.deviceProvider({where:{id:s}});if(!a)return!0;if("INTEGRATED"===a.type)throw new Error("DeviceProvider type INTEGRATED not allowed to delete");try{return await n.db.mutation.deleteDeviceProvider({where:{id:s}},"{id}"),!0}catch(e){throw t(`Error deleting DeviceProvider ${s}: ${e}`),e}},createRegisteredComponent:async(e,{registeredComponent:t},s,n)=>s.db.mutation.createRegisteredComponent({data:t},n),async updateRegisteredComponent(e,{id:t,registeredComponent:s},n,a){if(!await n.db.exists.RegisteredComponent({id:t}))throw new Error(`RegisteredComponent not found ${t}`);return n.db.mutation.updateRegisteredComponent({where:{id:t},data:s},a)},deleteRegisteredComponent:async(e,{id:s},n)=>n.db.mutation.deleteRegisteredComponent({where:{id:s}},"{id}").then(()=>!0).catch(e=>{throw t(`Error deleting RegisteredComponent ${s}: ${e}`),e}),async updateSystemSettings(e,{systemSettings:t},s,n){const a=await s.db.query.systemSettingses({skip:0,first:1});return a&&a.length>0?s.db.mutation.updateSystemSettings({where:{id:a[0].id},data:t},n):s.db.mutation.createSystemSettings({data:t},n)},async importPrisma(e,{prismaFile:s},r,o){let i=null;try{i=JSON.parse(s)}catch(e){}if(i)if(i.valueType){t("Found valueType field in JSON, trying to import NDF to Prisma.");try{return await n(i),t("Prisma import ndf success"),!0}catch(e){throw t(`Prisma import ndf failed: ${e}`),e}}else if(i.mutation){t(`Found mutation field in JSON, trying to import with Prisma mutation ${i.mutation}.`);try{return await a(r.db,i),t("Prisma import JSON success"),!0}catch(e){throw t(`Prisma import JSON failed: ${e}`),e}}let c=null;try{c=new _(Buffer.from(s,"base64"))}catch(e){t(`Cant open ZIP input: ${e}`)}if(c){const e=c.getEntries().filter(e=>e.entryName.endsWith(".ndf")||e.entryName.endsWith(".json")).map(async e=>{let s=null;try{s=JSON.parse(e.getData().toString("utf8"))}catch(s){throw t(`Prisma get JSON from file ${e.entryName} failed: ${s}`),s}if(s.valueType){t(`Found valueType field in file ${e.entryName}, trying to import NDF to Prisma.`);try{return await n(s),t(`Prisma import ndf from file ${e.entryName} success`),!0}catch(s){throw t(`Prisma import ndf from file ${e.entryName} failed: ${s}`),s}}else{if(!s.mutation)return t(`Found no mutation and no valueType field in file ${e.entryName}, ignored.`),!0;t(`Found mutation field in file ${e.entryName}, trying to import with Prisma mutation ${s.mutation}.`);try{return await a(r.db,s),t("Prisma import JSON success"),!0}catch(e){throw t(`Prisma import JSON failed: ${e}`),e}}});try{return await Promise.all(e),!0}catch(e){throw e}}throw new Error("Input not an NDF and not a ZIP file")},async importPrismaFromUrl(s,{prismaUrl:n},a,r){let o=null;try{t(`Download import file from ${n}.`),o=await M(n)}catch(e){throw t(`Download from url ${n} failed: ${e}`),e}return e.exports.importPrisma(s,{prismaFile:o},a,r)}}});ua.createUser,ua.updateUser,ua.deleteUser,ua.createApiKey,ua.updateApiKey,ua.deleteApiKey,ua.createDeviceProvider,ua.updateDeviceProvider,ua.deleteDeviceProvider,ua.createRegisteredComponent,ua.updateRegisteredComponent,ua.deleteRegisteredComponent,ua.updateSystemSettings,ua.importPrisma,ua.importPrismaFromUrl;const pa=L("botium-box-server-mutation-deviceset");var Sa={createDeviceSet:async(e,{deviceSet:t},s,n)=>s.db.mutation.createDeviceSet({data:t},n),async updateDeviceSet(e,{id:t,deviceSet:s},n,a){if(!await n.db.exists.DeviceSet({id:t}))throw new Error(`DeviceSet not found ${t}`);return n.db.mutation.updateDeviceSet({where:{id:t},data:s},a)},deleteDeviceSet:async(e,{id:t},s)=>new Promise((e,n)=>{s.db.query.deviceSet({where:{id:t}},"{ id devices { id } }").then(e=>{if(!e)throw new Error(`DeviceSet not found ${t}`);return s.db.mutation.deleteManyDeviceDescriptors({where:{id_in:e.devices.map(e=>e.id)}})}).then(()=>s.db.mutation.deleteDeviceSet({where:{id:t}},"{id}")).then(()=>e(!0)).catch(e=>(pa(`Error deleting DeviceSet ${t}: ${e}`),n(e)))})},ha={createPerformanceTestSession:async(e,{testProjectId:t,options:s},n,a)=>n.db.query.testProject({where:{id:t}},"{ id name client { id } chatbot { id } testSets { id } deviceSets { id } agent { id } registeredComponents { id } batchCount }").then(e=>{if(!e)throw Error(`Test project not found by id ${t}`);const a=Object.assign({},s,{chatbot:{connect:{id:e.chatbot.id}},testSets:{connect:e.testSets&&e.testSets.map(e=>({id:e.id}))},registeredComponents:{connect:e.registeredComponents&&e.registeredComponents.map(e=>({id:e.id}))},testProject:{connect:{id:e.id}}});return e.client&&(a.client={connect:{id:e.client.id}}),n.db.mutation.createPerformanceTestSession({data:a},"{id name}")}).then(e=>new Promise((t,s)=>{n.queueConnector.create("box.createperformanceprocessingjobs",{title:`Job Creation Job for Test Session ${e.name}`,performanceTestSessionId:e.id}).removeOnComplete(!0).save(n=>{if(n)return s(n);t(e.id)})})),deletePerformanceTestSession:async(e,{id:t},s)=>s.db.mutation.deletePerformanceTestSession({where:{id:t}},"{id}").then(()=>!0)};var ma={};const{withFilter:fa}=O;var Ta={testSessionProgress:{resolve:(e,{testSessionId:t},s,n)=>s.db.query.testSession({where:{id:t}},n),subscribe:fa((e,{testSessionId:t},{pubsub:s})=>s.asyncIterator("TEST_SESSION_PROGRESS"),(e,{testSessionId:t})=>e&&e.testSessionProgress&&e.testSessionProgress.id===t)}},ya={Query:{...sn,...nn,...rn,...wn,...vn,...qt,...On,...Rn,...Nn,...jn,...qn},Mutation:{...Gn,...Yn,...ra,...Cn,...Es,...Gt,...la,...ua,...Sa,...ha},Subscription:{...ma,...En,...Ta}};const{SchemaDirectiveVisitor:ga}=R,{defaultFieldResolver:ba}=N,{hasPermission:Ea,hasAnyPermission:wa}=cn,{isLoggedIn:Ca,getClientIdFilter:va,withClientConnect:Ia,withClientFilter:Oa,assertClient:Ra}=dn,{isOperable:Na}=ee,xa=L("botium-box-server-directives");var Pa={hasAnyPermission:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{permissions:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=Ca(a);if(wa(o,s))return t.call(this,e,n,a,r);throw xa(`User ${JSON.stringify(o)} missing any permissions ${s.join("|")}`),new Error(`Unauthorized, missing any permissions ${s.join("|")}`)})}},hasPermission:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{permission:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=Ca(a);if(Ea(o,s))return t.call(this,e,n,a,r);throw xa(`User ${JSON.stringify(o)} missing permission ${s}`),new Error(`Unauthorized, missing permission ${s}`)})}},clientFilter:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e;e.resolve=(async(e,{where:s,...n},a,r)=>{const o=Ca(a),i=Oa(s,o.clients,va(a));return t.call(this,e,{where:i,...n},a,r)})}},assertClient:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{query:s,argsBase:n,idParam:a,selector:r}=this.args,o=e=>e&&e.client?e.client.id:e&&Object.keys(e).length>0?o(e[Object.keys(e)[0]]):null;e.resolve=(async(e,i,c,d)=>{const l=Ca(c),u=F.isArray(s)?s:[s],p=n&&(F.isArray(n)?n:[n]),S=a&&(F.isArray(a)?a:[a]),h=r&&(F.isArray(r)?r:[r]);for(let e in u){const t=p?F.get(i,p[e]):i;if(t)for(const s of F.isArray(t)?t:[t]){const t=F.get(s,S&&S[e]||"id");if(!t)continue;const n=await c.db.query[u[e]]({where:{id:t}},h&&h[e]||"{ client { id } }"),a=o(n);try{Ra(a,l.clients)}catch(s){throw xa(`User ${JSON.stringify(l)} missing client access, query ${u[e]}, id ${t}, clientId ${a}`),s}}}return t.call(this,e,i,c,d)})}},clientConnector:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{dataParam:s}=this.args,n=F.isArray(s)?s:[s];e.resolve=(async(e,s,a,r)=>{const o=Ca(a);return n.forEach(e=>{const t=F.get(s,e);if(!t)return;const n=va(a);for(const e of F.isArray(t)?t:[t])Ia(e,o.clients,n)}),t.call(this,e,s,a,r)})}},clientDisconnector:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{dataParam:s}=this.args;e.resolve=(async(e,n,a,r)=>{const o=n[s];return o&&o.client&&delete o.client,t.call(this,e,n,a,r)})}},tagsResolver:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e,{dataParam:s,field:n}=this.args;e.resolve=(async(e,a,r,o)=>{const i=a[s][n||"tags"];if(i&&i.set)for(const e of i.set)await r.db.query.tag({where:{name:e}})||(await r.db.mutation.createTag({data:{name:e}}),xa(`Added new tag to tag suggestion list: ${e}`));return t.call(this,e,a,r,o)})}},licenseOperable:class extends ga{visitFieldDefinition(e){const{resolve:t=ba}=e;e.resolve=(async(e,s,n,a)=>{if(Na())return t.call(this,e,s,n,a);throw new Error("Unauthorized, license not operable.")})}}};const{jwtSettings:Aa,tokenToUserId:_a}=Ks,$a=L("botium-box-middleware-jwt");let Da=null;var Ma=(e,t,s)=>{e.use((()=>x(Object.assign({},Aa(),{credentialsRequired:!1,getToken:e=>e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0]?e.headers.authorization.split(" ")[1]:e.query&&e.query.token?e.query.token:e.body&&e.body.token?e.body.token:null})))()),e.use((e,t,n)=>(async(e,t,s,n)=>{if(e.user){const t=n({request:e}),a=e.user,r=await t.db.query.user({where:{id:_a(a)}},"{ id name email roles { id name permissions } clients { id name } }");return e.user={...r,token:a},s()}if(process.env.JWT_AUTOLOGIN_USERNAME){if(!Da){const t=n({request:e});Da=await t.db.query.user({where:{name:process.env.JWT_AUTOLOGIN_USERNAME}},"{ id name email roles { id name permissions } clients { id name } }"),$a(`Auto login user ${process.env.JWT_AUTOLOGIN_USERNAME}.`)}return e.user={...Da,token:null},s()}return s()})(e,0,n,s)),e.use((e,t,n)=>(async(e,t,s,n)=>{const a=e.query.APIKEY||e.query.apikey||e.body&&e.body.APIKEY||e.body&&e.body.apikey||e.headers.APIKEY||e.headers.apikey,r=n({request:e});if(!a)return s();ue.lookupApiKey(r.db,a).then(t=>t?($a(`Api Key found - ${t.name}`),e.apiKey=t,s()):($a(`Api Key not found - ${a}`),s())).catch(e=>($a(`Api Key lookup error - ${a} - ${e}`),s()))})(e,0,n,s))};const{setupEndpoints:ka,verifySignature:ja}=A,Ba=L("botium-box-server-fbproxy");const qa=L("botium-box-server-endpoints-testset"),{isLoggedIn:Ua,assertClient:La}=dn,{FindFullTestSet:Fa}=ae;const Ja=L("botium-box-server-endpoints-attachments"),{isLoggedIn:Ga,assertClient:Va}=dn;const Ha=L("botium-box-server-endpoints-build"),{isLoggedIn:Ya,assertClient:za}=dn,Wa=Es.createTestSession,Xa=e=>{if(!e)return"";return e.split("\n").map(e=>e.trim()).join("     ")},Ka=(e,t)=>e.query[t]||e.query[t.toLowerCase()]||e.body&&e.body[t]||e.body&&e.body[t.toLowerCase()]||e.headers[`X-BOTIUM-${t}`],Qa=(e,t)=>{const s=(Ka(e,"REPORTER")||"json").toLowerCase();return"json"===s||"junit"===s||"csv"===s||"jiracsv"===s||"pdf"===s||(t.sendStatus(404).send("VALID REPORTER OPTIONS: json, junit, csv, jiracsv, pdf"),!1)},Za=(e,t)=>{return e.map(e=>`"${e.map(e=>F.isString(e)&&e.replace(/"/g,'""')).join(`"${t||";"}"`)}"`).join("\r\n")},er=async(e,t,s,n)=>{if(s.timedout)Ha("HTTP Request for Test Session {$id} timed out. Not sending response.");else try{const a=(Ka(s,"REPORTER")||"json").toLowerCase();if("json"===a){const{ts:s,output:r}=await sr(e,t,a);n.setHeader("Content-Type","application/json"),n.setHeader("Content-disposition",`attachment; filename="${U(s.name)}.json"`),n.status(200).send(r)}else if("junit"===a){const{ts:s,output:r}=await sr(e,t,a);n.setHeader("Content-Type","text/xml"),n.setHeader("Content-disposition",`attachment; filename="${U(s.name)}.xml"`),n.status(200).send(r)}else if("csv"===a||"jiracsv"===a){const{ts:s,output:r}=await sr(e,t,a);n.setHeader("Content-Type","text/csv"),n.setHeader("Content-disposition",`attachment; filename="${U(s.name)}.csv"`),n.status(200).send(r)}else if("pdf"===a){const{ts:s,output:r}=await sr(e,t,a);n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-disposition",`attachment; filename=${U(s.name)}.pdf`),n.status(200).send(r)}}catch(t){Ha(`Test Session lookup error - ${e} - ${t}`),n.sendStatus(404)}},tr=async(e,t,s,n,a)=>{try{const r=(a||"json").toLowerCase(),o={uri:s,method:n,headers:{}};if("get"!==n.toLowerCase()){const{output:s}=await sr(e,t,r);"json"===r?(o.body=s,o.json=!0):"junit"===r?(o.headers["Content-Type"]="text/xml",o.body=s):"csv"===r||"jiracsv"===r?(o.headers["Content-Type"]="text/csv",o.body=s):"pdf"===r&&(o.headers["Content-Type"]="application/pdf",o.body=s)}await M(o),Ha(`sendTestSessionOutput callbackUrl ${s} ready for test session ${e}`)}catch(t){Ha(`sendTestSessionOutput callbackUrl ${s} failed for test session ${e} - ${t}`)}},sr=async(e,t,s)=>{const n=await ue.findSimpleTestSessionResults(t.db,e);if(!n)throw new Error(`Test Session ${e} not found`);let a=`${t.request.protocol}://${t.request.headers.host}/testsessions/view/${e}`;if("json"===s)return delete n.results,n.link=a,{ts:n,output:n};if("pdf"===s){const s=await ue.findFullTestSession(t.db,e),r=await ue.extractAllInvolvedTestSets(t,s.testSets),o=new B({bufferPages:!0,margins:{top:50,bottom:50,left:72,right:72}});o.reset=(()=>o.font("Helvetica").fontSize(12).fillColor("black")),o.bold=(()=>o.font("Helvetica-Bold")),o.fontSize(25).text(s.name,{underline:!0}).reset(),o.text(`Test Session Started: ${k(s.createdAt).format("lll")}`),o.fillColor("blue").text("Results in botium box").underline(72,90,115,15,{color:"#0000FF"}).link(72,90,115,15,a).reset().moveDown(),"READY"===n.status&&o.fillColor("green").fontSize(25).bold().text("TEST SESSION OK").reset(),"FAILED"===n.status&&o.fillColor("red").fontSize(25).bold().text("TEST SESSION FAILED").reset(),o.text(`${n.results.length} Test Case(s)`),o.fillColor("green").text(`${n.results.filter(e=>e.success).length} Test Case(s) succeeded`).reset(),o.fillColor("red").text(`${n.results.filter(e=>!e.success).length} Test Case(s) failed`).reset(),s.testProject&&(o.moveDown(),o.font("Helvetica-Bold").text(`Test Project: ${s.testProject.name}`).reset(),s.testProject.description&&o.text(s.testProject.description),s.testProject.tags&&o.fillColor("darkgrey").text(s.testProject.tags.join(" | ")).reset()),s.chatbot&&(o.moveDown(),o.font("Helvetica-Bold").text(`Chatbot Under Test: ${s.chatbot.name}`).reset(),s.chatbot.description&&o.text(s.chatbot.description),s.chatbot.tags&&o.fillColor("darkgrey").text(s.chatbot.tags.join(" | ")).reset()),r&&r.forEach(e=>{o.moveDown(),o.font("Helvetica-Bold").text(`Test Set: ${e.name}`).reset(),e.description&&o.text(e.description),e.scripts&&o.text(`Scripts: ${e.scripts.length}`),e.repositories&&e.repositories.forEach(e=>{o.text(`Repository: ${e.name}, ${e.gitbranch}`)}),e.folders&&e.folders.forEach(e=>{o.text(`Shared Folder: ${e.name}`)}),e.excels&&e.excels.forEach(e=>{o.text(`Excel File: ${e.name}, ${e.filename}`)}),e.tags&&o.fillColor("darkgrey").text(e.tags.join(" | ")).reset()});const i=o.bufferedPageRange();for(let e=i.start;e<i.start+i.count;e++)o.switchToPage(e),o.fontSize(8),o.image("media/botium-logo.png",o.page.width-50,15,{width:35}),o.text(`${s.name}, page ${e+1} of ${i.count}`,200,o.page.height-40,{height:25});return o.end(),new Promise(e=>{o.pipe(q(t=>e({ts:n,output:t})))})}if("junit"===s){const e=F.groupBy(n.results,e=>e.testSet?e.testSet.name:""),t=F.keys(e).map(t=>{const s=e[t];return{testsuite:[{_attr:{name:t||"unnamed",link:a,tests:s.length,failures:s.filter(e=>!e.success).length,time:s.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}]}}),s=j({testsuites:[{_attr:{name:n.name,link:a,tests:n.results.length,failures:n.results.filter(e=>!e.success).length,time:n.results.reduce((e,t)=>t.duration?e+t.duration:e,0)/1e3}}].concat(t)},{declaration:!0});return{ts:n,output:s}}if("csv"===s){delete n.results;const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseSource","testCaseSuccess","testCaseErr","testCaseDuration","testSetId","testSetName","testSetTags","testSetRepository","testSetRepositoryBranch","testSetFolder","testSetExcel","testSetFilename",`=HYPERLINK("${a}")`]);const t=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(Xa(t.testcaseSource)),e.push(t.success),e.push(Xa(t.err)),e.push(t.duration),t.testSet?(e.push(t.testSet.id),e.push(t.testSet.name),e.push(t.testSet.tags&&t.testSet.tags.join("|")),t.testSetRepository?(e.push(t.testSetRepository.name),e.push(t.testSetRepository.gitbranch)):e.push(null,null),t.testSetFolder?e.push(t.testSetFolder.name):e.push(null),t.testSetExcel?e.push(t.testSetExcel.name):e.push(null),e.push(t.testSetFilename)):e.push(null,null,null,null,null,null,null,null)):e.push(null,null,null,null,null,null,null,null,null,null,null,null,null,null)},s=[n.id,n.status,n.name];return n.results&&n.results.length>0?n.results.forEach(n=>{const a=s.slice(0);t(a,n),e.push(a)}):(t(s,null),e.push(s)),{ts:n,output:Za(e)}}if("jiracsv"===s){const e=[];return e.push(["Build","Date","Summary","Description"]),"FAILED"!==n.status&&e.push([n.name,n.createdAt,`${n.name}: Botium Test Session failed`,`${n.results.filter(e=>!e.success).length} Test Cases failed of ${n.results.length} Link to Botium box results: ${a}`]),{ts:n,output:Za(e,",")}}},nr=(e,t,s)=>{const n=t.pubsub.asyncIterator("TEST_SESSION_PROGRESS");!async function(){for(;;){const{value:a}=await n.next();if(a.testSessionProgress&&a.testSessionProgress.id===e){const n=await t.db.query.testSession({where:{id:e}},"{ id status }");if(Ha(`Test Project ${e} got status: ${n.status}`),"READY"===n.status)return s();if("FAILED"===n.status)return s()}}}()},ar=(e,t,s,n)=>{const a=Ka(s,"WAIT");"READY"!==e.status&&"FAILED"!==e.status&&"1"===a?nr(e.id,t,()=>er(e.id,t,s,n)):er(e.id,t,s,n)},rr=(e,t,s)=>{const n=Ka(s,"CALLBACKURL"),a=Ka(s,"CALLBACKMETHOD")||"POST",r=Ka(s,"REPORTER");n&&("READY"!==e.status&&"FAILED"!==e.status?nr(e.id,t,()=>tr(e.id,t,n,a,r)):tr(e.id,t,n,a,r))};var or=(e,t,s)=>{const n=(e,t)=>{(({ctxFactory:e,testProjectCode:t,req:s,res:n})=>{if(!Qa(s,n))return;const a=e({request:s}),r=Ya(a);a.db.query.testProject({where:{code:t}},"{ id name chatbot { id } testSets { id } deviceSets { id } agent { id } batchCount client { id } }").then(e=>{if(!e)throw new Error(`Test Project ${t} not found`);const n=F.get(e,"client.id");za(n,r.clients);const o=Ka(s,"BUILDID"),i=Ka(s,"BUILDCOMMENT"),c=Ka(s,"TAG"),d=e=>Object.keys(e).reduce((t,s)=>(t.push({name:s,type:"STRING",stringValue:e[s]}),t),[]),l=s.body&&s.body.CAPS&&d(s.body.CAPS)||[],u=s.body&&s.body.SOURCES&&d(s.body.SOURCES)||[],p=s.body&&s.body.ENVS&&d(s.body.ENVS)||[],S={name:o||e.name+" - Test Session",description:i,status:"PENDING",tags:{set:c?F.isArray(c)?c:[c]:[]},chatbot:{connect:{id:e.chatbot.id}},testSets:{connect:e.testSets&&e.testSets.map(e=>({id:e.id}))},deviceSets:{connect:e.deviceSets&&e.deviceSets.map(e=>({id:e.id}))},testProject:{connect:{id:e.id}},capabilities:{create:l},sources:{create:u},envs:{create:p},batchCount:e.batchCount,bail:e.bail};return e.agent&&(S.agent={connect:{id:e.agent.id}}),Ha(`Creating Test Session ${JSON.stringify(S,null,2)}`),Wa(null,{testSession:S},a,"{ id status }")}).then(e=>{ar(e,a,s,n),rr(e,a,s)}).catch(e=>{Ha(`Test Project start error - ${t} - ${e}`),n.sendStatus(404)})})({testProjectCode:e.params.code,ctxFactory:s,req:e,res:t})};e.post("/api/triggerbuild/:code",...t,n),e.get("/api/triggerbuild/:code",...t,n),e.get("/api/build/:nameOrId",...t,(e,t)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{if(!Qa(s,n))return;const a=e({request:s}),r=Ya(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name status client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],o=F.get(t,"client.id");za(o,r.clients),ar(t,a,s,n),rr(t,a,s)}).catch(e=>{Ha(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:s,req:e,res:t})}),e.get("/api/log/:nameOrId",...t,(e,t)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{const a=e({request:s}),r=Ya(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name jobs { id logs { createdAt log } } client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],s=F.get(t,"client.id");za(s,r.clients),n.set("Content-Type","text/plain"),t.jobs&&t.jobs.forEach(e=>{n.write(`Job Output (${e.id})\n`),e.logs&&e.logs.forEach(e=>{n.write(e.createdAt+": "+e.log+"\n")}),n.write("\n\n"),n.write("##############################################################\n"),n.write("##############################################################\n"),n.write("##############################################################\n"),n.write("\n\n")}),n.status(200).end()}).catch(e=>{Ha(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:s,req:e,res:t})}),e.get("/api/joblog/:id",...t,(e,t)=>{(({ctxFactory:e,id:t,req:s,res:n})=>{const a=e({request:s}),r=Ya(a);a.db.query.testSessionJob({where:{id:t},orderBy:"createdAt_ASC"},"{ id logs { order createdAt log } testSession { client { id } } }").then(e=>{if(!e)return n.sendStatus(404);const t=F.get(e,"testSession.client.id");za(t,r.clients),n.set("Content-Type","text/plain"),e.logs&&F.sortBy(e.logs,"order").forEach(e=>{n.write(e.createdAt+": "+e.log.trim()+"\n")}),n.status(200).end()}).catch(e=>{Ha(`Test Session Job lookup error - ${t} - ${e}`),n.sendStatus(404)})})({id:e.params.id,ctxFactory:s,req:e,res:t})}),e.get("/api/transcript/:nameOrId",...t,(e,t)=>{(({ctxFactory:e,nameOrId:t,req:s,res:n})=>{const a=e({request:s}),r=Ya(a);a.db.query.testSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id status name client { id } results { id testcaseName createdAt success err duration steps { step expected not actual stepDuration botDuration err } } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],a=F.get(t,"client.id");za(a,r.clients);const o=Ka(s,"REPORTER")||"json";if(delete t.results,t.results&&t.results.forEach(e=>{e.steps&&e.steps.forEach(e=>{e.actual&&F.isString(e.actual)&&(e.actual=JSON.parse(e.actual)),e.expected&&F.isString(e.expected)&&(e.expected=JSON.parse(e.expected))})}),"json"===o)n.setHeader("Content-disposition",`attachment; filename="${U(t.name)}.json"`),n.status(200).send(t);else if("csv"===o){const e=[];e.push(["testSessionId","testSessionStatus","testSessionName","testCaseId","testCaseName","testCaseCreatedAt","testCaseSuccess","testCaseErr","testCaseDuration","convoStepIndex","convoStepSender","convoStepActual","convoStepNot","convoStepExpected","convoStepDuration","convoStepBotDuration","convoStepErr"]);const s=(e,t)=>{t?(e.push(t.id),e.push(t.testcaseName),e.push(t.createdAt),e.push(t.success),e.push(Xa(t.err)),e.push(t.duration)):e.push(null,null,null,null,null,null)},a=e=>{if("me"===e.sender){if(e.buttons&&e.buttons.length>0)return`BUTTON ${e.buttons[0].payload||e.buttons[0].text}`;if(e.media&&e.media.length>0)return`MEDIA ${e.media[0].mediaUri}`}return e.messageText},r=(e,t)=>{t?(e.push(t.step),e.push(t.actual&&t.actual.sender),e.push(t.actual&&Xa(a(t.actual))),e.push(t.not),e.push(t.expected&&Xa(a(t.expected))),e.push(t.stepDuration),e.push(t.botDuration),e.push(Xa(t.err))):e.push(null,null,null,null,null,null,null,null)},o=[t.id,t.status,t.name];t.results&&t.results.length>0?t.results.forEach(t=>{const n=o.slice(0);s(n,t),t.steps&&t.steps.length>0?t.steps.forEach(t=>{const s=n.slice(0);r(s,t),e.push(s)}):(r(n,null),e.push(n))}):(s(o,null),r(o,null),e.push(o));const i=Za(e);n.setHeader("Content-disposition",`attachment; filename="${U(t.name)}.csv"`),n.status(200).send(i)}else n.sendStatus(404).send("VALID REPORTER OPTIONS: json, csv");n.status(200).end()}).catch(e=>{Ha(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})})({nameOrId:e.params.nameOrId,ctxFactory:s,req:e,res:t})})};const ir=L("botium-box-server-endpoints-performancebuild"),{isLoggedIn:cr,assertClient:dr}=dn,lr=(e,t)=>{return e.map(e=>`"${e.map(e=>F.isString(e)?e.replace(/"/g,'""'):e).join(`"${t||";"}"`)}"`).join("\r\n")},ur=(e,t)=>e.query[t]||e.query[t.toLowerCase()]||e.body&&e.body[t]||e.body&&e.body[t.toLowerCase()]||e.headers[`X-BOTIUM-${t}`],pr=({ctxFactory:e,nameOrId:t,req:s,res:n})=>{if(!((e,t)=>{const s=(ur(e,"REPORTER")||"json").toLowerCase();return"json"===s||"csv"===s||(t.sendStatus(404).send("VALID REPORTER OPTIONS: json, csv"),!1)})(s,n))return;const a=e({request:s}),r=cr(a);a.db.query.performanceTestSessions({where:{OR:[{id:t},{name:t}]},orderBy:"createdAt_DESC",first:1},"{ id name client { id } }").then(e=>{if(!e)return n.sendStatus(404);const t=e[0],o=F.get(t,"client.id");dr(o,r.clients),Sr(t.id,a,s,n)}).catch(e=>{ir(`Test Session lookup error - ${t} - ${e}`),n.sendStatus(404)})},Sr=async(e,t,s,n)=>{try{const a=(ur(s,"REPORTER")||"json").toLowerCase();if("json"===a){const{ts:s,output:r}=await hr(e,t,a);n.setHeader("Content-Type","application/json"),n.setHeader("Content-disposition",`attachment; filename="${U(s.name)}.json"`),n.status(200).send(r)}else if("csv"===a){const{ts:s,output:r}=await hr(e,t,a);n.setHeader("Content-Type","text/csv"),n.setHeader("Content-disposition",`attachment; filename="${U(s.name)}.csv"`),n.status(200).send(r)}}catch(t){ir(`Test Session lookup error - ${e} - ${t}`),n.sendStatus(404)}},hr=async(e,t,s)=>{const n=await ue.findSimplePerformanceTestSessionResults(t.db,e);if(!n)throw new Error(`Test Session ${e} not found`);if("json"===s)return n.results.map(e=>({execCount:e.execCount,execDurationMin:e.execDurationMin,execDurationMax:e.execDurationMax,execDurationSum:e.execDurationSum})),{ts:n,output:n};if("csv"===s){const e=[],t=["testSessionId","testSessionName","testResultId","testResultJobId","testResultStepIndex","testResultStepStartAt","testResultConvo","execResultCount","execResultDurationMin","execResultDurationMax","execResultDurationSum"];e.push(t);const s=(e,t)=>{ir(`result ${JSON.stringify(t)}`),t?(e.push(t.id),e.push(t.job.id),e.push(t.stepIndex),e.push(t.stepStartAt),e.push(t.convo),e.push(t.execCount),e.push(t.execDurationMin),e.push(t.execDurationMax),e.push(t.execDurationSum)):e.push(null,null,null,null,null,null,null,null),ir(`result line ${JSON.stringify(e)}`)},a=[n.id,n.name];return n.results&&n.results.length>0?n.results.forEach(t=>{const n=a.slice(0);s(n,t),e.push(n)}):(s(a,null),e.push(a)),{ts:n,output:lr(e)}}};const{hasPermission:mr}=cn,fr={"/api/testset/":"TESTSETS_SELECT","/api/uploads/excel/":"TESTSETS_SELECT","/api/attachment/screenshot/":"TESTSESSIONS_SELECT","/api/triggerbuild/":"TESTSESSIONS_CREATE","/api/build/":"TESTSESSIONS_REPORTS","/api/performancebuild/":"PERFORMANCETESTSESSIONS_REPORTS","/api/log/":"TESTSESSIONS_REPORTS","/api/joblog/":"TESTSESSIONS_REPORTS","/api/transcript/":"TESTSESSIONS_REPORTS"},Tr=(e,t,s,n)=>{if(!t.apiKey&&!t.user)return s.sendStatus(401);for(const e in fr)if(t.baseUrl.startsWith(e)){if(t.user&&!mr(t.user,fr[e]))return s.sendStatus(401);if(t.apiKey&&!mr(t.apiKey,fr[e]))return s.sendStatus(401)}return n()};var yr=async(e,t)=>{await(async(e,t)=>{const s=t();(await s.db.query.chatbots({where:{}}," { id name capabilities { name type stringValue intValue booleanValue jsonValue } } ")).filter(e=>e.capabilities&&e.capabilities.filter(e=>"CONTAINERMODE"===e.name&&"fbpagereceiver"===e.stringValue).length>0).forEach(t=>{const n={app:e,endpoint:"/api/fbproxy/"+t.capabilities.find(e=>"FBPAGERECEIVER_ENDPOINT"===e.name).stringValue,verifytoken:t.capabilities.find(e=>"FBPAGERECEIVER_VERIFYTOKEN"===e.name).stringValue,accesstoken:t.capabilities.find(e=>"FBPAGERECEIVER_ACCESSTOKEN"===e.name).stringValue,redisurl:s.queueSettings.redis},a=t.capabilities.find(e=>"FBPAGERECEIVER_APPSECRET"===e.name);a&&a.stringValue?e.use(n.endpoint,P.json({verify:ja.bind(null,a.stringValue)})):e.use(n.endpoint,P.json()),ka(n),Ba(`Started FB Proxy for chatbot ${t.id}/${t.name}, endpoint: ${n.endpoint}`)})})(e,t);const s=1e3*(process.env.BOTIUMBOX_API_TIMEOUT||1800),n=[G(s),P.json({limit:"50mb",extended:!0}),Tr.bind(null,t)];((e,t,s)=>{e.get("/api/testset/:id",...t,async(e,t)=>{const n=e.params.id,a=s({request:e});try{const e=Ua(a),s=await Fa(a.db,n);if(s){const n=F.get(s,"client.id");La(n,e.clients);const a=new _;s.scripts&&s.scripts.forEach(e=>{"SCRIPTING_TYPE_CONVO"===e.scriptType&&a.addFile(`scripts/${e.name}.convo.txt`,Buffer.from(e.script)),"SCRIPTING_TYPE_PCONVO"===e.scriptType&&a.addFile(`scripts/${e.name}.pconvo.txt`,Buffer.from(e.script)),"SCRIPTING_TYPE_UTTERANCES"===e.scriptType&&a.addFile(`scripts/${e.name}.utterances.txt`,Buffer.from(e.script)),"SCRIPTING_TYPE_SCRIPTING_MEMORY"===e.scriptType&&a.addFile(`scripts/${e.name}.scriptingmemory.txt`,Buffer.from(e.script))});const r=a.toBuffer();t.writeHead(200,{"Content-disposition":`attachment; filename="${s.name}.zip"`,"Content-Length":r.length}),t.end(r)}else qa(`TestSet not found - ${n}`),t.sendStatus(404)}catch(e){qa(`TestSet lookup error - ${n} - ${e}`),t.sendStatus(404)}})})(e,n,t),((e,t,s)=>{e.get("/api/uploads/excel/:id",...t,async(e,t)=>{const n=e.params.id,a=s({request:e});try{const e=Ga(a),s=await ue.getExcel(a.db,n);if(s){const a=F.get(s,"testSet.client.id");Va(a,e.clients);let r=s.filecontent&&Buffer.from(s.filecontent,"base64");if(!r){const e=$.join(process.env.RESOURCESDIR,"uploads","excel",`${n}.xlsx`);D.existsSync(e)&&(r=D.readFileSync(e))}r&&r.length?(t.writeHead(200,{"Content-disposition":`attachment; filename="${s.filename}"`,"Content-Length":r.length}),t.end(r)):(Ja(`Excel file not found in database and in uploads - ${n}`),t.sendStatus(404))}else Ja(`Excel not found - ${n}`),t.sendStatus(404)}catch(e){Ja(`Excel lookup error - ${n} - ${e}`),t.sendStatus(404)}}),e.get("/api/attachment/screenshot/:id",...t,async(e,t)=>{const n=e.params.id,a=s({request:e});try{const e=Ga(a),s=await ue.getAttachment(a.db,n);if(s){const n=F.get(s,"testSessionTestCaseResult.testSession.client.id");Va(n,e.clients);const a=Buffer.from(s.base64,"base64");t.writeHead(200,{"Content-Disposition":`inline; filename="${s.name}"`,"Content-Type":s.mimeType,"Content-Length":a.length}),t.end(a)}else Ja(`Attachment not found - ${n}`),t.sendStatus(404)}catch(e){Ja(`Attachment lookup error - ${n} - ${e}`),t.sendStatus(404)}})})(e,n,t),or(e,n,t),((e,t,s)=>{e.get("/api/performancebuild/:nameOrId",...t,(e,t)=>{pr({nameOrId:e.params.nameOrId,ctxFactory:s,req:e,res:t})})})(e,n,t),((e,t,s)=>{e.get("/api/version",...t,(e,t)=>{t.status(200).send(K)})})(e,n),((e,t,s)=>{e.get("/api/chatbot/:chatBotCode/zap/scan",...t,async(e,t)=>{const n=e.params.chatBotCode,a=s(e),r=await a.db.query.chatbot({where:{code:n}},"{ id }").then(e=>{if(!e)throw new Error(`chatbot ${n} not found`);return e}).catch(e=>e),o=e.header("url"),i=await le.basicScan(o).then(e=>[{url:o,scanId:parseInt(e.scan),progress:0}]).then(e=>(delete e.id,e)),c=r.id;a.db.mutation.updateChatbot({where:{id:c},data:{zapScans:{create:i}}},"{ id zapScans { id url scanId  progress } }").then(e=>e.zapScans).then(e=>e[e.length-1]).then(e=>{t.status(200).send(e),le.polling(e,a)}).catch(e=>t.status(500).send(J.inspect(e)))}),e.get("/api/zap/:scanId/status",...t,(e,t)=>{const s=e.params.scanId;le.getStatus(s).then(e=>t.status(200).send(e)).catch(e=>t.status(500).send(J.inspect(e)))}),e.get("/api/zap/:scanId/results",...t,(e,t)=>{const s=e.params.scanId;le.getResults(s).then(e=>t.status(200).send(e)).catch(e=>t.status(500).send(J.inspect(e)))}),e.get("/api/zap/:scanId/fullResults",...t,(e,t)=>{const s=e.params.scanId;le.getFullResults(s).then(e=>t.status(200).send(e)).catch(e=>t.status(500).send(J.inspect(e)))})})(e,n,t)};V.config(),Q();const{GraphQLServer:gr}=O,{RedisPubSub:br}=H,{Prisma:Er}=Y,{validateToken:wr}=Ks,{ExtractQueueSettings:Cr}=ae,vr=L("botium-box-server-index"),Ir=Number(process.env.REQUEST_SIZE_LIMIT)||1e7,Or=()=>new Er({typeDefs:process.env.PRISMA_SCHEMA||"src/generated/prisma.graphql",endpoint:process.env.PRISMA_ENDPOINT,debug:process.env.PRISMA_DEBUG,secret:process.env.PRISMA_SECRET}),Rr=(e,t)=>{e&&console.log(e),t&&console.log(t),process.exit(1)};let Nr=Cr();vr(`connecting to Botium queue '${JSON.stringify(Nr)}'`);const xr=m.createQueue(Object.assign({},Nr));xr.setMaxListeners(1e3),xr.watchStuckJobs(),xr.on("error",e=>{console.log(`ERROR on queue '${JSON.stringify(Nr)}':`,e)}),process.env.RESOURCESDIR=process.env.RESOURCESDIR||"./resources";try{o.sync(process.env.RESOURCESDIR),vr(`Using RESOURCESDIR ${process.env.RESOURCESDIR}`)}catch(e){Rr(`ERROR verifying RESOURCESDIR '${process.env.RESOURCESDIR}':`,e)}process.env.BOTIUM_TEMPDIR=process.env.BOTIUM_TEMPDIR||"./botiumwork";try{o.sync(process.env.BOTIUM_TEMPDIR),vr(`Using BOTIUM_TEMPDIR ${process.env.BOTIUM_TEMPDIR}`)}catch(e){Rr(`ERROR verifying BOTIUM_TEMPDIR '${process.env.BOTIUM_TEMPDIR}':`,e)}process.env.TESTSETDIR=process.env.TESTSETDIR||"./testsets";try{o.sync(process.env.TESTSETDIR),vr(`Using TESTSETDIR ${process.env.TESTSETDIR}`)}catch(e){Rr(`ERROR verifying TESTSETDIR '${process.env.TESTSETDIR}':`,e)}Xt(Or());const Pr=new br({connection:Nr.redis});Pr.ee&&Pr.ee.setMaxListeners&&Pr.ee.setMaxListeners(0);const Ar=new se(43200),_r=e=>({...e||{},db:Or(),queueConnector:xr,queueSettings:Nr,pubsub:Pr,chartsCache:Ar});vr(`Using Prisma Endpoint ${process.env.PRISMA_ENDPOINT}`);const $r=new gr({typeDefs:process.env.GRAPHQL_SCHEMA||"./src/schema.graphql",resolvers:ya,resolverValidationOptions:{requireResolversForResolveType:!1},schemaDirectives:Pa,context:_r,middlewares:[async(e,t,s,n,a)=>{try{const r=await e(t,s,n,a);return r instanceof Error&&vr(r),r}catch(e){throw vr(e),e}}]}),Dr={port:process.env.PORT||4e3,bodyParserOptions:{limit:Ir,type:"application/json"},uploads:{maxFieldSize:Ir,maxFileSize:Ir},endpoint:"/graphql",subscriptions:{path:"/subscriptions",onConnect:async(e,t,s)=>{if(e.Authorization){return{user:await wr(e.Authorization,Or())}}throw new Error("Missing auth token!")},onDisconnect:(e,t)=>{}},playground:"/playground"};(async()=>{const e=process.env.BOTIUMBOX_STATIC_PATH?$.resolve(process.env.BOTIUMBOX_STATIC_PATH):$.resolve($.join(__dirname,"../../botium-box-client/build")),t=1e3*(process.env.BOTIUMBOX_API_TIMEOUT||1800);await Fn.loadStrategy(_r),await Ma($r.express,0,_r),await yr($r.express,_r),$r.express.use(W()),$r.express.use("/",z.static(e)),(await $r.start(Dr,({port:s})=>{console.log(`Server started, listening on port ${s} for incoming requests, time out after ${t}ms, static files served from ${e}`)})).setTimeout(t,()=>{vr("WARNING: a socket timeout ocurred. You should increase the BOTIUMBOX_API_TIMEOUT environment variable.")})})(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();e.queueConnector.process("agent.heartbeat",1,(t,s)=>{As("agent.heartbeat: "+JSON.stringify(t.data)),(async(e,t,s)=>{try{const{count:n}=await e.db.mutation.updateManyAgents({data:{heartbeat:new Date(Date.now()).toISOString()},where:{name:t.data.name}});if(!(n>0)){const e=`Agent ${t.data.name} not configured`;return xs(e),s(e)}s()}catch(e){s(e)}})(e,t,s)}),e.queueConnector.process("agent.register",1,(t,s)=>{As("agent.register: "+JSON.stringify(t.data)),(async(e,t,s)=>{const n=process.env.BOTIUMBOX_AGENTREGISTRATION&&"AUTO"===process.env.BOTIUMBOX_AGENTREGISTRATION||!0;try{let a=await ue.findAgentFromJobData(e.db,t);if(!a){if(!n){const e=`Agent ${t.data.name} not configured`;return Ps(e),s(e)}Ps(`Agent ${t.data.name} not yet registered, automatically registering.`),a=await e.db.mutation.createAgent({data:{name:t.data.name}})}let r=await ue.findAgentFromName(e.db,"Default Agent");const o=ue.combineBotiumCapabilities(ue.composeBotiumCapabilities(r&&r.capabilities||[]),ue.composeBotiumCapabilities(a.capabilities)),i={debug:!!(a.debug||r&&r.debug),botium:{Capabilities:o}};Ps(`Agent ${t.data.name} registered, config: ${JSON.stringify(i)}`),s(null,i)}catch(e){Ps(`Agent ${t.data.name} registration failed: ${J.inspect(e)}`),s(e)}})(e,t,s)}),e.queueConnector.process("box.createprocessingjobs",1,(t,s)=>{As("box.createprocessingjobs: "+JSON.stringify(t.data)),js(e,t.data).then(()=>s()).catch(s)}),e.queueConnector.process("box.createperformanceprocessingjobs",1,(t,s)=>{As("box.createperformanceprocessingjobs: "+JSON.stringify(t.data)),_s(e,t.data).then(()=>s()).catch(s)}),e.queueConnector.on("error",e=>{As("ERROR connecting to queue:"),As(e)}),e.queueConnector.on("job failed attempt",(e,t)=>{m.Job.get(e,(s,n)=>{s||(n=n.toJSON(),As(`Job ${e}/${n.type} failed attempt, ${JSON.stringify(n.attempts)} - Err: ${t}`))})}).on("job failed",(e,t)=>{m.Job.get(e,(s,n)=>{s||(n=n.toJSON(),As(`Job ${e}/${n.type} failed finally, ${JSON.stringify(n.attempts)} - Err: ${t} - Job Data: ${JSON.stringify(n.data)}`))})}),e.queueConnector.process("process.progress",1,async(t,s)=>{try{await Ls(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.log",1,async(t,s)=>{try{await Us(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.success",1,async(t,s)=>{As("process.ready.success: "+JSON.stringify(t.data));try{await Bs(e,t.data),await Fs(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("process.ready.failed",1,async(t,s)=>{As("process.ready.failed: "+JSON.stringify(t.data));try{await qs(e,t.data),await Fs(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.started",1,async(t,s)=>{As("performanceprocess.started: "+JSON.stringify(t.data));try{await $s(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.progress",1,async(t,s)=>{As("performanceprocess.progress: "+JSON.stringify(t.data));try{await Ds(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.ready.success",1,async(t,s)=>{As("performanceprocess.ready.success: "+JSON.stringify(t.data));try{await ks(e,t.data),s()}catch(e){s(e)}}),e.queueConnector.process("performanceprocess.ready.failed",1,async(t,s)=>{As("performanceprocess.ready.failed "+JSON.stringify(t.data));try{await Ms(e,t.data),s()}catch(e){s(e)}})}}(_r).start(),new class{constructor(e){this.ctxFactory=e}start(){const e=this.ctxFactory();zs(e)}}(_r).start(),us.startListeners(_r()).catch(e=>Rr("Failed to start listeners:",e)),process.on("uncaughtException",e=>{console.log("UNCAUGHTEXCEPTION",e),console.log(e.stack)}),process.on("warning",e=>{vr("WARNING",e)});return{}});
