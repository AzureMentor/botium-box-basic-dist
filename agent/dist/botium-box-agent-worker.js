!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("util"),require("path"),require("fs"),require("slugify"),require("nodegit"),require("botium-core/src/scripting/Constants"),require("debug"),require("botium-core/src/Capabilities"),require("lodash"),require("intercept-stdout"),require("botium-core")):"function"==typeof define&&define.amd?define(["util","path","fs","slugify","nodegit","botium-core/src/scripting/Constants","debug","botium-core/src/Capabilities","lodash","intercept-stdout","botium-core"],t):e.main=t(e.util,e.path,e.fs,e.slugify,e.nodegit,e.Constants,e.debug,e.Capabilities,e.lodash,e.interceptStdout,e.botiumCore)}(this,function(e,t,o,s,r,n,a,c,i,l,u){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,a=a&&a.hasOwnProperty("default")?a.default:a,c=c&&c.hasOwnProperty("default")?c.default:c,i=i&&i.hasOwnProperty("default")?i.default:i,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u;const p=a("botium-retrieve-all-test-cases");var T={prepareConvos:(e,t,o)=>{const s=e.testSets.filter(e=>e.expandConvos).length>0,r=e.testSets.filter(e=>e.expandUtterancesToConvos).length>0,n=e.testSets.filter(e=>e.expandScriptingMemory).length>0;return r&&(o("expanding utterances to convos ..."),t.compiler.ExpandUtterancesToConvos()),n&&(o("expanding scripting memories to convos ..."),t.compiler.ExpandScriptingMemoryToConvos()),(s||r||n)&&(o("expanding convos ..."),t.compiler.ExpandConvos()),o(`found ${t.compiler.convos.length} convos ...`),t.compiler.convos},merge:(e,t,o)=>{const s={};e.botium&&e.botium.Capabilities&&Object.assign(s,e.botium.Capabilities),t.botium&&t.botium.Capabilities&&Object.assign(s,t.botium.Capabilities);const r={};e.botium&&e.botium.Sources&&Object.assign(r,e.botium.Sources),t.botium&&t.botium.Sources&&Object.assign(r,t.botium.Sources);const n=o?i.cloneDeep(process.env):{};return e.botium&&e.botium.Envs&&Object.assign(n,e.botium.Envs),t.botium&&t.botium.Envs&&Object.assign(n,t.botium.Envs),{caps:s,sources:r,envs:n}},MESSAGE_TYPE:{CANCEL:"CANCEL",STOP:"STOP",CREATE_JOB:"CREATE_JOB",CREATE_JOB_COMPLETE:"CREATE_JOB_COMPLETE",CREATE_JOB_FAILED:"CREATE_JOB_FAILED",RESULT:"RESULT",LOG:"LOG"}};const m=u.BotDriver,{prepareConvos:E,merge:h,MESSAGE_TYPE:d}=T,S=e=>{I(d.LOG,e)};let C=!1,g=!1,f=0,O={};process.on("message",({type:e,requestId:t})=>{switch(e){case d.CANCEL:C=!0;break;case d.STOP:g=!0;break;case d.CREATE_JOB_COMPLETE:O[t].resolve(),delete O[t];break;case d.CREATE_JOB_FAILED:O[t].reject(),delete O[t];break;default:S(`Unknown message type: ${e}`),process.exit(1)}});const b=(e,t)=>{const o={requestId:++f};O[f]=o;const s=new Promise((s,r)=>{I(d.CREATE_JOB,{type:e,data:t},o.requestId),o.resolve=s,o.reject=r});return o.promise=s,s},I=(e,t,o)=>{process.send({type:e,message:t,requestId:o})},_=t=>t?t.message?t.message:e.inspect(t):null,R=e=>{if(e&&"BotiumError"===e.name){if(e.context&&e.context.errors)return e.context.errors;if(e.context)return[e.context]}};let P,v,N;try{P=JSON.parse(process.argv[2])}catch(t){S(`Init: Failed to parse args: ${process.argv[2]} - ${e.inspect(t)}!`),process.exit(1)}try{v=o.readFileSync(t.join(...P))}catch(t){S(`Init: Error loading arg file ${P} - ${e.inspect(t)}!`),process.exit(1)}try{N=JSON.parse(v)}catch(t){S(`Init: Error parsing arg file ${P} - ${e.inspect(t)}!`),process.exit(1)}(({agentConfig:s,jobId:r,data:a})=>{const{testSessionId:i,testSessionName:u,testSessionJobId:T}=a,d={unhook:null},f=()=>{d.unhook&&(d.unhook(),d.unhook=null)};return new Promise((f,O)=>{d.unhook=l(e=>{if(s.debug){const t=e.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,"");b("process.log",{testSessionId:i,testSessionName:u,testSessionJobId:T,log:t})}return e}),S(`Started processing, JobId #${r}.`);const{caps:I,sources:P,envs:v}=h(s,a,!1),N=new m(I,P,v),A=N.BuildFluent();A.compiler=N.BuildCompiler(),N._validate().then(()=>new Promise((s,r)=>{Promise.all(a.testSets.map(s=>((s,r,a)=>{const{excelHasConvos:i,excelHasPartialConvos:l,excelHasUtterances:u,excelWorksheetsConvos:T,excelWorksheetsPartialConvos:m,excelWorksheetsUtterances:E,excelStartRow:h,excelStartCol:d}=s;i&&T&&(r.caps[c.SCRIPTING_XLSX_SHEETNAMES]=T),l&&m&&(r.caps[c.SCRIPTING_XLSX_SHEETNAMES_PCONVOS]=m),u&&E&&(r.caps[c.SCRIPTING_XLSX_SHEETNAMES_UTTERANCES]=E),isNaN(h)||(r.caps[c.SCRIPTING_XLSX_STARTROW]=h),isNaN(d)||(r.caps[c.SCRIPTING_XLSX_STARTCOL]=d),s.convos&&s.convos.forEach(t=>{let o=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(o=r.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_CONVO)),o&&o.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw p(t),new Error(`${s.name}: Convo Script compilation failed: ${e.inspect(t)}`)}}),s.pconvos&&s.pconvos.forEach(t=>{let o=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(o=r.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_PCONVO)),o&&o.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw p(t),new Error(`${s.name}: Partial Convo Script compilation failed: ${e.inspect(t)}`)}}),s.utterances&&s.utterances.forEach(t=>{let o=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(o=r.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_UTTERANCES)),o&&o.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw p(t),new Error(`${s.name}: Utterance script compilation failed: ${e.inspect(t)}`)}}),s.scriptingMemories&&s.scriptingMemories.forEach(t=>{let o=[];try{t.format===n.SCRIPTING_FORMAT_TXT&&(o=r.Compile(t.content,n.SCRIPTING_FORMAT_TXT,n.SCRIPTING_TYPE_SCRIPTING_MEMORY)),o&&o.forEach(e=>{e.sourceTag=t.sourceTag})}catch(t){throw p(t),new Error(`${s.name}: Scripting Memory script compilation failed: ${e.inspect(t)}`)}}),s.folders&&s.folders.forEach(t=>{try{const{convos:o,pconvos:n,utterances:a}=r.ReadScriptsFromDirectory(t.path,t.globFilter);o&&o.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)}),n&&n.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)}),a&&a.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,t.sourceTag)})}catch(o){throw p(o),new Error(`${s.name}: Folder ${t} script compilation failed: ${e.inspect(o)}`)}});let S=Promise.resolve();s.excels&&s.excels.length>0&&(S=Promise.all(s.excels.map(({id:e,filename:s,filecontent:a,sourceTag:c})=>new Promise((p,T)=>{let m=a&&Buffer.from(a,"base64");if(!m){const s=t.join(process.env.RESOURCESDIR,"uploads","excel",`${e}.xlsx`);o.existsSync(s)&&(m=o.readFileSync(s))}if(!m||!m.length)return T(new Error(`Excel file not found in database and in uploads - ${s}`));let E=[],h=[],d=[];i&&(E=r.Compile(m,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_CONVO)),l&&(h=r.Compile(m,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_PCONVO)),u&&(d=r.Compile(m,n.SCRIPTING_FORMAT_XSLX,n.SCRIPTING_TYPE_UTTERANCES)),E&&E.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),h&&h.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),d&&d.forEach(e=>{e.sourceTag=Object.assign({},e.sourceTag,c)}),p()}))));let C=Promise.resolve();return Promise.all([C,S])})(s,A.compiler,N.tempDirectory))).then(()=>E(a,A,S)).then(e=>{s(e.reduce((e,t)=>e.concat(t),[]))}).catch(r)})).then(()=>{const e=a.batchNum||1,t=a.batchCount||1,o=Math.ceil(A.compiler.convos.length/t),s=o*(e-1),r=Math.min(s+o,A.compiler.convos.length)-1,n=r-s+1,c={batchNum:e,totalCount:0,failedCount:0,successCount:0};S(`batchNum: ${e} batchCount: ${t} convosPerBatch: ${o} batchStart: ${s} batchEnd: ${r} batchLength: ${n}`);for(let t=s;t<=r;t++){const l=t,p=A.compiler.convos[l];let m=null;const E=[],h=(e,t)=>{t.attachments&&E.push(...t.attachments)},d=(e,t)=>{t.attachments&&E.push(...t.attachments)},f=(e,t)=>{E.push(t)},O=(e,t)=>{t&&(p.sourceTag=Object.assign({},p.sourceTag,t))},I=()=>{N.eventEmitter.removeListener("MESSAGE_SENTTOBOT",h),N.eventEmitter.removeListener("MESSAGE_RECEIVEDFROMBOT",d),N.eventEmitter.removeListener("MESSAGE_ATTACHMENT",f),N.eventEmitter.removeListener("CONTAINER_STARTED",O)},P=()=>{N.on("MESSAGE_SENTTOBOT",h),N.on("MESSAGE_RECEIVEDFROMBOT",d),N.on("MESSAGE_ATTACHMENT",f),N.on("CONTAINER_STARTED",O)};let v=null;A.Call(()=>{if(C)throw new Error("Test Session cancelled")}),A.Call(P).Start(),A.Call(()=>new Promise(e=>{if(C)S(`Test Session cancelled, skipping Convo "${p.header.name}", Index ${l}, ${l-s} from ${o}`),e();else if(g)S(`Test Session stopped, skipping Convo "${p.header.name}", Index ${l}, ${l-s} from ${o}`),e();else{S(`Running Convo "${p.header.name}", Index ${l}, ${l-s+1} from ${n}`);try{return p.Run(A.container).then(t=>{S(`Running Convo "${p.header.name}" completed successfully.`),m=t,e()}).catch(t=>{S(`Running Convo "${p.header.name}" failed: ${t}.`),m=t.transcript,v=t.cause||t,e()})}catch(t){v=t,e()}}})),A.Stop().Call(I),A.Call(()=>{if(C)throw new Error("Test Session cancelled")}),A.Call(()=>new Promise((t,h)=>C?t():g?t():(m&&(m.errDetails=R(m.err),m.err=_(m.err),m.steps&&m.steps.forEach(e=>{e.errDetails=R(e.err),e.err=_(e.err)})),c.totalCount++,v?c.failedCount++:c.successCount++,null!==v&&a.bail&&(g=!0),void b("process.progress",{testSessionId:i,testSessionName:u,testSessionJobId:T,currentBatchIndex:l,batchNum:e,batchStart:s,batchEnd:r,batchLength:n,convosPerBatch:o,progress:Math.round((l-s+1)/n*100),testcase:p.header.name,source:p.toString(),sourceTag:p.sourceTag,transcript:m,attachments:E,success:null===v,err:_(v),errDetails:R(v),stopTestSession:null!==v&&a.bail}).then(e=>{t(e)}).catch(e=>{h(e)}))))}A.Clean(),A.Exec().then(()=>f(c)).catch(e=>{A.container?(S(`Test Session Run failed (${e}), doing additional BotDriver Clean.`),A.container.Clean().catch(e=>S(e)).then(()=>{e.result=c,O(e)})):(S(`Test Session Run failed (${e}).`),O(e))})}).catch(O)}).then(e=>(f(),e)).catch(e=>{throw f(),e})})(N).then(e=>(I(d.RESULT,e),Promise.all(Object.values(O).map(e=>e.promise)).then(()=>process.exit(0)))).catch(()=>Promise.all(Object.values(O).map(e=>e.promise)).then(()=>process.exit(1)));return{}});
